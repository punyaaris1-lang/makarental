<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Finance - MAKA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Syne:wght@700&display=swap" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* CSS ADMIN FINANCE (SAMA SEPERTI SEBELUMNYA) */
:root { --bg-base:#f0f4f8; --accent:#0ea5a6; --text:#0f1724; --success:#10b981; --glass-bg:rgba(255,255,255,0.9); --radius-lg:20px; }
body{margin:0;padding:20px;font-family:'Inter';background:var(--bg-base);color:var(--text);min-height:100vh;}
.container{max-width:750px;margin:0 auto;padding-bottom:50px;}
.glass-card{background:var(--glass-bg);border:1px solid #fff;border-radius:var(--radius-lg);padding:24px;margin-bottom:20px;box-shadow:0 8px 32px rgba(0,0,0,0.05);}
h2{font-family:'Syne';display:flex;justify-content:space-between;border-bottom:1px solid #ccc;padding-bottom:10px;margin-bottom:20px;}
.form-row{display:flex;gap:15px;margin-bottom:15px;} .form-col{flex:1;}
label{display:block;font-size:0.7em;font-weight:700;margin-bottom:6px;color:#64748b;text-transform:uppercase;}
input{width:100%;padding:12px;border-radius:10px;border:1px solid #cbd5e1;}
button{width:100%;padding:12px;background:var(--text);color:white;border:none;border-radius:10px;font-weight:700;cursor:pointer;}
table{width:100%;border-collapse:collapse;font-size:0.9em;} th,td{padding:10px;text-align:left;border-bottom:1px solid #eee;}
.status-unpaid{color:red;background:#fee2e2;padding:4px 8px;border-radius:6px;font-size:0.8em;font-weight:bold;}
.status-paid{color:green;background:#d1fae5;padding:4px 8px;border-radius:6px;font-size:0.8em;font-weight:bold;}
.btn-lunas{padding:6px 12px;background:var(--success);font-size:0.8em;width:auto;}
</style>
</head>
<body>

<div class="container">
    <h2><span>ðŸ’° Admin Finance</span> <a href="admin_login.html" style="font-size:0.6em;color:red;text-decoration:none;">LOGOUT</a></h2>

    <div class="glass-card">
        <h3 style="margin-top:0;">Daftar Tagihan (Invoice)</h3>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>User</th>
                        <th>Jumlah</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="invoiceList">
                    <tr><td colspan="5" style="text-align:center;">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="glass-card">
        <h3>Buat Tagihan Baru</h3>
        <div class="form-row">
            <div class="form-col"><label>Cari Plat</label><input id="searchInp" placeholder="Ketik Plat..." onkeyup="searchUser()"></div>
            <div class="form-col"><label>Nama</label><input id="invName" readonly style="background:#eee;"></div>
        </div>
        <div id="searchResult" style="background:#fff;border:1px solid #eee;display:none;margin-bottom:15px;"></div>
        
        <div class="form-row">
            <div class="form-col"><label>Mulai</label><input type="date" id="startDate"></div>
            <div class="form-col"><label>Selesai</label><input type="date" id="endDate"></div>
        </div>
        <button onclick="sendInvoice()">KIRIM TAGIHAN</button>
    </div>
</div>

<script>
// --- PASTE CONFIG FIREBASE ANDA DI SINI ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let selectedUser = null;

// 1. LOAD INVOICES (MONITORING)
function loadInvoices() {
    db.collection('invoices').orderBy('createdAt', 'desc').onSnapshot(snap => {
        let html = '';
        snap.forEach(doc => {
            const d = doc.data();
            const date = new Date(d.createdAt.seconds * 1000).toLocaleDateString('id-ID');
            const statusBadge = d.status === 'paid' 
                ? `<span class="status-paid">LUNAS</span>` 
                : `<span class="status-unpaid">BELUM BAYAR</span>`;
            
            const actionBtn = d.status === 'unpaid'
                ? `<button class="btn-lunas" onclick="markPaid('${doc.id}')">LUNAS âœ…</button>`
                : `<span style="color:#aaa;">-</span>`;

            html += `
            <tr>
                <td>${date}</td>
                <td>${d.nama}<br><small>${d.plat}</small></td>
                <td>Rp ${parseInt(d.amount).toLocaleString('id-ID')}</td>
                <td>${statusBadge}</td>
                <td>${actionBtn}</td>
            </tr>`;
        });
        document.getElementById('invoiceList').innerHTML = html || '<tr><td colspan="5" align="center">Belum ada tagihan.</td></tr>';
    });
}

// 2. MARK AS PAID (AKSI ADMIN)
function markPaid(docId) {
    if(!confirm("Tandai tagihan ini sebagai LUNAS?")) return;
    db.collection('invoices').doc(docId).update({ status: 'paid' }).then(() => {
        alert("Status berhasil diperbarui!");
    });
}

// 3. SEARCH & SEND (SAMA SEPERTI SEBELUMNYA)
function searchUser() {
    const key = document.getElementById('searchInp').value.toUpperCase();
    if(key.length<2) { document.getElementById('searchResult').style.display='none'; return; }
    
    db.collection('users').get().then(snap => {
        let h=''; 
        snap.forEach(doc=>{ 
            const u=doc.data(); 
            if(u.plat.includes(key)||u.nama.toUpperCase().includes(key)) 
                h+=`<div style="padding:10px;cursor:pointer;border-bottom:1px solid #eee;" onclick='selUser(${JSON.stringify(u)})'>${u.plat} - ${u.nama}</div>`; 
        });
        const res = document.getElementById('searchResult');
        res.innerHTML=h; res.style.display='block';
    });
}
function selUser(u){ 
    selectedUser=u; 
    document.getElementById('searchInp').value=u.plat; 
    document.getElementById('invName').value=u.nama; 
    document.getElementById('searchResult').style.display='none'; 
}

function sendInvoice(){
    if(!selectedUser) return alert("Pilih user!");
    // Hitung sederhana untuk demo (logic 70rb/hari)
    const s=new Date(document.getElementById('startDate').value);
    const e=new Date(document.getElementById('endDate').value);
    const diff = Math.ceil((e-s)/(1000*60*60*24)) + 1;
    const amount = diff * 70000; // Dasar 70rb

    db.collection('invoices').add({
        plat: selectedUser.plat, nama: selectedUser.nama, amount: amount,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        status: 'unpaid', createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{ alert("Tagihan Terkirim!"); });
}

loadInvoices(); // Jalankan saat load
</script>
</body>
</html>
