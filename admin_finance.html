<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Finance - MAKA</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --bg: #05080A; --cyan: #00F0FF; --volt: #D9FF00; --red: #FF2A2A;
            --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1);
            --font-display: 'Space Grotesk', sans-serif;
        }
        body { margin: 0; padding: 20px; background: var(--bg); color: white; font-family: 'Inter'; padding-bottom: 100px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        h1 { font-family: var(--font-display); font-size: 24px; color: var(--volt); }

        .sec-title { font-family: var(--font-display); font-size: 14px; color: var(--cyan); margin: 30px 0 15px; display: flex; justify-content: space-between; align-items: center; }
        .pill { background: var(--red); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; }

        /* Grid Verifikasi */
        .verify-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .v-card { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; padding: 15px; }
        .v-img { width: 100%; height: 120px; object-fit: cover; border-radius: 12px; cursor: pointer; background: #000; }
        .v-info { margin-top: 10px; font-size: 11px; }
        .btn-appr { width: 100%; padding: 10px; background: var(--volt); border: none; border-radius: 8px; font-weight: 800; font-size: 10px; margin-top: 10px; cursor: pointer; }

        /* Table Log */
        .log-box { background: var(--glass); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; }
        th { background: rgba(255,255,255,0.05); text-align: left; padding: 12px; color: #555; }
        td { padding: 12px; border-bottom: 1px solid var(--border); }

        .adm-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #000; border: 1px solid var(--border); padding: 8px; border-radius: 20px; display: flex; gap: 5px; z-index: 1000; }
        .adm-nav a { text-decoration: none; color: white; padding: 10px 20px; font-size: 11px; font-weight: 700; border-radius: 15px; }
        .adm-nav a.active { background: var(--cyan); color: #000; }
    </style>
</head>
<body>

<div class="container">
    <h1>FINANCE COMMAND<span>.</span></h1>

    <div class="sec-title">PERLU VERIFIKASI <span class="pill" id="count">0</span></div>
    <div class="verify-grid" id="vList">
        </div>

    <div class="sec-title">LOG TRANSAKSI TERAKHIR</div>
    <div class="log-box">
        <table>
            <thead><tr><th>TANGGAL</th><th>PLAT</th><th>METODE</th><th>AKSI</th></tr></thead>
            <tbody id="txList"></tbody>
        </table>
    </div>
</div>

<div class="adm-nav">
    <a href="admin_user.html">OPERATIONAL</a>
    <a href="admin_finance.html" class="active">FINANCE</a>
</div>

<script>
    const cfg = { apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0", authDomain: "rtomaka-e67b5.firebaseapp.com", projectId: "rtomaka-e67b5", storageBucket: "rtomaka-e67b5.firebasestorage.app", messagingSenderId: "472036722228", appId: "1:472036722228:web:11d520f9204db317d02c61" };
    firebase.initializeApp(cfg); const db = firebase.firestore();

    function loadVerify() {
        db.collection('payment_proofs').where('status','==','PENDING').onSnapshot(snap => {
            const list = document.getElementById('vList');
            document.getElementById('count').innerText = snap.size;
            list.innerHTML = snap.empty ? '<div style="color:#444; font-size:12px;">Tidak ada bukti bayar masuk.</div>' : '';
            
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                    <div class="v-card">
                        <img src="${d.img}" class="v-img" onclick="window.open(this.src)">
                        <div class="v-info">
                            <b>${d.plat}</b><br>
                            Sewa: ${d.date}
                        </div>
                        <button class="btn-appr" onclick="approve('${doc.id}', '${d.plat}', '${d.date}', '${d.nama}')">APPROVE</button>
                    </div>`;
            });
        });
    }

    function approve(id, plat, tgl, nama) {
        if(!confirm("Setujui pembayaran " + plat + " untuk tanggal " + tgl + "?")) return;
        
        const batch = db.batch();
        const payRef = db.collection('daily_payments').doc(plat+'_'+tgl);
        const proofRef = db.collection('payment_proofs').doc(id);

        batch.set(payRef, { plat, nama, date: tgl, amount: 70000, paidAt: new Date(), type: 'TRANSFER_VERIFIED' });
        batch.update(proofRef, { status: 'APPROVED' });

        batch.commit().then(() => alert("Berhasil diverifikasi!"));
    }

    function loadTx() {
        db.collection('daily_payments').orderBy('paidAt','desc').limit(15).onSnapshot(snap => {
            const list = document.getElementById('txList');
            list.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `<tr>
                    <td>${d.date}</td>
                    <td><b>${d.plat}</b></td>
                    <td>${d.type || 'N/A'}</td>
                    <td><button style="background:none; border:none; color:var(--red); font-size:10px;" onclick="hapusTx('${doc.id}')">Hapus</button></td>
                </tr>`;
            });
        });
    }

    function hapusTx(id) { if(confirm("Batalkan pelunasan ini?")) db.collection('daily_payments').doc(id).delete(); }

    loadVerify(); loadTx();
</script>
</body>
</html>
