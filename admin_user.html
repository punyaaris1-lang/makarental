<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Admin Ops - MAKA Online</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* GLOBAL THEME */
:root { --bg-base:#f0f4f8; --accent:#0ea5a6; --text:#0f1724; --danger:#ef4444; --glass-bg:rgba(255,255,255,0.85); --glass-border:rgba(255,255,255,0.6); --radius-lg:20px; }
body { margin:0; padding:20px; font-family:'Inter'; background:var(--bg-base); color:var(--text); min-height:100vh; }
body::before { content:""; position:fixed; inset:0; background:url('1763947427555.jpg') center/cover; opacity:0.15; z-index:-1; pointer-events:none; }
.container { max-width:650px; margin:0 auto; padding-bottom:50px; }

h2 { font-family:'Syne'; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; }

/* TABS */
.tabs { display:flex; gap:10px; margin-bottom:20px; overflow-x:auto; padding-bottom:5px; }
.tab-btn { padding:10px 20px; border-radius:12px; border:none; background:rgba(255,255,255,0.6); font-weight:700; cursor:pointer; white-space:nowrap; transition:0.2s; }
.tab-btn.active { background:var(--text); color:#fff; box-shadow:0 5px 15px rgba(0,0,0,0.2); }

/* CARDS & INPUTS */
.section { display:none; } .section.active { display:block; }
.glass-card { background:var(--glass-bg); backdrop-filter:blur(12px); border:1px solid var(--glass-border); border-radius:var(--radius-lg); padding:24px; margin-bottom:20px; box-shadow:0 8px 32px rgba(0,0,0,0.05); }
input, textarea, select { width:100%; padding:12px; border-radius:12px; border:1px solid #cbd5e1; margin-bottom:15px; font-family:'Inter'; background:rgba(255,255,255,0.9); }
label { display:block; font-size:0.8em; font-weight:700; margin-bottom:6px; color:#64748b; text-transform:uppercase; }

/* BUTTONS */
button { width:100%; padding:14px; background:var(--accent); color:white; border:none; border-radius:12px; font-weight:700; cursor:pointer; margin-bottom:10px; }
.btn-excel { background:#10b981; margin-bottom:20px; box-shadow:0 5px 15px rgba(16,185,129,0.3); }
.btn-small { width:auto; padding:8px 16px; font-size:0.8em; margin:0; }
.danger { background:var(--danger); }

/* USER LIST */
.user-item { display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid rgba(0,0,0,0.05); background:rgba(255,255,255,0.5); margin-bottom:8px; border-radius:12px; }
.u-info h4 { margin:0; font-size:1em; font-weight:700; }
.u-info p { margin:4px 0 0; font-size:0.8em; color:#666; }
</style>
</head>
<body>

<div class="container">
    <h2>
        <span>üõ†Ô∏è Admin Ops</span>
        <a href="admin_login.html" style="color:var(--danger); text-decoration:none; font-size:0.7em;">LOGOUT</a>
    </h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="sw(1)">üë• User Base</button>
        <button class="tab-btn" onclick="sw(2)">üîß Master Part</button>
        <button class="tab-btn" onclick="sw(3)">üì¢ Broadcast</button>
    </div>

    <div id="sec-1" class="section active">
        <div class="glass-card">
            <h3>Database User</h3>
            
            <button onclick="exportToExcel()" class="btn-excel">üì• DOWNLOAD DATA (EXCEL)</button>
            
            <input type="text" id="searchUser" placeholder="Cari Plat Nomor..." onkeyup="loadUsers()">
            <div id="userListContainer">
                <p style="text-align:center; color:#999;">Memuat data...</p>
            </div>
        </div>
    </div>

    <div id="sec-2" class="section">
        <div class="glass-card">
            <h3>Tambah Part Baru</h3>
            <label>Nama Part</label><input id="partName" placeholder="Contoh: Oli Mesin">
            <label>Limit Gratis (Qty per 3 Tahun)</label><input id="partLimit" type="number" placeholder="Contoh: 12">
            <button onclick="addPartMaster()">SIMPAN KE SERVER</button>
        </div>
        <div class="glass-card">
            <h3>Daftar Part Aktif</h3>
            <div id="partListContainer">Loading...</div>
        </div>
    </div>

    <div id="sec-3" class="section">
        <div class="glass-card" style="border:1px solid #fcd34d; background:rgba(255,251,235,0.9);">
            <h3>üîî Kirim Notifikasi HP</h3>
            <label>Judul Notifikasi</label><input id="notifTitle" placeholder="INFO PENTING!">
            <label>Pesan Singkat</label><input id="notifBody" placeholder="Isi pesan...">
            <button onclick="sendBroadcast()" style="background:#d97706;">KIRIM NOTIFIKASI üöÄ</button>
        </div>
        
        <div class="glass-card">
            <h3>Posting Artikel (Info/Tips)</h3>
            <label>Kategori</label>
            <select id="postType">
                <option value="info">üì∞ Info MLU</option>
                <option value="tips">üí° Tips User</option>
            </select>
            <label>Judul</label><input id="postTitle">
            <label>Isi Konten</label><textarea id="postContent" rows="4"></textarea>
            <label>Link Foto (Opsional)</label><input id="postImg">
            <button onclick="publishContent()">PUBLISH SEKARANG</button>
        </div>
    </div>
</div>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- TABS ---
function sw(id){
    document.querySelectorAll('.section').forEach(d=>d.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('sec-'+id).classList.add('active');
    event.target.classList.add('active');
}

// === 1. USER MANAGEMENT & EXCEL ===
let allUsersCache = []; // Simpan data di sini untuk export

function loadUsers() {
    const search = document.getElementById('searchUser').value.toUpperCase();
    const container = document.getElementById('userListContainer');
    
    db.collection('users').get().then(snap => {
        allUsersCache = []; // Reset cache
        let html = '';
        
        snap.forEach(doc => {
            const u = doc.data();
            allUsersCache.push(u); // Masukkan ke cache untuk excel
            
            if(u.plat.includes(search) || u.nama.toUpperCase().includes(search)) {
                const isBanned = u.isBanned === true;
                const btnAction = isBanned 
                    ? `<button class="btn-small" style="background:#10b981;" onclick="toggleBan('${u.plat}', false)">UN-BAN ‚úÖ</button>`
                    : `<button class="btn-small danger" onclick="toggleBan('${u.plat}', true)">BAN üö´</button>`;
                
                html += `
                <div class="user-item">
                    <div class="u-info">
                        <h4>${u.nama} (${u.plat}) ${isBanned?'<span style="color:red">[BLOKIR]</span>':''}</h4>
                        <p>${u.hp} ‚Ä¢ Join: ${formatDate(u.joinedAt)}</p>
                    </div>
                    <div>${btnAction}</div>
                </div>`;
            }
        });
        container.innerHTML = html || '<p style="text-align:center">Tidak ada user ditemukan.</p>';
    });
}

function formatDate(isoStr) {
    if(!isoStr) return "-";
    const d = new Date(isoStr);
    return d.toLocaleDateString('id-ID');
}

function toggleBan(plat, status) {
    if(!confirm(status ? "Blokir user ini?" : "Buka blokir user ini?")) return;
    db.collection('users').doc(plat).update({ isBanned: status }).then(() => { loadUsers(); });
}

// --- FUNGSI EXPORT EXCEL ---
function exportToExcel() {
    if(allUsersCache.length === 0) return alert("Belum ada data user!");
    
    // 1. Format Data agar rapi di Excel
    const dataToExport = allUsersCache.map(u => ({
        "Nama Lengkap": u.nama,
        "Plat Nomor": u.plat,
        "No. WhatsApp": u.hp,
        "Tgl. Gabung": formatDate(u.joinedAt),
        "Tgl. Ambil Motor": u.tglAmbil || "-",
        "Opsi DP": u.dp || "-",
        "Status Blokir": u.isBanned ? "YA" : "TIDAK"
    }));

    // 2. Buat Worksheet
    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Data Member");

    // 3. Download File
    XLSX.writeFile(workbook, "Data_Member_MAKA.xlsx");
}

// === 2. PART MASTER ===
function addPartMaster() {
    const name = document.getElementById('partName').value;
    const limit = parseInt(document.getElementById('partLimit').value);
    if(!name || !limit) return alert("Isi data!");
    const key = name.toLowerCase().replace(/\s+/g, '_');
    db.collection('settings').doc('parts').set({ [key]: { name: name, limit: limit } }, { merge: true }).then(() => {
        alert("Part berhasil ditambahkan!"); loadParts();
    });
}
function loadParts() {
    db.collection('settings').doc('parts').onSnapshot(doc => {
        if(doc.exists) {
            const data = doc.data();
            let html = '';
            for(const key in data) { html += `<div class="user-item"><div class="u-info"><h4>${data[key].name}</h4></div><strong>Limit: ${data[key].limit}x</strong></div>`; }
            document.getElementById('partListContainer').innerHTML = html;
        }
    });
}

// === 3. BROADCAST & KONTEN ===
function sendBroadcast() {
    const title = document.getElementById('notifTitle').value;
    const body = document.getElementById('notifBody').value;
    if(!title || !body) return alert("Isi lengkap!");
    if(!confirm("Kirim notifikasi ke SEMUA user?")) return;

    db.collection('broadcasts').add({
        title: title, body: body, timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => alert("Notifikasi terkirim!"));
}

function publishContent() {
    const type = document.getElementById('postType').value;
    const title = document.getElementById('postTitle').value;
    const content = document.getElementById('postContent').value;
    const img = document.getElementById('postImg').value;
    if(!title || !content) return alert("Isi lengkap!");
    
    const collection = type === 'info' ? 'info_mlu' : 'tips_maka';
    const date = new Date().toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric'});
    
    db.collection(collection).add({
        title: title, content: content, photos: img ? [img] : [], date: date, timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => alert("Artikel Terbit!"));
}

loadUsers(); loadParts();
</script>
</body>
</html>
