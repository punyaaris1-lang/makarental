<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAKA ‚Ä¢ MONOLITH V2</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --neon: #D9FF00; --dark: #050505; --err: #FF003C; --cyan: #00F0FF; }
        body { margin: 0; padding: 0; background: var(--dark); color: white; font-family: 'Space Grotesk', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; position: relative; }

        /* GLOW & HEADER */
        .glow-bg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; background: #333; opacity: 0.15; filter: blur(120px); border-radius: 50%; z-index: 0; transition: 1s; }
        .top-bar { display: flex; justify-content: space-between; padding: 30px; z-index: 10; align-items: center; }
        .slot-pill { display: flex; gap: 8px; align-items: center; background: rgba(255,255,255,0.05); padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #333; transition: 0.3s; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .dot.charging { background: var(--neon); box-shadow: 0 0 10px var(--neon); transform: scale(1.2); }
        .slot-label { font-size: 9px; font-weight: 700; color: #888; letter-spacing: 2px; margin-left: 5px; }

        /* MONOLITH */
        .monolith { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; text-align: center; position: relative; }
        .mono-label { font-family: 'Syncopate', sans-serif; font-size: 10px; letter-spacing: 4px; color: #555; margin-bottom: 20px; text-transform: uppercase; transition: 0.3s; }
        .mono-num { font-size: 120px; line-height: 0.8; font-weight: 700; color: white; text-shadow: 0 0 50px rgba(255,255,255,0.05); position: relative; transition: 0.5s; }
        .mono-num span { font-size: 30px; vertical-align: super; color: #666; opacity: 0; transition: 0.3s; }
        .mono-num.charging span { opacity: 1; color: var(--neon); }
        .sub-stat { margin-top: 25px; font-size: 11px; color: var(--cyan); letter-spacing: 1px; background: rgba(0, 240, 255, 0.1); padding: 8px 20px; border-radius: 30px; opacity: 0; transform: translateY(10px); transition: 0.5s; }
        .sub-stat.show { opacity: 1; transform: translateY(0); }

        /* BOTTOM CONTROLS */
        .control-deck { padding: 0 30px 40px; z-index: 10; display: flex; flex-direction: column; gap: 15px; }
        .system-info { text-align: center; font-size: 9px; color: #444; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 10px; }
        .system-info b { color: #888; }
        .hold-btn { position: relative; width: 80px; height: 80px; margin: 0 auto; border-radius: 50%; border: 1px solid #333; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; overflow: hidden; -webkit-tap-highlight-color: transparent; }
        .hold-btn::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: var(--neon); opacity: 0; transform: scale(0); transition: 0.2s; }
        .hold-btn:active::before { opacity: 0.2; transform: scale(1); }
        .hold-btn.locked { border-color: #222; cursor: not-allowed; opacity: 0.4; }
        .hold-btn.unlocked { border-color: var(--neon); box-shadow: 0 0 25px rgba(217, 255, 0, 0.15); }
        .finger-icon { font-size: 30px; z-index: 2; color: #444; transition: 0.3s; }
        .hold-btn.unlocked .finger-icon { color: var(--neon); }
        .btn-text { text-align: center; font-size: 10px; color: #555; letter-spacing: 2px; font-weight: 700; margin-top: 10px; }

        /* NAV FLOAT */
        .nav-float { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px); border-radius: 30px; padding: 12px 30px; display: flex; justify-content: space-between; border: 1px solid rgba(255,255,255,0.08); margin-top: 10px; }
        .nav-icon { text-decoration: none; font-size: 24px; filter: grayscale(1); opacity: 0.5; transition: 0.3s; }
        .nav-icon.active { filter: grayscale(0); opacity: 1; transform: scale(1.1); text-shadow: 0 0 15px var(--neon); }
        
        #scanner { position: fixed; inset: 0; background: #000; z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .scan-beam { width: 100%; height: 2px; background: var(--neon); box-shadow: 0 0 20px var(--neon); animation: beam 1s infinite; }
        @keyframes beam { 0% {transform: translateY(-50vh);} 100% {transform: translateY(50vh);} }
    </style>
</head>
<body>

    <div class="glow-bg" id="bgGlow"></div>

    <div class="top-bar">
        <div class="slot-pill">
            <div class="dot" id="dot1"></div>
            <div class="dot" id="dot2"></div>
            <div class="dot" id="dot3"></div>
            <span class="slot-label">SLOTS</span>
        </div>
        <div style="font-size:18px; color:#333; cursor:pointer;" onclick="location.reload()">‚Üª</div>
    </div>

    <div class="monolith">
        <div class="mono-label" id="statusLabel">CHECKING DATA...</div>
        <div class="mono-num" id="mainDisplay">--<span>%</span></div>
        <div class="sub-stat" id="subInfo">DATA FETCHING</div>
    </div>

    <div class="control-deck">
        <div class="system-info">
            TOTAL ANTRIAN: <b id="totalQ">--</b> | EST: <b id="estTime">--</b>
        </div>

        <div id="btnWrapper">
            <button id="btnHold" class="hold-btn locked" onclick="processQueue()">
                <div class="finger-icon">‚èª</div>
            </button>
            <div class="btn-text" id="gpsText">WAITING GPS...</div>
        </div>

        <div class="nav-float">
            <a href="dashboard.html" class="nav-icon">üè†</a>
            <a href="calendar.html" class="nav-icon">üìÖ</a>
            <a href="antrian.html" class="nav-icon active">‚ö°</a>
            <a href="history.html" class="nav-icon">üìú</a>
        </div>
    </div>

    <div id="scanner">
        <div style="color:var(--neon); font-family:'Syncopate'; font-size:14px; letter-spacing:3px;">CONNECTING</div>
        <div class="scan-beam"></div>
    </div>

    <script>
        // --- 1. CONFIG FIREBASE ---
        const firebaseConfig = { 
            apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", 
            authDomain: "sistem-antrian-b1c39.firebaseapp.com", 
            projectId: "sistem-antrian-b1c39", 
            storageBucket: "sistem-antrian-b1c39.firebasestorage.app", 
            messagingSenderId: "454124587608", 
            appId: "1:454124587608:web:34fbb0f5211067a67f982d" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const STATION_LOC = { lat: -6.171583, lng: 106.899844 }; 
        const MAX_DIST_KM = 0.2; 
        let isGpsReady = false;

        // --- 2. CEK & PERBAIKI DATA USER (AUTO-REPAIR) ---
        let currentUser = null;
        try { currentUser = JSON.parse(localStorage.getItem('maka_user')); } catch (e) {}

        // JIKA DATA RUSAK/KOSONG, MINTA INPUT MANUAL
        if (!currentUser || !currentUser.plat) {
            let fixedPlat = prompt("‚ö†Ô∏è PERBAIKAN DATA ‚ö†Ô∏è\n\nSistem mendeteksi data login Anda tidak lengkap (Undefined).\n\nSilahkan masukkan NOMOR PLAT Anda sekarang (Contoh: B 1234 XYZ) agar sistem bisa berjalan:");
            
            if (fixedPlat) {
                // Simpan struktur yang benar ke memori HP
                currentUser = {
                    plat: fixedPlat.toUpperCase().trim(),
                    nama: "Driver " + fixedPlat.toUpperCase().trim(),
                    status: "active"
                };
                localStorage.setItem('maka_user', JSON.stringify(currentUser));
                alert("‚úÖ Data berhasil diperbaiki! Aplikasi siap digunakan.");
            } else {
                alert("‚ùå Anda harus memasukkan Plat Nomor untuk menggunakan fitur antrian.");
                document.getElementById('statusLabel').innerText = "DATA ERROR";
            }
        }

        // --- 3. GPS LOGIC ---
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((pos) => {
                const dist = getDist(pos.coords.latitude, pos.coords.longitude, STATION_LOC.lat, STATION_LOC.lng);
                const btn = document.getElementById('btnHold');
                const txt = document.getElementById('gpsText');

                if (dist <= MAX_DIST_KM) {
                    isGpsReady = true;
                    btn.className = "hold-btn unlocked";
                    txt.innerText = "TAP TO QUEUE";
                    txt.style.color = "var(--neon)";
                } else {
                    isGpsReady = false;
                    btn.className = "hold-btn locked";
                    txt.innerText = "TOO FAR (" + (dist * 1000).toFixed(0) + "m)";
                    txt.style.color = "#555";
                }
            }, (err) => {
                document.getElementById('gpsText').innerText = "GPS BLOCKED";
            }, { enableHighAccuracy: true });
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- 4. REAL-TIME LISTENER ---
        db.collection("antrian").doc("utama").onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                const queueList = data.list || data.antrian || []; 
                
                let myData = null;
                let totalWaiting = 0;
                let activeChargers = 0;

                queueList.forEach(item => {
                    const st = (item.status || "").toLowerCase();
                    if (st.includes('charg') || st.includes('isi') || st.includes('penuh')) {
                        activeChargers++;
                    } else {
                        totalWaiting++;
                    }
                    // Cocokkan dengan data user yang sudah diperbaiki
                    if (currentUser && item.plat === currentUser.plat) {
                        myData = item;
                    }
                });
                updateUI(myData, totalWaiting, activeChargers);
            } else {
                document.getElementById('statusLabel').innerText = "DB OFFLINE";
            }
        });

        function updateUI(myData, totalWaiting, activeChargers) {
            const display = document.getElementById('mainDisplay');
            const label = document.getElementById('statusLabel');
            const sub = document.getElementById('subInfo');
            const bg = document.getElementById('bgGlow');
            
            document.getElementById('totalQ').innerText = totalWaiting;
            document.getElementById('estTime').innerText = (totalWaiting * 30) + " MIN";

            for(let i=1; i<=3; i++) {
                let d = document.getElementById('dot'+i);
                d.className = (i <= activeChargers) ? "dot charging" : "dot";
            }

            if (myData) {
                const st = (myData.status || "").toLowerCase();
                if (st.includes('charg') || st.includes('isi') || st.includes('penuh')) {
                    let bat = myData.baterai || 0; 
                    display.innerHTML = bat + "<span>%</span>";
                    display.className = "mono-num charging";
                    display.style.color = "var(--neon)";
                    label.innerText = "CHARGING...";
                    label.style.color = "var(--neon)";
                    sub.innerText = "FULL IN: " + (myData.estimasi || "CALC..");
                    sub.className = "sub-stat show";
                    bg.style.background = "var(--neon)";
                } else {
                    display.innerHTML = myData.no || myData.nomor || "#";
                    display.className = "mono-num";
                    display.style.color = "var(--cyan)";
                    label.innerText = "ANTRIAN ANDA";
                    label.style.color = "var(--cyan)";
                    sub.innerText = "MOHON MENUNGGU";
                    sub.className = "sub-stat show";
                    bg.style.background = "var(--cyan)";
                }
            } else {
                display.innerHTML = "--";
                display.className = "mono-num";
                display.style.color = "white";
                label.innerText = "SILAHKAN DAFTAR";
                label.style.color = "#555";
                sub.className = "sub-stat";
                bg.style.background = "#222";
            }
        }

        // --- 5. FUNGSI DAFTAR ---
        function processQueue() {
            if (!isGpsReady) return; 
            
            // Cek ulang data sebelum kirim
            if (!currentUser || !currentUser.plat) {
                alert("Data pengguna korup. Silakan refresh halaman untuk perbaikan otomatis.");
                location.reload();
                return;
            }

            const sc = document.getElementById('scanner');
            sc.style.display = 'flex'; 

            const docRef = db.collection("antrian").doc("utama");

            db.runTransaction((transaction) => {
                return transaction.get(docRef).then((sfDoc) => {
                    if (!sfDoc.exists) { throw "DB Error!"; }
                    const data = sfDoc.data();
                    const list = data.list || data.antrian || [];

                    const exists = list.find(x => x.plat === currentUser.plat);
                    if (exists) throw "Anda sudah terdaftar!";

                    let maxNo = 0;
                    list.forEach(item => { if(item.no > maxNo) maxNo = item.no; });
                    const nextNo = maxNo + 1;

                    // Pastikan kirim plat yang sudah diperbaiki
                    const newItem = {
                        plat: currentUser.plat,
                        no: nextNo,
                        status: 'waiting',
                        waktu: new Date().toLocaleTimeString('id-ID'),
                        baterai: 0
                    };

                    transaction.update(docRef, {
                        list: firebase.firestore.FieldValue.arrayUnion(newItem)
                    });
                    return nextNo;
                });
            }).then((newNo) => {
                setTimeout(() => { sc.style.display = 'none'; }, 500);
            }).catch((err) => {
                sc.style.display = 'none';
                if(err !== "Anda sudah terdaftar!") alert("Gagal: " + err);
            });
        }
    </script>
</body>
</html>
