<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAKA ‚Ä¢ MONOLITH LIVE</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Space+Grotesk:wght@300;700&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #D9FF00; --dark: #050505; --err: #FF003C; --cyan: #00F0FF; --glass: rgba(255, 255, 255, 0.05); }
        body { margin: 0; padding: 0; background: var(--dark); color: white; font-family: 'Space Grotesk', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; position: relative; }

        /* AMBIENT GLOW */
        .glow-bg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; height: 300px; background: #333; opacity: 0.15; filter: blur(120px); border-radius: 50%; z-index: 0; transition: 1s; }

        /* HEADER */
        .top-bar { display: flex; justify-content: space-between; padding: 25px; z-index: 10; align-items: flex-start; }
        .slot-pill { display: flex; flex-direction: column; gap: 5px; }
        .slot-dots { display: flex; gap: 6px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #222; transition: 0.3s; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .dot.charging { background: var(--neon); box-shadow: 0 0 10px var(--neon); }
        .slot-label { font-size: 9px; font-weight: 700; color: #555; letter-spacing: 2px; }

        .global-q { text-align: right; }
        .gq-val { font-family: 'Syncopate'; font-size: 18px; color: white; font-weight: 700; }
        .gq-lbl { font-size: 8px; color: #666; letter-spacing: 1px; }

        /* CENTER MONOLITH */
        .monolith { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; text-align: center; position: relative; }
        .mono-label { font-family: 'Syncopate', sans-serif; font-size: 11px; letter-spacing: 3px; color: #888; margin-bottom: 10px; text-transform: uppercase; transition: 0.3s; }
        
        .mono-num { font-size: 130px; line-height: 0.8; font-weight: 700; color: white; text-shadow: 0 0 50px rgba(255,255,255,0.05); position: relative; transition: 0.5s; }
        .mono-num span { font-size: 30px; vertical-align: super; color: #666; opacity: 0; transition: 0.3s; }
        .mono-num.charging span { opacity: 1; color: var(--neon); }
        
        .sub-stat { margin-top: 20px; font-size: 12px; color: var(--cyan); letter-spacing: 1px; background: rgba(0, 240, 255, 0.1); padding: 5px 15px; border-radius: 20px; opacity: 0; transform: translateY(10px); transition: 0.5s; }
        .sub-stat.show { opacity: 1; transform: translateY(0); }

        /* BOTTOM DECK */
        .control-deck { padding: 0 30px 40px; z-index: 10; display: flex; flex-direction: column; gap: 20px; }
        
        .hold-btn { position: relative; width: 80px; height: 80px; margin: 0 auto; border-radius: 50%; border: 1px solid #333; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; overflow: hidden; }
        .hold-btn::before { content: ''; position: absolute; inset: 0; border-radius: 50%; background: var(--neon); opacity: 0; transform: scale(0); transition: 0.2s; }
        .hold-btn:active::before { opacity: 0.2; transform: scale(1); }
        .hold-btn.locked { border-color: #222; cursor: not-allowed; opacity: 0.4; }
        .hold-btn.unlocked { border-color: var(--neon); box-shadow: 0 0 25px rgba(217, 255, 0, 0.15); }
        .finger-icon { font-size: 30px; z-index: 2; color: #444; transition: 0.3s; }
        .hold-btn.unlocked .finger-icon { color: var(--neon); }

        .btn-text { text-align: center; font-size: 10px; color: #555; letter-spacing: 2px; font-weight: 700; margin-top: 10px; }

        /* NAV FLOAT */
        .nav-float { background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(20px); border-radius: 30px; padding: 12px 30px; display: flex; justify-content: space-between; border: 1px solid rgba(255,255,255,0.08); }
        .nav-icon { text-decoration: none; font-size: 24px; filter: grayscale(1); opacity: 0.5; transition: 0.3s; }
        .nav-icon.active { filter: grayscale(0); opacity: 1; transform: scale(1.1); text-shadow: 0 0 15px var(--neon); }
        
        /* SCAN OVERLAY */
        #scanner { position: fixed; inset: 0; background: #000; z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .scan-beam { width: 100%; height: 2px; background: var(--neon); box-shadow: 0 0 20px var(--neon); animation: beam 1s infinite; }
        @keyframes beam { 0% {transform: translateY(-50vh);} 100% {transform: translateY(50vh);} }
    </style>
</head>
<body>

    <div class="glow-bg" id="bgGlow"></div>

    <div class="top-bar">
        <div class="slot-pill">
            <div class="slot-dots" id="slotContainer">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <span class="slot-label">CHARGING SLOTS</span>
        </div>
        <div class="global-q">
            <div class="gq-val" id="totalQ">--</div>
            <div class="gq-lbl">ANTRIAN GLOBAL</div>
        </div>
    </div>

    <div class="monolith">
        <div class="mono-label" id="statusLabel">SYNCING...</div>
        <div class="mono-num" id="mainDisplay">--<span>%</span></div>
        <div class="sub-stat" id="subInfo">DATA FETCHING</div>
    </div>

    <div class="control-deck">
        <div id="btnWrapper">
            <button id="btnHold" class="hold-btn locked">
                <div class="finger-icon">‚èª</div>
            </button>
            <div class="btn-text" id="gpsText">GPS SEARCHING...</div>
        </div>

        <div class="nav-float">
            <a href="dashboard.html" class="nav-icon">üè†</a>
            <a href="calendar.html" class="nav-icon">üìÖ</a>
            <a href="antrian.html" class="nav-icon active">‚ö°</a>
            <a href="history.html" class="nav-icon">üìú</a>
        </div>
    </div>

    <div id="scanner">
        <div style="color:var(--neon); font-family:'Syncopate'; font-size:14px; letter-spacing:3px;">CONNECTING</div>
        <div class="scan-beam"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- KONFIGURASI SESUAI KODE YANG ANDA KIRIM ---
        const firebaseConfig = { apiKey: "AIzaSyALIlkIDALIk83K8s1htalvW6rmNNw02Go", authDomain: "sistem-antrian-b1c39.firebaseapp.com", projectId: "sistem-antrian-b1c39", storageBucket: "sistem-antrian-b1c39.firebasestorage.app", messagingSenderId: "454124587608", appId: "1:454124587608:web:34fbb0f5211067a67f982d" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // TARGET DOKUMEN SESUAI KODE ANDA
        const ref = doc(db, "antrian", "utama"); 
        
        // TARGET LOKASI SESUAI KODE ANDA
        const STATION_LOC = { lat: -6.171583, lng: 106.899844 }; 
        const MAX_DIST_KM = 0.2; // 200 meter
        
        const u = JSON.parse(localStorage.getItem('maka_user'));

        // --- LOGIKA JARAK ---
        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // --- UPDATE UI MONOLITH (TAMPILAN KEREN) ---
        function updateUI(myData, totalWaiting, activeChargers) {
            const display = document.getElementById('mainDisplay');
            const label = document.getElementById('statusLabel');
            const sub = document.getElementById('subInfo');
            const bg = document.getElementById('bgGlow');
            
            // 1. Update Global Queue
            document.getElementById('totalQ').innerText = totalWaiting;

            // 2. Update Dots
            const slotContainer = document.getElementById('slotContainer');
            slotContainer.innerHTML = '';
            for(let i=0; i<3; i++) {
                let dotClass = (i < activeChargers) ? "dot charging" : "dot";
                slotContainer.innerHTML += `<div class="${dotClass}"></div>`;
            }

            // 3. Monolith Context Switching
            if (myData) {
                // Jika Status CHARGING
                if (myData.status === 'charging' || myData.status === 'charge') {
                    // Gunakan data baterai jika ada, default 0
                    let bat = myData.baterai || 80; 
                    display.innerHTML = bat + "<span>%</span>";
                    display.classList.add('charging');
                    display.style.color = "var(--neon)";
                    label.innerText = "CHARGING...";
                    label.style.color = "var(--neon)";
                    sub.innerText = "ESTIMASI PENUH: 15 MIN";
                    sub.classList.add('show');
                    bg.style.background = "var(--neon)";

                } else {
                    // Jika Status WAITING
                    display.innerHTML = myData.no || myData.nomor;
                    display.classList.remove('charging');
                    display.style.color = "var(--cyan)";
                    label.innerText = "ANTRIAN ANDA";
                    label.style.color = "var(--cyan)";
                    sub.innerText = "MOHON MENUNGGU";
                    sub.classList.add('show');
                    bg.style.background = "var(--cyan)";
                }
            } else {
                // BELUM DAFTAR
                display.innerHTML = "--";
                display.classList.remove('charging');
                display.style.color = "white";
                label.innerText = "SILAHKAN DAFTAR";
                label.style.color = "#888";
                sub.classList.remove('show');
                bg.style.background = "#333";
            }
        }

        function init() {
            if(!u) { alert("Silahkan login dulu"); window.location.href='index.html'; return; }

            // --- REAL TIME LISTENER KE DATABASE ANDA ---
            onSnapshot(ref, (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    
                    // Asumsi struktur data Anda adalah array di dalam field 'list' atau 'antrian'
                    // Sesuaikan 'list' jika nama field array Anda berbeda (misal: 'queue')
                    const queueList = data.list || data.antrian || []; 
                    
                    let myData = null;
                    let totalWaiting = 0;
                    let activeChargers = 0;

                    queueList.forEach(item => {
                        // Hitung Slot Terpakai
                        if(item.status === 'charging' || item.status === 'charge') {
                            activeChargers++;
                        } else {
                            totalWaiting++;
                        }

                        // Cari data user sendiri
                        if(item.plat === u.plat) {
                            myData = item;
                        }
                    });

                    updateUI(myData, totalWaiting, activeChargers);
                }
            });

            // --- GPS LOGIC (KUNCI LOKASI) ---
            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const dist = getDist(pos.coords.latitude, pos.coords.longitude, STATION_LOC.lat, STATION_LOC.lng);
                    const btn = document.getElementById('btnHold');
                    const txt = document.getElementById('gpsText');

                    if(dist <= MAX_DIST_KM) { // 0.2 KM
                        btn.className = "hold-btn unlocked";
                        txt.innerText = "TAP TO QUEUE";
                        txt.style.color = "var(--neon)";
                        
                        // Attach Event Listener Manual agar scope module terbaca
                        btn.onclick = () => daftarAntrian(); 
                    } else {
                        btn.className = "hold-btn locked";
                        txt.innerText = "TOO FAR (" + (dist*1000).toFixed(0) + "m)";
                        txt.style.color = "#555";
                        btn.onclick = null;
                    }
                }, null, { enableHighAccuracy: true });
            } else {
                document.getElementById('gpsText').innerText = "GPS OFF";
            }
        }

        // --- FUNGSI DAFTAR (WRITE TO DB) ---
        async function daftarAntrian() {
            const sc = document.getElementById('scanner');
            sc.style.display = 'flex';
            
            try {
                // Ambil data dulu untuk tahu nomor terakhir
                const snap = await getDoc(ref);
                let currentList = [];
                if(snap.exists()) {
                    currentList = snap.data().list || snap.data().antrian || [];
                }
                
                // Cari nomor tertinggi di array untuk auto-increment
                let maxNo = 0;
                currentList.forEach(item => {
                    if(item.no > maxNo) maxNo = item.no;
                });
                let nextNo = maxNo + 1;

                // Push ke Array menggunakan arrayUnion
                await updateDoc(ref, {
                    // Sesuaikan 'list' dengan nama field array di database Anda
                    list: arrayUnion({
                        plat: u.plat,
                        no: nextNo,
                        status: 'waiting',
                        waktu: new Date().toLocaleTimeString('id-ID')
                    })
                });

                setTimeout(() => { sc.style.display = 'none'; }, 1000);
            } catch(e) {
                sc.style.display = 'none';
                console.error(e);
                alert("Gagal: " + e.message);
            }
        }

        init();
    </script>
</body>
</html>
