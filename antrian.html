<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Antrian - MAKA</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#05080A">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #05080A; --cyan: #00F0FF; --volt: #D9FF00; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.12); }
        body { margin: 0; padding: 25px; font-family: 'Inter', sans-serif; background: var(--bg); color: white; min-height: 100vh; display: flex; flex-direction: column; }
        
        .top-nav { display: flex; align-items: center; margin-bottom: 30px; }
        .back-link { color: var(--cyan); text-decoration: none; font-weight: 700; font-size: 13px; letter-spacing: 1px; }

        .header h1 { font-family: 'Space Grotesk'; font-size: 32px; margin: 10px 0 5px; }
        .header p { color: var(--cyan); font-size: 11px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }

        .status-box { background: var(--glass); border: 1px solid var(--border); border-radius: 30px; padding: 40px 20px; text-align: center; margin-top: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .q-number { font-family: 'Space Grotesk'; font-size: 82px; color: var(--volt); margin: 15px 0; text-shadow: 0 0 30px rgba(217,255,0,0.3); line-height: 1; }
        
        .gps-indicator { font-size: 10px; padding: 10px 20px; border-radius: 25px; display: inline-block; margin-bottom: 25px; font-weight: 800; letter-spacing: 1px; }
        .gps-in { background: rgba(0,255,100,0.1); color: #00FF64; border: 1px solid rgba(0,255,100,0.2); }
        .gps-out { background: rgba(255,0,0,0.1); color: #FF2A2A; border: 1px solid rgba(255,0,0,0.2); }

        .btn-daftar { width: 100%; padding: 22px; border-radius: 20px; border: none; font-weight: 800; font-size: 16px; font-family: 'Space Grotesk'; cursor: pointer; transition: 0.4s; margin-top: 30px; }
        .btn-active { background: var(--volt); color: #000; box-shadow: 0 15px 30px rgba(217,255,0,0.2); }
        .btn-dis { background: #111; color: #333; cursor: not-allowed; border: 1px solid var(--border); }

        .info-footer { margin-top: auto; padding: 20px 0; text-align: center; font-size: 11px; color: #444; line-height: 1.6; }
    </style>
</head>
<body>

    <div class="top-nav">
        <a href="dashboard.html" class="back-link">‚Üê KEMBALI KE DASHBOARD</a>
    </div>

    <div class="header">
        <h1>Antrian<span>.</span></h1>
        <p>Hub Kelapa Gading</p>
    </div>

    <div class="status-box">
        <div id="gpsStatus" class="gps-indicator gps-out">MENGECEK LOKASI GPS...</div>
        <div style="font-size: 12px; color: #666; font-weight: 700; letter-spacing: 1px;">SEDANG DILAYANI</div>
        <div class="q-number" id="currentQ">--</div>
        <p id="infoDist" style="font-size: 11px; color: #444; margin: 0;">Silahkan mendekat ke area Hub untuk mendaftar antrian secara otomatis.</p>
    </div>

    <button id="btnDaftar" class="btn-daftar btn-dis" disabled>AMBIL NOMOR ANTRIAN</button>

    <div class="info-footer">
        Sistem ini menggunakan sinkronisasi GPS riil.<br>
        Pastikan izin lokasi pada browser Anda aktif.
    </div>

    <script>
        // Gunakan Config Firebase Anda
        const firebaseConfig = { apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0", authDomain: "rtomaka-e67b5.firebaseapp.com", projectId: "rtomaka-e67b5", storageBucket: "rtomaka-e67b5.firebasestorage.app", messagingSenderId: "472036722228", appId: "1:472036722228:web:11d520f9204db317d02c61" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const HUB_GADING = { lat: -6.1625, lng: 106.9011 }; // Koordinat Riil Hub
        const u = JSON.parse(localStorage.getItem('maka_user'));

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const œÜ1 = lat1 * Math.PI/180;
            const œÜ2 = lat2 * Math.PI/180;
            const ŒîœÜ = (lat2-lat1) * Math.PI/180;
            const ŒîŒª = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function checkLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(pos => {
                    const dist = getDistance(pos.coords.latitude, pos.coords.longitude, HUB_GADING.lat, HUB_GADING.lng);
                    const btn = document.getElementById('btnDaftar');
                    const stat = document.getElementById('gpsStatus');

                    if (dist <= 100) {
                        stat.innerText = "üìç ANDA DI AREA HUB (VERIFIED)";
                        stat.className = "gps-indicator gps-in";
                        btn.disabled = false;
                        btn.className = "btn-daftar btn-active";
                        btn.innerText = "AMBIL NOMOR ANTRIAN";
                    } else {
                        stat.innerText = "DI LUAR RADIUS HUB (" + Math.round(dist) + "m)";
                        stat.className = "gps-indicator gps-out";
                        btn.disabled = true;
                        btn.className = "btn-daftar btn-dis";
                        btn.innerText = "MASUK KE AREA HUB";
                    }
                }, err => {
                    document.getElementById('gpsStatus').innerText = "IZIN GPS DITOLAK";
                }, { enableHighAccuracy: true });
            }
        }

        // Monitoring antrian live dari Firestore
        db.collection('antrian_status').doc('current').onSnapshot(doc => {
            if(doc.exists) document.getElementById('currentQ').innerText = doc.data().number;
        });

        document.getElementById('btnDaftar').onclick = function() {
            this.innerText = "MEMPROSES...";
            this.disabled = true;
            // Simulasi pendaftaran berhasil
            setTimeout(() => {
                alert("Berhasil! Nomor Anda sudah masuk ke sistem Hub.");
                this.innerText = "ANTRIAN BERHASIL DIAMBIL";
            }, 1500);
        };

        window.onload = checkLocation;
    </script>
</body>
</html>
