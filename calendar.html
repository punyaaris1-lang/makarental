<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kalender Pembayaran - MAKA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link rel="manifest" href="/makarental/manifest.json"> 
    
<style>
/* GLOBAL THEME */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --accent-2:#06b6d4; --text:#0f1724; 
    --danger:#ef4444; --success:#10b981; --warning:#fbbf24; --disabled:#cbd5e1;
    --radius-lg:24px;
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body { 
    margin:0; font-family:'Inter', sans-serif; 
    background:var(--bg-base); color:var(--text); 
    min-height:100vh; position:relative; padding-bottom:100px;
}

/* BACKGROUND */
body::before {
    content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: url('1763947427555.jpg') center/cover no-repeat; 
    opacity: 0.15; z-index: -1; pointer-events: none;
}

.app-container { max-width:520px; margin:0 auto; padding:20px 20px 100px; }

/* HEADER & NAVIGASI BULAN */
.header { 
    display: flex; justify-content: space-between; align-items: center; 
    margin-bottom: 20px; background: white; padding: 10px 20px; 
    border-radius: 99px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.month-title { font-family: 'Syne'; font-size: 1.1em; font-weight: 800; text-transform: uppercase; }
.btn-nav { 
    background: #f1f5f9; border: none; width: 36px; height: 36px; 
    border-radius: 50%; font-weight: bold; cursor: pointer; color: var(--text);
}

/* KALENDER GRID */
.calendar-grid { 
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; 
    margin-bottom: 25px; 
}
.day-name { 
    text-align: center; font-size: 0.75em; font-weight: 800; 
    color: var(--muted); margin-bottom: 10px; text-transform: uppercase;
}
.date-cell {
    aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
    border-radius: 14px; font-weight: 700; font-size: 0.9em;
    background: rgba(255,255,255,0.6); position: relative;
    transition: 0.2s; border: 1px solid transparent;
}

/* STATUS WARNA */
.date-cell.lunas { background: #dcfce7; color: var(--success); border-color: var(--success); }
.date-cell.tunggak { 
    background: #fee2e2; color: var(--danger); border-color: var(--danger); 
    box-shadow: 0 4px 10px rgba(239,68,68,0.2); cursor: pointer; animation: pulseRed 2s infinite;
}
.date-cell.disabled { background: #e2e8f0; color: #94a3b8; opacity: 0.5; pointer-events: none; }
.date-cell.future { background: rgba(255,255,255,0.4); color: #94a3b8; pointer-events: none; }
/* TANGGAL 31 (LIBUR) */
.date-cell.libur-ok { background: #f3f4f6; color: #94a3b8; border: 1px dashed #cbd5e1; cursor: default; }

@keyframes pulseRed { 0%{border-color:var(--danger);} 50%{border-color:transparent;} 100%{border-color:var(--danger);} }

.date-cell.dp { border-bottom: 3px solid #fbbf24; } 
.small-lbl { font-size: 0.5em; text-transform: uppercase; margin-top: -2px; font-weight: 800; }

/* HERO CARD */
.hero-card {
    background: linear-gradient(135deg, #ef4444, #b91c1c);
    color: white; padding: 24px; border-radius: 24px;
    box-shadow: 0 15px 40px rgba(239, 68, 68, 0.3);
    position: relative; overflow: hidden; text-align: center;
    transition: 0.3s;
}
.hero-card.aman {
    background: linear-gradient(135deg, var(--accent), var(--accent-2));
    box-shadow: 0 15px 40px rgba(14, 165, 166, 0.3);
}

.hero-label { font-size: 0.8em; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; opacity: 0.9; margin-bottom: 5px; }
.hero-amount { font-family: 'Inter'; font-size: 2.8em; font-weight: 900; margin: 0; line-height: 1; letter-spacing: -1px; }
.hero-desc { font-size: 0.9em; margin-top: 10px; font-weight: 600; opacity: 0.9; }

/* FOOTER NAV */
footer.bottom-nav {
    position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
    width: auto; min-width: 260px; 
    background: rgba(255, 255, 255, 0.95); 
    backdrop-filter: blur(20px);
    border-radius: 50px; padding: 10px 30px; 
    display: flex; justify-content: space-between; align-items: center; gap: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.5); z-index: 999;
}
.nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #94a3b8; font-size: 9px; font-weight: 700; transition: 0.2s; }
.nav-item span { font-size: 22px; margin-bottom: 2px; }
.nav-item.active { color: var(--accent); }

/* MODAL KUSTOM (Tambahan) */
.modal-overlay-kustom { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:9999; display:none; align-items:center; justify-content:center; opacity:0; transition:opacity 0.3s; }
.modal-overlay-kustom.show { display:flex; opacity:1; }
.modal-box-kustom { background:white; width:85%; max-width:320px; padding:25px; border-radius:24px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,0.3); transform:scale(0.9); transition:0.3s; }
.modal-overlay-kustom.show .modal-box-kustom { transform:scale(1); }
.modal-icon-kustom { font-size:40px; margin-bottom:15px; display:block; }
.btn-modal-kustom { width:100%; padding:12px; margin-top:10px; border-radius:12px; border:none; font-weight:bold; cursor:pointer; }
.modal-title-kustom { font-family:'Inter'; font-size:1.3em; font-weight:800; margin:0 0 10px; color:var(--text); }
.modal-desc-kustom { font-size:0.9em; color:#64748b; line-height:1.5; margin-bottom:20px; }
</style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <button class="btn-nav" onclick="changeMonth(-1)">‚Äπ</button>
        <div id="monthDisplay" class="month-title">...</div>
        <button class="btn-nav" onclick="changeMonth(1)">‚Ä∫</button>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>

    <div id="heroCard" class="hero-card">
        <div class="hero-label">TOTAL TUNGGAKAN (GLOBAL)</div>
        <div id="totalDebt" class="hero-amount">Rp 0</div>
        <div id="debtDesc" class="hero-desc">Data sedang dimuat...</div>
    </div>
    
    <div style="text-align:center;margin-top:20px;font-size:0.7em;color:#64748b;">
        üî¥ Belum (Klik Bayar) &nbsp; üü¢ Lunas &nbsp; ‚ö™ Libur (Tgl 31)
    </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<div id="customModalConfirm" class="modal-overlay-kustom">
    <div class="modal-box-kustom">
        <h3 id="mTitle">Bayar?</h3>
        <p id="mDesc" style="color:#666;font-size:0.9em;margin:10px 0;">Konfirmasi</p>
        <div id="mBtns"></div>
    </div>
</div>

<div id="customModalInfo" class="modal-overlay-kustom">
    <div class="modal-box-kustom">
        <span id="mIconInfo" class="modal-icon-kustom">üîî</span>
        <h3 id="mTitleInfo" class="modal-title-kustom">Info</h3>
        <p id="mDescInfo" class="modal-desc-kustom">Pesan...</p>
        <button class="btn-modal-kustom" onclick="closeModalInfo()">OK, SIAP</button>
    </div>
</div>

<script>
// PWA ANTI LOADING
if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'))}

// --- FUNGSI MODAL KUSTOM BARU ---
function showModalInfo(title, msg, icon="üîî") {
    document.getElementById('mTitleInfo').innerText = title;
    document.getElementById('mDescInfo').innerText = msg;
    document.getElementById('mIconInfo').innerText = icon === "‚úÖ" ? "‚úÖ" : (icon === "‚ùå" ? "‚ùå" : "üîî");
    document.getElementById('customModalInfo').classList.add('show');
}
function closeModalInfo() {
    document.getElementById('customModalInfo').classList.remove('show');
}
// --- END MODAL KUSTOM ---

// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = JSON.parse(localStorage.getItem('maka_user'));
let plusData = JSON.parse(localStorage.getItem('maka_plus_data')) || { active: false };
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let paidDates = []; 

document.addEventListener("DOMContentLoaded", () => {
    // Pengecekan Login
    if(!currentUser) { window.location.href='index.html'; return; }
    loadPayments();
});

function updateHeroCard(amount, count, error=false) {
    const card = document.getElementById('heroCard');
    const txtAmount = document.getElementById('totalDebt');
    const txtDesc = document.getElementById('debtDesc');

    if (error) {
        card.className = "hero-card"; // Merah Default
        txtAmount.innerText = "‚ö†Ô∏è ERROR";
        txtDesc.innerText = "Gagal memuat data. Cek koneksi internet Anda.";
        return;
    }

    if (amount > 0) {
        card.className = "hero-card"; // Merah Default
        txtAmount.innerText = "Rp " + amount.toLocaleString('id-ID');
        txtDesc.innerText = `Anda menunggak ${count} hari. Klik kalender untuk bayar.`;
    } else {
        card.className = "hero-card aman"; // Biru
        txtAmount.innerText = "Rp 0";
        txtDesc.innerText = "Tidak ada tunggakan. Akun Aman! üëç";
    }
}

function loadPayments() {
    // Tambahkan Error Handler pada onSnapshot
    db.collection('daily_payments')
      .where('plat', '==', currentUser.plat)
      .onSnapshot(snap => {
          paidDates = [];
          snap.forEach(doc => { paidDates.push(doc.data().date); });
          calculateTotalDebt();
          renderCalendar();
      }, error => {
          console.error("Firestore Error:", error);
          updateHeroCard(0, 0, true); // Tampilkan error di Hero Card
          renderCalendar();
      });
}

// 2. HITUNG HARGA DINAMIS (LOGIKA BARU)
function getDailyPrice(dateObj) {
    // A. Cek Tanggal 31 -> LIBUR (Rp 0)
    if (dateObj.getDate() === 31) return 0;

    // B. Cek Masa Kontrak (Maka+ hanya berlaku 1 tahun pertama)
    const joinDate = new Date(currentUser.joinedAt);
    const diffTime = Math.abs(dateObj - joinDate);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 

    let price = 70000; // Harga Dasar
    
    // Jika ikut MAKA+ dan masih dibawah 365 hari (1 Tahun)
    if (plusData.active && diffDays <= 365) {
        price += 10000; // Tambah 10rb
    }
    
    return price;
}

function calculateTotalDebt() {
    const joinDate = new Date(currentUser.joinedAt);
    const today = new Date();
    today.setHours(0,0,0,0);
    
    let totalHutang = 0;
    let daysLate = 0;
    let checkDate = new Date(joinDate);
    checkDate.setHours(0,0,0,0);
    
    while (checkDate <= today) {
        const dateStr = checkDate.toISOString().split('T')[0];
        const price = getDailyPrice(checkDate); // Pakai fungsi harga dinamis

        // Hanya hitung hutang jika harga > 0 (bukan tgl 31) dan belum dibayar
        if (price > 0 && !paidDates.includes(dateStr)) {
            totalHutang += price;
            daysLate++;
        }
        checkDate.setDate(checkDate.getDate() + 1);
    }

    updateHeroCard(totalHutang, daysLate);
}


// 3. RENDER KALENDER (Memastikan klik berfungsi)
function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '<div class="day-name">M</div><div class="day-name">S</div><div class="day-name">S</div><div class="day-name">R</div><div class="day-name">K</div><div class="day-name">J</div><div class="day-name">S</div>';
    
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const joinDate = new Date(currentUser.joinedAt);
    joinDate.setHours(0,0,0,0);
    const today = new Date();
    today.setHours(0,0,0,0);

    document.getElementById('monthDisplay').innerText = new Date(currentYear, currentMonth).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' }).toUpperCase();

    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="date-cell empty"></div>`;

    for(let d=1; d<=daysInMonth; d++) {
        let m = (currentMonth+1).toString().padStart(2,'0');
        let da = d.toString().padStart(2,'0');
        let dateKey = `${currentYear}-${m}-${da}`;
        let currentDate = new Date(dateKey);
        currentDate.setHours(0,0,0,0);
        
        let cls = ""; let lbl = ""; let click = "";
        
        // Cek Harga hari ini
        let price = getDailyPrice(currentDate);

        if (d === 31) {
            // TGL 31 SELALU LIBUR (Tidak bisa diklik, warna abu)
            cls = "libur-ok"; 
            lbl = `<div class="small-lbl">LIBUR</div>`;
        } 
        else if (currentDate < joinDate) {
            cls = "disabled";
        } 
        else if (currentDate > today) {
            cls = "future";
        } 
        else {
            // Masa Aktif
            if (paidDates.includes(dateKey)) {
                cls = "lunas"; 
            } else {
                cls = "tunggak"; // Merah
                // PERBAIKAN: Memastikan pointer-events di-override jika ada onclick
                click = `onclick="paySelf('${dateKey}', ${price})" style="cursor:pointer;"`; 
            }
        }

        // DP Marker (Bulan depannya join)
        let joinMonthIdx = joinDate.getFullYear()*12 + joinDate.getMonth();
        let currMonthIdx = currentYear*12 + currentMonth;
        if (currMonthIdx > joinMonthIdx && (d===14 || d===28)) { 
            cls += " dp"; 
            if(!lbl) lbl=`<div class="small-lbl">DP</div>`; 
        }
        
        if (dateKey === today.toISOString().split('T')[0]) cls += " today";

        grid.innerHTML += `<div class="date-cell ${cls}" ${click}>${d} ${lbl}</div>`;
    }
}

// 4. KLIK BAYAR (SELF SERVICE DGN HARGA DINAMIS)
function paySelf(dateStr, price) {
    const d = new Date(dateStr);
    const dateFmt = d.toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
    
    document.getElementById('customModalConfirm').classList.add('show');
    document.getElementById('mTitle').innerText = "Bayar Tanggal Ini?";
    document.getElementById('mDesc').innerHTML = `Tgl: <b>${dateFmt}</b><br>Nominal: <b>Rp ${price.toLocaleString('id-ID')}</b>`;
    document.getElementById('mBtns').innerHTML = `
        <button class="btn-modal-kustom" onclick="document.getElementById('customModalConfirm').classList.remove('show')" style="background:#eee;color:#555">Batal</button>
        <button class="btn-modal-kustom" style="background:#10b981;color:white" onclick="processPayment('${dateStr}', ${price})">Ya, Sudah Bayar</button>
    `;
}

function processPayment(dateStr, amount) {
    document.getElementById('customModalConfirm').classList.remove('show');
    const docId = currentUser.plat + "_" + dateStr;
    db.collection('daily_payments').doc(docId).set({
        plat: currentUser.plat,
        nama: currentUser.nama,
        date: dateStr,
        amount: amount,
        paidAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
        showModalInfo("Lunas!", "Pembayaran Berhasil Dicatat.", "‚úÖ");
    }).catch(error => {
        console.error("Payment Error:", error);
        showModalInfo("Gagal", "Gagal memproses pembayaran. Cek koneksi Anda.", "‚ùå");
    });
}

function changeMonth(n) {
    currentMonth += n;
    if(currentMonth > 11) { currentMonth=0; currentYear++; }
    else if(currentMonth < 0) { currentMonth=11; currentYear--; }
    renderCalendar();
}
</script>
</body>
</html>
