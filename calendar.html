<script>
/* ========= KONFIG ========= */
const TGL_AMBIL = new Date('2025-09-18')
TGL_AMBIL.setDate(TGL_AMBIL.getDate()+1) // H+1

const DP_MODE = '355'   // '355' atau '755'
const MAKA_PLUS = false

const HARIAN = 80000
const CICIL = 70000
const TOTAL_CICIL_DP = 6

let view = new Date()
let active = null

/* ========= RULE ENGINE ========= */
function getDayRule(date, dpLunas){
 const d = date.getDate()

 // 31 SELALU LIBUR
 if(d === 31) return 'LIBUR'

 // DP 755 → 14 & 28 LIBUR
 if(DP_MODE === '755' && (d === 14 || d === 28)) return 'LIBUR'

 // DP 355
 if(DP_MODE === '355'){
  if(!dpLunas && (d === 14 || d === 28)) return 'DP_ONLY'
  if(dpLunas && (d === 14 || d === 28)) return 'LIBUR'
 }

 return 'NORMAL'
}

/* ========= RENDER ========= */
function render(){
 const grid=document.getElementById('grid')
 grid.innerHTML=''
 let total=0

 const pay=JSON.parse(localStorage.getItem('maka_payments'))||{}
 const dpPaid=Object.values(pay).filter(v=>v==='DP').length
 const dpLunas=dpPaid>=TOTAL_CICIL_DP

 const y=view.getFullYear(), m=view.getMonth()
 const first=new Date(y,m,1).getDay()
 const days=new Date(y,m+1,0).getDate()
 const today=new Date(); today.setHours(0,0,0,0)

 for(let i=0;i<first;i++) grid.innerHTML+='<div></div>'

 for(let d=1; d<=days; d++){
  const date=new Date(y,m,d)
  const key=`${y}-${m+1}-${d}`

  if(date < TGL_AMBIL){ grid.innerHTML+='<div></div>'; continue }

  const rule=getDayRule(date, dpLunas)
  let price=0, type='', cls='box'

  if(rule === 'LIBUR'){
   cls+=' libur'
  }else if(rule === 'DP_ONLY'){
   price=CICIL
   type='Cicilan DP'
   cls+=' wajib'
  }else{
   price = MAKA_PLUS ? HARIAN : CICIL
   type = MAKA_PLUS ? 'Harian Motor' : 'Cicilan Motor'
   cls+=' wajib'
  }

  if(pay[key]) cls+=' paid'
  if(date>today) cls+=' future'
  if(!pay[key] && price>0) total+=price

  grid.innerHTML+=`
   <div class="${cls}"
    onclick="${(price>0 && !pay[key] && date<=today) ?
      `openPay('${key}','${type}',${price})` : ''}">
    ${d}
   </div>`
 }

 document.getElementById('total').textContent =
  'Rp '+total.toLocaleString('id-ID')
}

/* ========= POPUP ========= */
function openPay(k,t,p){
 active={k,t,p}
 document.getElementById('m-date').textContent=k
 document.getElementById('m-desc').textContent=
  `${t} · Rp ${p.toLocaleString('id-ID')}`
 document.getElementById('modal').classList.add('active')
}
function pay(){
 const pay=JSON.parse(localStorage.getItem('maka_payments'))||{}
 pay[active.k]=active.t.includes('DP')?'DP':'HARI'
 localStorage.setItem('maka_payments',JSON.stringify(pay))
 closeModal()
 render()
}
function closeModal(){
 document.getElementById('modal').classList.remove('active')
}
function nav(n){view.setMonth(view.getMonth()+n);render()}
render()
</script>
