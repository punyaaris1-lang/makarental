<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Antrian FC Public</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link rel="manifest" href="/makarental/manifest.json"> 
    
<style>
/* GLOBAL THEME */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --text:#0f1724; 
    --danger:#ef4444; --success:#10b981; --gold:#fbbf24; 
    --glass-bg:rgba(255,255,255,0.9); 
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { margin:0; padding:0; font-family:'Inter', sans-serif; background:var(--bg-base); color:var(--text); min-height:100vh; position:relative; overflow-x:hidden; }
body::before { content:""; position:fixed; top:0; left:0; right:0; bottom:0; background:url('1763947427555.jpg') center/cover no-repeat; opacity:0.15; z-index:-1; pointer-events:none; }
.app-container { max-width:520px; margin:0 auto; padding:20px 20px 100px; }

/* HEADER */
.header { margin-bottom:20px; display:flex; align-items:center; justify-content:space-between; }
.header h1 { font-family:'Inter'; font-size:1.4em; font-weight:800; margin:0; color:var(--text); line-height:1; }
.header p { color:#64748b; font-size:0.75em; margin:4px 0 0; font-weight:600; }
.live-badge { background:#64748b; color:white; font-weight:800; font-size:0.65em; padding:6px 12px; border-radius:20px; }
.live-badge.online { background:var(--success); box-shadow:0 0 10px var(--success); }
.live-badge.error { background:var(--danger); box-shadow:0 0 10px var(--danger); }

/* FORMULIR */
.reg-card { background:white; border-radius:20px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom: 25px; border:1px solid #e2e8f0; }
.form-input { width:100%; padding:14px; border:1px solid #cbd5e1; border-radius:12px; margin-bottom:12px; font-family:'Inter'; font-size:1em; background:#f8fafc; outline:none; color:var(--text); }
.form-input:focus { border-color:var(--accent); background:white; }

/* TOMBOL DAFTAR */
.btn-submit { 
    width:100%; padding:16px; 
    background: #0ea5a6 !important; color: #ffffff !important;
    border: none; border-radius:16px; font-weight:900; font-size:1em; 
    cursor:pointer; box-shadow:0 10px 20px rgba(14,165,166,0.3); 
    text-transform: uppercase; letter-spacing: 1px;
}
.btn-submit:disabled { background:#cbd5e1 !important; cursor:not-allowed; }

/* SLOT CHARGING (STRUKTUR ASLI) */
.section-head { font-family:'Inter'; font-size:0.85em; font-weight:800; color:#64748b; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; }
.slot-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:25px; }
.slot-card { background:rgba(255,255,255,0.8); border:1px solid rgba(255,255,255,0.6); border-radius:18px; padding:15px 5px; text-align:center; min-height:170px; position:relative; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
.slot-card.active { background:white; border:2px solid var(--accent); }
.slot-card.my-slot { border:2px solid var(--gold); } /* Tambahan style untuk slot sendiri */
.slot-label { font-size:0.65em; font-weight:800; color:#64748b; margin-bottom:8px; }
.bat-body { width:34px; height:60px; border:2px solid #cbd5e1; border-radius:8px; margin:0 auto 8px; position:relative; display:flex; align-items:flex-end; padding:2px; }
.bat-head { width:12px; height:3px; background:#cbd5e1; position:absolute; top:-5px; left:50%; transform:translateX(-50%); border-radius:2px 2px 0 0; }
.bat-liquid { width:100%; background:linear-gradient(to top, #0ea5a6, #06b6d4); border-radius:4px; transition:height 0.5s; }
.slot-user { font-weight:800; font-size:0.85em; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
.slot-timer { font-family:'Inter'; font-weight:900; font-size:0.9em; color:var(--danger); display:block; margin-top:2px; }
.slot-target { font-size:0.7em; font-weight:bold; color:var(--danger); display:block; }
.slot-status { font-size:0.6em; font-weight:800; padding:4px 6px; border-radius:6px; margin-top:4px; display:inline-block; }
.st-ready { background:#dcfce7; color:#166534; } 
.st-charging { background:#cffafe; color:#0e7490; } 
.st-waiting { background:#fef3c7; color:#854d0e; }

/* HERO FLASHING */
.flash-hero {
    background: linear-gradient(135deg, #1e293b, #0f1724);
    color: #fbbf24; border-radius: 16px; padding: 20px; margin-bottom: 25px;
    display: flex; justify-content: space-around; align-items: center;
    border: 2px solid #fbbf24; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    animation: flashBorder 2s infinite;
}
@keyframes flashBorder { 0%{border-color:#fbbf24;} 50%{border-color:#ef4444;} 100%{border-color:#fbbf24;} }
.fh-item { text-align: center; }
.fh-label { font-size: 0.75em; font-weight: 700; opacity: 0.8; color: white; letter-spacing: 1px; }
.fh-val { font-family: 'Inter'; font-size: 2em; font-weight: 900; line-height: 1; margin-top: 5px; }

/* QUEUE LIST (STRUKTUR ASLI) */
.queue-list { background:white; border-radius:20px; padding:5px; margin-bottom:24px; border:1px solid #e2e8f0; max-height:300px; overflow-y:auto; }
.q-item { 
    display:flex; justify-content:space-between; align-items:center; padding:15px; border-bottom:1px solid #f1f5f9; font-size:0.9em;
    flex-wrap: wrap; /* Izinkan wrap untuk tombol admin */
} 
.q-item:last-child { border-bottom:none; }
.q-plat { font-weight:800; color:var(--text); } .q-bat { color:#64748b; font-size:0.85em; font-weight:600; }

/* BUTTONS */
.ctrl-btn { width:95%; padding:8px 4px; font-size:0.65em; border-radius:8px; border:none; margin-top:8px; font-weight:900; cursor:pointer; color:white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.btn-green { background:#10b981; } .btn-red { background:#ef4444; }
.adm-mini { padding:6px 10px; font-size:0.7em; border-radius:6px; border:none; font-weight:bold; cursor:pointer; color:white; }
.q-actions { display:flex; gap:5px; margin-top: 5px; } 
/* Tambahan untuk admin slot */
.slot-admin-controls { margin-top: 8px; display: flex; gap: 5px; justify-content: center; }

/* ALARM SCREEN */
.alarm-overlay { position:fixed; inset:0; background:rgba(220,20,60,0.98); z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; color:white; animation:shake 0.5s infinite; }
@keyframes shake { 0%{transform:translate(1px,1px)} 50%{transform:translate(-1px,-1px)} 100%{transform:translate(1px,-1px)} }
.btn-stop { background:white; color:red; border:none; padding:20px 50px; border-radius:50px; font-weight:900; font-size:1.2em; cursor:pointer; box-shadow:0 0 30px rgba(255,255,255,0.8); margin-top:30px; }

/* MODAL OVERLAY */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:9999; display:none; align-items:center; justify-content:center; opacity:0; transition:opacity 0.3s; }
.modal-overlay.show { display:flex; opacity:1; }
.modal-box { background:white; padding:25px; border-radius:24px; width:85%; max-width:320px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); transform:scale(0.9); transition:0.3s; }
.modal-overlay.show .modal-box { transform:scale(1); }
.modal-icon { font-size:40px; margin-bottom:15px; display:block; }
.modal-title { font-family:'Inter'; font-size:1.3em; font-weight:800; margin:0 0 10px; color:var(--text); }
.modal-desc { font-size:0.9em; color:#64748b; line-height:1.5; margin-bottom:20px; }
.modal-btns { display:flex; gap:10px; justify-content:center; }
.btn-modal { flex:1; padding:12px; border-radius:12px; border:none; font-weight:700; cursor:pointer; font-size:0.9em; }
.btn-confirm { background:var(--text); color:white; }
.btn-cancel { background:#f1f5f9; color:#64748b; }

/* ADMIN TRIGGER */
.admin-trigger { text-align:center; margin-top:50px; padding: 20px; border-top: 1px dashed #ccc; }
.btn-admin-login { background: transparent; border: 2px solid #cbd5e1; color: #94a3b8; padding: 8px 20px; border-radius: 99px; font-size: 0.8em; font-weight: 700; cursor: pointer; }

/* NAV */
footer.bottom-nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:auto; min-width:280px; background:rgba(255,255,255,0.9); backdrop-filter:blur(20px); border-radius:999px; padding:12px 30px; display:flex; justify-content:space-between; align-items:center; gap:30px; box-shadow:0 10px 40px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.5); z-index:999; }
.nav-item { display:flex; flex-direction:column; align-items:center; text-decoration:none; color:#94a3b8; font-size:10px; font-weight:700; transition:0.2s; }
.nav-item span { font-size:20px; margin-bottom:2px; } .nav-item.active { color:var(--accent); }
</style>
</head>
<body>

<audio id="keepAliveAudio" loop src="1709483325170.mp3" preload="auto"></audio>
<audio id="alarmAudio" loop src="1709477026725.mp3" preload="auto"></audio>

<div id="alarmScreen" class="alarm-overlay">
    <div style="font-size:100px;">‚ö°</div>
    <h1 style="font-family:'Inter'; font-size:3em; margin:0; text-shadow:0 0 20px black;">SELESAI!</h1>
    <p style="font-size:1.5em; max-width:80%;">Baterai Penuh</p>
    <button class="btn-stop" onclick="stopAlarmAndClear()">SAYA SUDAH CABUT</button>
    <p style="color:white; margin-top:15px; font-size:0.8em; opacity:0.8;">Klik tombol di atas untuk stop alarm & kosongkan slot.</p>
</div>

<div class="app-container">
    <header class="header">
        <div class="header-text">
            <h1>FC Kelapa Gading</h1>
            <p>Real-time Queue System</p>
        </div>
        <div id="connStatus" class="live-badge">OFFLINE</div>
    </header>

    <div class="reg-card" id="reg-card">
        <h3 style="margin:0 0 16px 0;font-family:'Inter';font-weight:800;font-size:1.2em;">Ambil Antrian</h3>
        <input id="uPlat" class="form-input" placeholder="Plat Nomor" style="text-transform:uppercase;">
        <input id="uWa" type="number" class="form-input" placeholder="WhatsApp">
        <input id="uBat" type="number" class="form-input" placeholder="Sisa Baterai (%)">
        
        <button id="btnDaftar" class="btn-submit">DAFTAR & AKTIFKAN MONITORING</button>
        
        <p id="monitorStatus" style="text-align:center; font-size:0.75em; color:var(--success); font-weight:700; margin-top:15px; display:none; background:#ecfdf5; padding:10px; border-radius:10px; border:1px solid #10b981;">
            üîä <b>MONITORING AKTIF</b><br>Audio "Hujan Pelan" diputar agar browser tidak tidur.
        </p>
    </div>

    <div class="section-head">STATUS CHARGING</div>
    <div class="slot-grid" id="slots">
        <div class="slot-card"><div class="slot-status">Loading...</div></div>
        <div class="slot-card"><div class="slot-status">Loading...</div></div>
        <div class="slot-card"><div class="slot-status">Loading...</div></div>
    </div>

    <div class="flash-hero">
        <div class="fh-item">
            <div class="fh-label">TOTAL ANTRIAN</div>
            <div class="fh-val" id="qCountDisplay">0</div>
        </div>
        <div style="width:1px; height:40px; background:rgba(255,255,255,0.2);"></div>
        <div class="fh-item">
            <div class="fh-label">MAX CAS</div>
            <div class="fh-val" style="color:#fbbf24;" id="maxCasDisplay">100%</div>
        </div>
    </div>

    <div class="section-head">LIST ANTRIAN</div>
    <div class="queue-list" id="qListContainer">
        <div style="text-align:center;padding:20px;color:#999;font-size:0.8em;">Belum ada antrian.</div>
    </div>
    
    <div id="leaveQueueSection" style="text-align:center; margin-top:30px; display:none;">
        <button onclick="confirmEmptySlot(myActiveSlotIndex, true)" class="btn-submit btn-red" style="width:100%;">KELUAR DARI ANTRIAN/SLOT</button>
    </div>

    <div class="admin-trigger">
        <button onclick="openAdmin()" class="btn-admin-login">üîí Admin / Operator Login</button>
    </div>
    <div id="adminResetArea" style="display:none; text-align:center; margin-top:20px;">
        <button onclick="confirmResetAll()" style="background:#fee2e2; color:red; border:1px solid red; padding:10px; border-radius:10px; font-weight:bold; font-size:0.8em;">‚ö†Ô∏è RESET SEMUA DATA (SLOT & ANTRIAN)</button>
    </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item active"><span>üé´</span>Antrian</a>
</footer>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <span id="mIcon" class="modal-icon">üîî</span>
        <h3 id="mTitle" class="modal-title">Judul</h3>
        <p id="mDesc" class="modal-desc">Keterangan...</p>
        <div id="mBtns" class="modal-btns"></div>
    </div>
</div>

<div id="adminModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Operator Login</h3>
        <input type="password" id="adminPin" class="form-input" placeholder="PIN" style="text-align:center;">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('adminModal').classList.remove('show')" class="btn-modal btn-cancel">Batal</button>
            <button class="btn-modal btn-confirm" onclick="loginAdmin()">MASUK</button>
        </div>
    </div>
</div>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- VARIABLES ---
const SLOTS_COUNT = 3; 
const STATION_LOC = { lat: -6.171583, lng: 106.899844 }; 
const MAX_DIST = 0.2; // 200 meter dalam KM
let isAdmin = false;
let userLat=null;
let userLng=null;
let triggered = new Set();
let myActiveSlotIndex = -1; 
let myActiveQueueId = null; 
let chargingSlotsData = []; 

const refAntrian = db.collection("antrian").doc("utama");

const keepAliveAudio = document.getElementById('keepAliveAudio');
keepAliveAudio.volume = 0.01; 
const alarmAudio = document.getElementById('alarmAudio');
alarmAudio.volume = 1.0; 

// --- UTILITY GPS & JARAK ---
function getDist(lat1, lon1, lat2, lon2) {
    const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

// --- TIMER TICKER ---
setInterval(() => {
    chargingSlotsData.forEach((slot, i) => {
        if (slot && slot.startTime) {
            const start = new Date(slot.startTime).getTime();
            // Durasi 1 jam default (60 menit)
            const durationMs = 60 * 60 * 1000; 
            const end = start + durationMs; 
            const diff = end - Date.now();
            
            const timerEl = document.getElementById(`timer-${i}`);
            const myPlat = localStorage.getItem('myPlat') || "";

            if (diff <= 0) {
                if(timerEl) timerEl.innerText = "SELESAI!";
                if (!triggered.has(slot.plat) && myPlat === slot.plat) {
                    triggered.add(slot.plat);
                    myActiveSlotIndex = i; 
                    triggerFullAlert();
                }
            } else {
                const m = Math.floor(diff / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                if(timerEl) timerEl.innerText = `${m}m ${s}s`;
            }
        }
    });
}, 1000);

// --- FIREBASE LISTENER & RENDER ---
function initFirebase() {
    const currentUser = JSON.parse(localStorage.getItem('maka_user'));
    // PERBAIKAN: Jika user tidak login (seperti saat masuk dari dashboard), isi form plat otomatis
    if(currentUser && currentUser.plat) {
        document.getElementById('uPlat').value = currentUser.plat;
    }
    if(!currentUser || !currentUser.plat) { 
        // Jika tidak ada data sesi sama sekali, tetap biarkan di sini untuk daftar, tapi fitur user akan terbatas.
    }
    
    if(navigator.geolocation) navigator.geolocation.watchPosition(p=>{ userLat=p.coords.latitude; userLng=p.coords.longitude; }, e=>{}, {enableHighAccuracy:true});
    
    // Cek Admin dari local storage
    isAdmin = localStorage.getItem('maka_is_admin') === 'true';
    if(isAdmin) { 
        document.getElementById('adminResetArea').style.display = 'block';
    }

    refAntrian.onSnapshot(snap => {
        // PERBAIKAN: Set status koneksi LIVE
        document.getElementById('connStatus').innerText = "LIVE ‚óè";
        document.getElementById('connStatus').classList.add('online');
        document.getElementById('connStatus').classList.remove('error');

        const d = snap.data() || {};
        // Inisialisasi slot kosong jika data belum ada
        const s = d.chargingSlots && Array.isArray(d.chargingSlots) ? d.chargingSlots : Array(SLOTS_COUNT).fill(null);
        const q = d.waitingQueue || [];
        const myPlat = localStorage.getItem('myPlat') || (currentUser ? currentUser.plat : '');
        
        chargingSlotsData = s; 
        
        // Update user status
        myActiveSlotIndex = s.findIndex(slot => slot && slot.plat === myPlat);
        myActiveQueueId = q.find(item => item.plat === myPlat) ? q.find(item => item.plat === myPlat).id : null;


        // HERO COUNT & MAX CAS LOGIC
        document.getElementById('qCountDisplay').innerText = q.length;
        let limit = 100;
        if(q.length >= 3 && q.length <= 5) limit = 95;
        else if(q.length >= 6 && q.length <= 10) limit = 90;
        else if(q.length > 10) limit = 85;
        document.getElementById('maxCasDisplay').innerText = limit + "%";

        // RENDER UI
        renderSlots(s, myPlat);
        renderQueue(q, myPlat);
        updateFormVisibility(myPlat, s, q);

    }, error => {
        // Error Listener (Jika gagal konek)
        console.error("Firestore Listener Error:", error);
        document.getElementById('connStatus').innerText = "ERROR ‚ö†Ô∏è";
        document.getElementById('connStatus').classList.remove('online');
        document.getElementById('connStatus').classList.add('error');
    });
}

// --- RENDER FUNCTIONS (REVERTED LAYOUT) ---

function renderSlots(slots, myPlat) {
    const container = document.getElementById('slots');
    container.innerHTML = '';

    for (let i = 0; i < SLOTS_COUNT; i++) {
        const slot = slots[i];
        const isOccupied = slot && slot.plat;
        const isCharging = slot && slot.startTime;
        const isMySlot = isOccupied && slot.plat === myPlat;

        let statusText = 'KOSONG';
        let slotClass = '';
        let timerHtml = '';
        let controls = '';

        if (isOccupied) {
            slotClass = 'active';
            statusText = isCharging ? 'CHARGING' : 'STANDBY (Selesai/Belum Mulai)';
            
            if (isCharging) {
                 timerHtml = `<span id="timer-${i}" class="slot-timer">Menghitung...</span>`;
            } else {
                 timerHtml = `<span class="slot-status st-waiting">SIAP CAS/SELESAI</span>`;
            }
        } else {
            statusText = 'KOSONG';
            slotClass = '';
        }
        
        // User controls (di bawah timer/status)
        if (isMySlot && isOccupied) {
            controls = `<button class="ctrl-btn btn-red" onclick="confirmEmptySlot(${i}, true)">‚èπÔ∏è SAYA SUDAH CABUT</button>`;
        }
        
        // Admin controls (di bagian bawah slot)
        if (isAdmin) {
            let btnAdmin = '';
            if (isOccupied) {
                 btnAdmin = isCharging 
                    ? `<button class="adm-mini btn-red" onclick="adminStopCharging(${i})">STOP</button>`
                    : `<button class="adm-mini btn-green" onclick="adminStartCharging(${i})">START</button>`;
            }
            controls += `
                <div class="slot-admin-controls">
                    ${isOccupied ? btnAdmin : ''}
                    <button class="adm-mini btn-red" onclick="confirmEmptySlot(${i}, false)">KOSONGKAN</button>
                </div>`;
        }

        container.innerHTML += `
            <div class="slot-card ${slotClass} ${isMySlot ? 'my-slot' : ''}">
                <div class="slot-label">SLOT ${i + 1}</div>
                <div class="bat-body"><div class="bat-head"></div><div class="bat-liquid" style="height:${slot && slot.startBattery ? slot.startBattery : 0}%"></div></div>
                <div class="slot-user">${slot ? slot.plat : '-'}</div>
                ${timerHtml}
                <div class="slot-status ${isOccupied ? (isCharging ? 'st-charging' : 'st-waiting') : 'st-ready'}">${statusText}</div>
                ${controls}
            </div>`;
    }
}

function renderQueue(queue, myPlat) {
    const container = document.getElementById('qListContainer');
    if (queue.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:#999;font-size:0.8em;">Antrian Kosong</div>';
        return;
    }
    
    let html = '';
    queue.forEach((item, i) => {
        const isMyQueue = item.plat === myPlat;
        let adminControls = '';
        
        if (isAdmin) {
            const moveButtons = Array.from({ length: SLOTS_COUNT }, (_, s) => 
                 `<button class="adm-mini btn-green" onclick="adminMoveToSlot('${item.id}', ${s})">SLOT ${s + 1}</button>`
            ).join('');

            adminControls = `
                <div class="q-actions">
                    ${moveButtons}
                    <button class="adm-mini btn-red" onclick="confirmDeleteQueue('${item.id}')">HAPUS</button>
                </div>
            `;
        }

        html += `
            <div class="q-item ${isMyQueue ? 'my-queue' : ''}">
                <div>
                    <div class="q-plat">${i + 1}. ${item.plat} ${isMyQueue ? '(ANDA)' : ''}</div>
                    <div class="q-bat">Bat: ${item.startBattery}%</div>
                </div>
                ${adminControls}
            </div>
        `;
    });
    container.innerHTML = html;
}

function updateFormVisibility(myPlat, slots, queue) {
    const inSystem = myPlat && (slots.some(s => s && s.plat === myPlat) || queue.some(q => q.plat === myPlat));
    
    document.getElementById('reg-card').style.display = inSystem ? 'none' : 'block';
    
    // Tampilkan tombol leave jika sedang dalam sistem
    document.getElementById('leaveQueueSection').style.display = inSystem ? 'block' : 'none';

    if (inSystem) {
         // Jika sudah di antrian, tunjukkan status monitoring
         const isMonitoring = localStorage.getItem('monitoring_active') === 'true';
         document.getElementById('monitorStatus').style.display = isMonitoring ? 'block' : 'none';
    }
}

// --- USER ACTIONS ---
document.getElementById('btnDaftar').onclick = () => {
    const currentUser = JSON.parse(localStorage.getItem('maka_user'));
    const p = document.getElementById('uPlat').value.toUpperCase().trim();
    const w = document.getElementById('uWa').value;
    const b = parseInt(document.getElementById('uBat').value);
    const btn = document.getElementById('btnDaftar');

    if(!p || !w || isNaN(b)) return showModal('Error', 'Lengkapi data!');
    if(b < 0 || b > 100) return showModal('Error', 'Sisa Baterai tidak valid!', '‚ùå');

    // 1. GPS LOCK CHECK
    if (!isAdmin) {
        if (!userLat || !userLng) {
            return showModal('GPS Diperlukan', 'Mohon tunggu lokasi terdeteksi dan pastikan izin GPS aktif.', '‚ö†Ô∏è'); 
        }
        const distance = getDist(userLat, userLng, STATION_LOC.lat, STATION_LOC.lng);
        if (distance > MAX_DIST) {
            return showModal('Di Luar Jangkauan', `Anda ${distance.toFixed(2)} KM dari FC. Batas max adalah ${MAX_DIST} KM.`, '‚ùå');
        }
    }

    btn.disabled=true; btn.innerText="MEMPROSES...";

    db.runTransaction(async t => {
        const d = (await t.get(refAntrian)).data() || {};
        const s = d.chargingSlots && Array.isArray(d.chargingSlots) ? d.chargingSlots : Array(SLOTS_COUNT).fill(null);
        let q = d.waitingQueue || [];
        
        if(s.some(x=>x?.plat===p) || q.some(x=>x?.plat===p)) throw "Sudah terdaftar.";
        
        // 2. Tentukan slot atau antrian
        let empty = s.findIndex(x => !x);
        const userData = { plat:p, name:currentUser ? currentUser.nama : 'Guest', phone:w, startBattery:b, target:100, startTime:null, duration:0 };

        if(empty !== -1) {
            // Masuk Slot (Auto-fill)
            s[empty] = { ...userData, startTime: new Date().toISOString() };
        } else {
            // Masuk Antrian
            q.push({ id: db.collection('queue').doc().id, ...userData });
        }
        t.set(refAntrian, {chargingSlots:s, waitingQueue:q}, {merge:true});
    }).then(() => {
        localStorage.setItem('myPlat', p);
        localStorage.setItem('monitoring_active', 'true');
        keepAliveAudio.play().catch(e=>console.log("Audio blocked", e));
        btn.innerText = "MONITORING AKTIF";
        showModal("Berhasil Masuk", "<b>Monitoring Aktif!</b><br>Audio 'Hujan Pelan' diputar agar browser tidak tidur.", '‚úÖ');
        
    }).catch(e => {
        let errorMsg = typeof e === 'string' ? e : "Gagal Pendaftaran. Cek koneksi Anda.";
        if(e.code && e.code.includes('unavailable')) errorMsg = "Koneksi ke server Firebase gagal. Periksa internet Anda.";
        showModal("Gagal", errorMsg, '‚ùå'); 
        btn.disabled=false; btn.innerText="DAFTAR & AKTIFKAN MONITORING";
    });
};


// --- ADMIN/USER COMMON ACTIONS ---
function emptySlot(i, isUserLeaving) {
    db.runTransaction(async t => {
        const d = (await t.get(refAntrian)).data() || {};
        const s = d.chargingSlots && Array.isArray(d.chargingSlots) ? d.chargingSlots : Array(SLOTS_COUNT).fill(null);
        let q = d.waitingQueue || [];
        
        s[i] = null; // Kosongkan slot
        
        // Cek antrian, jika ada, pindahkan yang pertama
        if (q.length > 0) {
            const nextUser = q.shift(); // Ambil dari depan & hapus
            s[i] = { ...nextUser, startTime: new Date().toISOString() }; 
        }
        
        t.set(refAntrian, {chargingSlots: s, waitingQueue: q}, {merge:true});
    }).then(() => {
        if (isUserLeaving) {
            localStorage.removeItem('myPlat');
            localStorage.removeItem('monitoring_active');
            keepAliveAudio.pause();
        }
    }).catch(e => showModal("Error", "Gagal mengosongkan slot: " + e.message, '‚ùå'));
}

function confirmEmptySlot(i, isUserLeaving) {
     if (isUserLeaving) {
        showModal("Konfirmasi", "Yakin ingin mencabut motor dan mengosongkan Slot?", "confirm", () => emptySlot(i, true));
     } else {
        showModal("Konfirmasi Admin", "Yakin ingin mengosongkan Slot ini secara paksa?", "confirm", () => emptySlot(i, false));
     }
}

// --- ADMIN CONTROLS ---
function updateAdminUI() {
    if (isAdmin) {
        document.getElementById('adminResetArea').style.display = 'block';
    }
}
function openAdmin() { 
    if (isAdmin) {
        document.getElementById('adminModal').classList.remove('show');
        return;
    }
    document.getElementById('adminModal').classList.add('show'); 
}
function loginAdmin() {
    // PIN disamakan dengan Admin Code di fungsi daftar
    if(document.getElementById('adminPin').value === 'MAKAADMIN123') { 
        localStorage.setItem('maka_is_admin', 'true');
        isAdmin = true;
        document.getElementById('adminModal').classList.remove('show');
        updateAdminUI();
        initFirebase(); 
    } else {
        showModal("Error", "PIN Salah", '‚ùå');
    }
}
function confirmResetAll() {
    showModal("‚ö†Ô∏è RESET TOTAL", "Anda yakin ingin MENGHAPUS SEMUA DATA SLOT DAN ANTRIAN? Tindakan ini tidak bisa dibatalkan.", "confirm", resetAllData);
}

function resetAllData() {
    refAntrian.set({chargingSlots: Array(SLOTS_COUNT).fill(null), waitingQueue: []})
        .then(() => showModal("Sukses", "Semua data antrian & slot telah direset.", '‚úÖ'))
        .catch(e => showModal("Error", "Gagal reset: " + e.message, '‚ùå'));
}

function adminStartCharging(i) {
    refAntrian.update({ [`chargingSlots.${i}.startTime`]: new Date().toISOString() })
        .then(() => showModal("Sukses", `Slot ${i + 1} mulai charging.`, '‚úÖ'))
        .catch(e => showModal("Error", "Gagal mulai charging: " + e.message, '‚ùå'));
}
function adminStopCharging(i) {
    refAntrian.update({ [`chargingSlots.${i}.startTime`]: null })
        .then(() => showModal("Sukses", `Slot ${i + 1} berhenti charging.`, '‚úÖ'))
        .catch(e => showModal("Error", "Gagal stop charging: " + e.message, '‚ùå'));
}

function adminMoveToSlot(queueId, slotIndex) {
    db.runTransaction(async t => {
        const d = (await t.get(refAntrian)).data() || {};
        const s = d.chargingSlots && Array.isArray(d.chargingSlots) ? d.chargingSlots : Array(SLOTS_COUNT).fill(null);
        let q = d.waitingQueue || [];

        const queueIndex = q.findIndex(item => item.id === queueId);
        if (queueIndex === -1) throw "Antrian tidak ditemukan.";

        const userToMove = q.splice(queueIndex, 1)[0];
        
        // Slot sekarang diisi dengan user antrian, dan langsung START charging
        s[slotIndex] = { ...userToMove, startTime: new Date().toISOString() };

        t.set(refAntrian, {chargingSlots: s, waitingQueue: q}, {merge:true});
    }).then(() => {
        showModal("Pindah Sukses", `Motor dipindah ke Slot ${slotIndex + 1} dan mulai charging.`, '‚úÖ');
    }).catch(e => showModal("Error", "Gagal memindahkan: " + e.message, '‚ùå'));
}

function confirmDeleteQueue(queueId) {
    showModal("Konfirmasi Hapus", "Yakin ingin menghapus antrian ini?", "confirm", () => {
        db.runTransaction(async t => {
            const d = (await t.get(refAntrian)).data() || {};
            let q = d.waitingQueue || [];
            d.waitingQueue = q.filter(item => item.id !== queueId);
            t.set(refAntrian, d, {merge:true});
        }).then(() => showModal("Sukses", "Antrian dihapus.", '‚úÖ'))
        .catch(e => showModal("Error", "Gagal hapus antrian: " + e.message, '‚ùå'));
    });
}

// --- ALARM & MODAL ---
function triggerFullAlert() {
    keepAliveAudio.pause(); 
    alarmAudio.play().catch(e => console.log("Alarm blocked")); 
    
    document.getElementById('alarmScreen').style.display='flex';
    if(navigator.vibrate) navigator.vibrate([1000,500,1000]);
    if(Notification.permission==="granted") new Notification("SELESAI!", {body:"Motor Penuh!", tag:"alarm", icon:"/makarental/icon-512.png"});
}

function stopAlarmAndClear() {
    alarmAudio.pause(); 
    alarmAudio.currentTime=0;
    document.getElementById('alarmScreen').style.display='none';
    keepAliveAudio.play().catch(e => console.log("Keep alive restart failed")); 
    
    if (myActiveSlotIndex !== -1) {
        emptySlot(myActiveSlotIndex, true); 
        myActiveSlotIndex = -1;
    }
}

// HELPER MODAL
function showModal(title, desc, icon="üîî", onConfirm) {
    document.getElementById('mTitle').innerText = title;
    document.getElementById('mDesc').innerHTML = desc;
    
    let iconText = (icon === '‚ùå' || icon === '‚ö†Ô∏è' || title.includes('Gagal')) ? '‚ö†Ô∏è' : icon;
    document.getElementById('mIcon').innerText = iconText;
    
    const btns = document.getElementById('mBtns');
    if (icon === "confirm" && onConfirm) {
        // Logika untuk konfirmasi (YES/NO)
        const funcName = onConfirm.name;
        btns.innerHTML = `
            <button class="btn-modal btn-cancel" onclick="closeModal()">Batal</button>
            <button class="btn-modal btn-confirm" style="background:var(--danger);" onclick="closeModal(); ${funcName}()">YA, LANJUT</button>
        `;
    } else {
        // Logika untuk info/error (OK, SIAP)
        btns.innerHTML = `<button class="btn-modal btn-confirm" onclick="closeModal()">OK, SIAP</button>`;
    }
    
    document.getElementById('customModal').classList.add('show');
}
function closeModal() { document.getElementById('customModal').classList.remove('show'); }

// --- INITIALIZATION ---
document.addEventListener("DOMContentLoaded", initFirebase);
</script>
    
</body>
</html>
