<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kalender Pembayaran - MAKA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* GLOBAL THEME */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --text:#0f1724; 
    --danger:#ef4444; --success:#10b981; --warning:#fbbf24;
    --glass-bg:rgba(255,255,255,0.85); --glass-border:rgba(255,255,255,0.6); 
    --radius-lg:24px;
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body { 
    margin:0; font-family:'Inter', sans-serif; 
    background:var(--bg-base); color:var(--text); 
    min-height:100vh; position:relative; padding-bottom:100px;
}

/* BACKGROUND */
body::before {
    content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: url('1763947427555.jpg') center/cover no-repeat; 
    opacity: 0.15; z-index: -1; pointer-events: none;
}

.app-container { max-width:520px; margin:0 auto; padding:20px 20px 100px; }

/* HEADER & NAVIGASI BULAN */
.header { 
    display: flex; justify-content: space-between; align-items: center; 
    margin-bottom: 20px; background: white; padding: 10px 20px; 
    border-radius: 99px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}
.month-title { font-family: 'Syne'; font-size: 1.2em; font-weight: 800; text-transform: uppercase; }
.btn-nav { 
    background: #f1f5f9; border: none; width: 36px; height: 36px; 
    border-radius: 50%; font-weight: bold; cursor: pointer; color: var(--text);
}

/* KALENDER GRID */
.calendar-grid { 
    display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; 
    margin-bottom: 25px; 
}
.day-name { 
    text-align: center; font-size: 0.75em; font-weight: 800; 
    color: var(--muted); margin-bottom: 10px; text-transform: uppercase;
}
.date-cell {
    aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
    border-radius: 14px; font-weight: 700; font-size: 0.9em;
    background: rgba(255,255,255,0.6); position: relative;
    transition: 0.2s; border: 1px solid transparent;
}

/* STATUS WARNA KALENDER */
.date-cell.lunas { background: #dcfce7; color: var(--success); border-color: var(--success); }
.date-cell.tunggak { background: #fee2e2; color: var(--danger); border-color: var(--danger); box-shadow: 0 4px 10px rgba(239,68,68,0.2); }
.date-cell.today { border: 2px solid var(--text); background: white; }
.date-cell.empty { background: transparent; border: none; }

/* HERO CARD (TOTAL TUNGGAKAN) */
.hero-card {
    background: linear-gradient(135deg, #ef4444, #b91c1c); /* Merah Utang */
    color: white; padding: 24px; border-radius: 24px;
    box-shadow: 0 15px 40px rgba(239, 68, 68, 0.3);
    position: relative; overflow: hidden; text-align: center;
    transition: 0.3s;
}
.hero-card.aman {
    background: linear-gradient(135deg, #10b981, #059669); /* Hijau Aman */
    box-shadow: 0 15px 40px rgba(16, 185, 129, 0.3);
}

.hero-label { font-size: 0.8em; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; opacity: 0.9; margin-bottom: 5px; }
.hero-amount { font-family: 'Inter'; font-size: 2.8em; font-weight: 900; margin: 0; line-height: 1; letter-spacing: -1px; }
.hero-desc { font-size: 0.9em; margin-top: 10px; font-weight: 600; opacity: 0.9; }
.money-icon { font-size: 3em; position: absolute; right: 20px; bottom: 10px; opacity: 0.2; transform: rotate(-20deg); }

/* FOOTER NAV (Fixed Kapsul) */
footer.bottom-nav {
    position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
    width: auto; min-width: 260px; 
    background: rgba(255, 255, 255, 0.95); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 50px; padding: 10px 30px; 
    display: flex; justify-content: space-between; align-items: center; gap: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.5); z-index: 999;
}
.nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #94a3b8; font-size: 9px; font-weight: 700; transition: 0.2s; }
.nav-item span { font-size: 22px; margin-bottom: 2px; }
.nav-item.active { color: var(--accent); }

/* MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:9999; display:none; align-items:center; justify-content:center; }
.modal-overlay.show { display:flex; }
.modal-box { background:white; width:80%; max-width:300px; padding:25px; border-radius:24px; text-align:center; box-shadow:0 20px 50px rgba(0,0,0,0.3); }
</style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <button class="btn-nav" onclick="changeMonth(-1)">‚Äπ</button>
        <div class="month-title" id="monthDisplay">DESEMBER 2025</div>
        <button class="btn-nav" onclick="changeMonth(1)">‚Ä∫</button>
    </div>

    <div class="calendar-grid" id="calendarGrid">
        <div class="day-name">MIN</div><div class="day-name">SEN</div><div class="day-name">SEL</div>
        <div class="day-name">RAB</div><div class="day-name">KAM</div><div class="day-name">JUM</div><div class="day-name">SAB</div>
        </div>

    <div id="heroCard" class="hero-card">
        <div class="hero-label">TOTAL TUNGGAKAN BULAN INI</div>
        <div id="totalDebt" class="hero-amount">Rp 0</div>
        <div id="debtDesc" class="hero-desc">Data sedang dimuat...</div>
        <div class="money-icon">üí∞</div>
    </div>
    
    <div style="text-align:center; margin-top:20px; font-size:0.8em; color:#64748b;">
        <span style="display:inline-block; width:10px; height:10px; background:#fee2e2; border:1px solid red; border-radius:2px;"></span> Belum Bayar
        &nbsp;&nbsp;
        <span style="display:inline-block; width:10px; height:10px; background:#dcfce7; border:1px solid green; border-radius:2px;"></span> Lunas
    </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(err => console.log('PWA Error', err));
    });
  }
</script>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = JSON.parse(localStorage.getItem('maka_user'));
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let invoiceData = [];

document.addEventListener("DOMContentLoaded", () => {
    if(!currentUser) { window.location.href='index.html'; return; }
    loadInvoices();
});

// 1. TARIK DATA INVOICE DARI FIREBASE
function loadInvoices() {
    db.collection('invoices')
      .where('plat', '==', currentUser.plat)
      .onSnapshot(snap => {
          invoiceData = [];
          snap.forEach(doc => {
              const d = doc.data();
              // Konversi Range Tanggal menjadi Array Tanggal Satuan
              // Contoh: Invoice 10-12 Des, pecah jadi: [10, 11, 12]
              let start = new Date(d.startDate);
              let end = new Date(d.endDate);
              
              // Hitung harga per hari (Rata-rata)
              let diffTime = Math.abs(end - start);
              let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; 
              let dailyPrice = d.amount / diffDays;

              for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
                  invoiceData.push({
                      dateStr: dt.toISOString().split('T')[0], // YYYY-MM-DD
                      status: d.status, // paid / unpaid
                      amount: dailyPrice
                  });
              }
          });
          renderCalendar();
      });
}

// 2. RENDER KALENDER
function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '<div class="day-name">MIN</div><div class="day-name">SEN</div><div class="day-name">SEL</div><div class="day-name">RAB</div><div class="day-name">KAM</div><div class="day-name">JUM</div><div class="day-name">SAB</div>';
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const todayStr = new Date().toISOString().split('T')[0];

    document.getElementById('monthDisplay').innerText = 
        new Date(currentYear, currentMonth).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });

    // Empty Slots
    for(let i=0; i<firstDay; i++) {
        grid.innerHTML += `<div class="date-cell empty"></div>`;
    }

    let totalTunggakanBulanIni = 0;
    let countTunggak = 0;

    // Date Slots
    for(let d=1; d<=daysInMonth; d++) {
        // Format YYYY-MM-DD (Perhatikan Timezone +7 biar akurat, disini pakai simple string)
        // Agar aman, kita pakai string manual
        let mStr = (currentMonth+1).toString().padStart(2, '0');
        let dStr = d.toString().padStart(2, '0');
        let dateKey = `${currentYear}-${mStr}-${dStr}`;
        
        // Cek Status di Data Invoice
        let statusClass = "";
        let dataFound = invoiceData.find(x => x.dateStr === dateKey);
        
        if (dataFound) {
            if (dataFound.status === 'paid') {
                statusClass = "lunas";
            } else {
                // Hanya hitung tunggakan jika tanggal SUDAH LEWAT atau HARI INI
                if (dateKey <= todayStr) {
                    statusClass = "tunggak";
                    totalTunggakanBulanIni += dataFound.amount;
                    countTunggak++;
                } else {
                    // Belum jatuh tempo (Invoice masa depan)
                    statusClass = ""; 
                }
            }
        }

        // Cek Hari Ini
        if (dateKey === todayStr) statusClass += " today";

        grid.innerHTML += `<div class="date-cell ${statusClass}">${d}</div>`;
    }

    updateHeroCard(totalTunggakanBulanIni, countTunggak);
}

// 3. UPDATE HERO CARD
function updateHeroCard(amount, count) {
    const card = document.getElementById('heroCard');
    const txtAmount = document.getElementById('totalDebt');
    const txtDesc = document.getElementById('debtDesc');

    if (amount > 0) {
        // Ada Tunggakan
        card.className = "hero-card"; // Merah
        txtAmount.innerText = "Rp " + Math.round(amount).toLocaleString('id-ID');
        txtDesc.innerText = `Anda menunggak ${count} hari. Segera lunasi!`;
    } else {
        // Aman
        card.className = "hero-card aman"; // Hijau
        txtAmount.innerText = "Rp 0";
        txtDesc.innerText = "Tidak ada tunggakan bulan ini. Mantap! üëç";
    }
}

function changeMonth(n) {
    currentMonth += n;
    if(currentMonth > 11) { currentMonth=0; currentYear++; }
    else if(currentMonth < 0) { currentMonth=11; currentYear--; }
    renderCalendar();
}
</script>
</body>
</html>
