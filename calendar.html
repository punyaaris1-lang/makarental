<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalender Tagihan</title>
<link rel="stylesheet" href="app.css">
<link rel="stylesheet" href="styles.css"> 
</head>

<body class="app-body">
<div class="app-container">

    <h3 class="header-title" style="padding: 22px 22px 0;">üìÖ Kalender Pembayaran</h3>

    <div class="cal-header">
        <span style="color: var(--holiday-color);">Min</span>
        <span>Sen</span>
        <span>Sel</span>
        <span>Rab</span>
        <span>Kam</span>
        <span>Jum</span>
        <span>Sab</span>
    </div>

    <div class="cal-grid" id="calendar"></div>

</div>

<footer class="bottom-nav">
  <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>FC</a>
  <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
  <a href="calendar.html" class="nav-item active"><span>üìÖ</span>Bayar</a>
</footer>

<style>
.cal-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    padding: 10px 14px 0;
    font-size: 0.7em;
    font-weight: 600;
    color: var(--text-secondary);
}
</style>

<script src="app.js"></script>
<script>
// Pastikan semua fungsi dari app.js (getActiveUser, dateOnly, isHoliday, getDPCicilStatus, formatIDR, markPaid, getDailyRate) tersedia
const user = getActiveUser();
if(!user) location.href='index.html';

const cal = document.getElementById('calendar');
const now = new Date();
now.setHours(0,0,0,0);
const y = now.getFullYear();
const m = now.getMonth();

const daysInMonth = new Date(y, m+1, 0).getDate();

// Temukan hari pertama bulan ini untuk menentukan offset grid
const firstDayOfMonth = new Date(y, m, 1).getDay(); // 0 (Min) - 6 (Sab)

// Buat kotak kosong untuk offset hari
for(let i=0; i<firstDayOfMonth; i++){
    const emptyBox = document.createElement('div');
    emptyBox.className = 'day-box';
    emptyBox.innerHTML = '&nbsp;';
    emptyBox.style.border = 'none';
    emptyBox.style.background = 'transparent';
    emptyBox.style.boxShadow = 'none'; // Tambahan agar bersih di light mode
    cal.appendChild(emptyBox);
}


for(let d=1; d<=daysInMonth; d++){
  const date = new Date(y,m,d);
  date.setHours(0,0,0,0);
  const iso = dateOnly(date); // Gunakan fungsi dateOnly dari app.js

  const box = document.createElement('div');
  box.className = 'day-box';
  box.innerHTML = `<b>${d}</b>`;

  // Cek apakah hari ini
  if(date.getTime() === now.getTime()) box.classList.add('today-day');

  // Cek status pembayaran
  const isPaid = user.payments[iso]?.paid;
  const dpStatus = getDPCicilStatus(user, iso); 

  if(isPaid){
    box.classList.add('paid-day');
    box.innerHTML += `<small>Bayar</small>`;
  }
  else if(isHoliday(user, iso)){
    box.classList.add('holiday-day');
    box.innerHTML += `<small>Libur</small>`;
  }
  else if(dpStatus.isCicilDay){ // Hari Cicilan DP (Tgl 14/28 di 3 bulan awal)
    box.classList.add('dp-day');
    box.innerHTML += `<small>Cicil DP</small>`;
    box.onclick = ()=> confirmPay(iso, getDailyRate(user, iso)); 
  }
  else{
    // Hari wajib bayar harian
    const rate = getDailyRate(user, iso);
    box.innerHTML += `<small>${formatIDR(rate)}</small>`;
    
    // Hanya hari yang belum lewat dan bukan hari ini yang bisa di-klik untuk dibayar
    if (date.getTime() <= now.getTime()) {
      box.onclick = ()=> confirmPay(iso, rate);
    }
    
    // Beri penanda jika hari ini adalah Hari Tagihan (misal: warna teks)
    if (date.getTime() === now.getTime() && rate > 0) {
        box.style.color = 'var(--holiday-color)'; // Teks Merah/Kontras jika Hari Ini Belum Bayar
    }
  }

  cal.appendChild(box);
}

function confirmPay(date, amount){
  if(amount === 0) return; 

  if(confirm(`Bayar tanggal ${date}\nTagihan: ${formatIDR(amount)}`)){
    markPaid(user, date); 
    alert('‚úÖ Dicatat sebagai dibayar');
    location.reload();
  }
}
</script>

</body>
</html>
