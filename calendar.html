<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kalender - MAKA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root { --bg-base:#f0f4f8; --accent:#0ea5a6; --text:#0f1724; --danger:#ef4444; --success:#10b981; }
body { margin:0; font-family:'Inter'; background:var(--bg-base); color:var(--text); padding-bottom:100px; }
body::before { content:""; position:fixed; inset:0; background:url('1763947427555.jpg') center/cover; opacity:0.15; z-index:-1; pointer-events:none; }
.app-container { max-width:520px; margin:0 auto; padding:20px; }

/* HEADER & GRID */
.header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:white; padding:10px 20px; border-radius:99px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
.btn-nav { border:none; background:#f1f5f9; width:36px; height:36px; border-radius:50%; font-weight:bold; cursor:pointer; }
.calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:25px; }
.day-name { text-align:center; font-size:0.75em; font-weight:800; color:#64748b; margin-bottom:10px; }

/* DATE CELL */
.date-cell { 
    aspect-ratio:1; display:flex; flex-direction:column; align-items:center; justify-content:center; 
    border-radius:14px; font-weight:700; font-size:0.9em; background:rgba(255,255,255,0.6); position:relative;
}
.date-cell.lunas { background:#dcfce7; color:var(--success); border:1px solid var(--success); }
.date-cell.tunggak { 
    background:#fee2e2; color:var(--danger); border:1px solid var(--danger); 
    box-shadow:0 4px 10px rgba(239,68,68,0.2); cursor:pointer; 
}
.date-cell.today { border:2px solid var(--text); background:white; }
.date-cell.dp { background:#fef9c3; color:#b45309; border:1px solid #fbbf24; }
.small-lbl { font-size:0.5em; text-transform:uppercase; margin-top:-2px; }

/* HERO SUMMARY */
.hero-card { background:linear-gradient(135deg,var(--accent),#06b6d4); color:white; padding:20px; border-radius:20px; text-align:center; box-shadow:0 10px 30px rgba(14,165,166,0.3); }
.hero-card.alert { background:linear-gradient(135deg,#ef4444,#b91c1c); box-shadow:0 10px 30px rgba(239,68,68,0.3); }
.hero-amount { font-family:'Inter'; font-size:2.5em; font-weight:900; margin:5px 0; }

/* NAV */
footer.bottom-nav { position:fixed; bottom:25px; left:50%; transform:translateX(-50%); width:auto; min-width:260px; background:rgba(255,255,255,0.95); backdrop-filter:blur(20px); border-radius:50px; padding:10px 30px; display:flex; justify-content:space-between; gap:40px; box-shadow:0 10px 40px rgba(0,0,0,0.15); z-index:999; }
.nav-item { display:flex; flex-direction:column; align-items:center; text-decoration:none; color:#94a3b8; font-size:9px; font-weight:700; }
.nav-item.active { color:var(--accent); } .nav-item span { font-size:22px; }

/* MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; display:none; align-items:center; justify-content:center; }
.modal-box { background:white; width:80%; max-width:300px; padding:25px; border-radius:20px; text-align:center; }
.btn-modal { width:100%; padding:12px; margin-top:10px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <button class="btn-nav" onclick="changeMonth(-1)">‚Äπ</button>
        <div id="monthDisplay" style="font-family:'Syne';font-weight:800;">...</div>
        <button class="btn-nav" onclick="changeMonth(1)">‚Ä∫</button>
    </div>

    <div class="calendar-grid" id="calendarGrid"></div>

    <div id="heroCard" class="hero-card">
        <div style="font-size:0.8em;font-weight:800;opacity:0.9;">TOTAL TUNGGAKAN</div>
        <div id="totalDebt" class="hero-amount">Rp 0</div>
        <div id="debtDesc" style="font-size:0.85em;">Aman</div>
    </div>
    
    <div style="text-align:center;margin-top:20px;font-size:0.7em;color:#64748b;">
        üî¥ Belum (Klik Bayar) &nbsp; üü¢ Lunas &nbsp; üü° Jadwal DP
    </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="mTitle">Konfirmasi</h3>
        <p id="mDesc">...</p>
        <div id="mBtns"></div>
    </div>
</div>

<script>
if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'))}

const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = JSON.parse(localStorage.getItem('maka_user'));
let currentYear = new Date().getFullYear();
let currentMonth = new Date().getMonth();
let invoiceData = [];

document.addEventListener("DOMContentLoaded", () => {
    if(!currentUser) { window.location.href='index.html'; return; }
    loadInvoices();
});

function loadInvoices() {
    db.collection('invoices').where('plat', '==', currentUser.plat).onSnapshot(snap => {
        invoiceData = [];
        snap.forEach(doc => {
            const d = doc.data();
            let start = new Date(d.startDate);
            let end = new Date(d.endDate);
            let diffDays = Math.ceil(Math.abs(end - start)/(1000*60*60*24)) + 1;
            let dailyPrice = d.amount / diffDays;

            for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate() + 1)) {
                invoiceData.push({ id: doc.id, dateStr: dt.toISOString().split('T')[0], status: d.status, amount: dailyPrice });
            }
        });
        renderCalendar();
    });
}

function renderCalendar() {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '<div class="day-name">M</div><div class="day-name">S</div><div class="day-name">S</div><div class="day-name">R</div><div class="day-name">K</div><div class="day-name">J</div><div class="day-name">S</div>';
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const todayStr = new Date().toISOString().split('T')[0];

    document.getElementById('monthDisplay').innerText = new Date(currentYear, currentMonth).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' }).toUpperCase();

    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="date-cell empty"></div>`;

    let totalUnpaid = 0;

    for(let d=1; d<=daysInMonth; d++) {
        let m = (currentMonth+1).toString().padStart(2,'0');
        let da = d.toString().padStart(2,'0');
        let dateKey = `${currentYear}-${m}-${da}`;
        
        let cls = ""; let lbl = ""; let click = "";
        let found = invoiceData.find(x => x.dateStr === dateKey);

        if(found) {
            if(found.status === 'paid') cls = "lunas";
            else if(dateKey <= todayStr) {
                cls = "tunggak"; 
                totalUnpaid += found.amount;
                // KLIK EVENT UNTUK TANGGAL MERAH
                click = `onclick="paySelf('${found.id}', '${d}')"`;
            }
        } else {
            if(d===14 || d===28) { cls="dp"; lbl=`<div class="small-lbl">DP</div>`; }
            else if(d===31) { lbl=`<div class="small-lbl" style="color:red">OFF</div>`; }
        }
        
        if(dateKey === todayStr) cls += " today";
        grid.innerHTML += `<div class="date-cell ${cls}" ${click}>${d} ${lbl}</div>`;
    }

    // Update Hero
    const hero = document.getElementById('heroCard');
    if(totalUnpaid > 0) {
        hero.className = "hero-card alert";
        document.getElementById('totalDebt').innerText = "Rp " + Math.round(totalUnpaid).toLocaleString('id-ID');
        document.getElementById('debtDesc').innerText = "Segera lunasi tunggakan!";
    } else {
        hero.className = "hero-card";
        document.getElementById('totalDebt').innerText = "Rp 0";
        document.getElementById('debtDesc').innerText = "Status Aman. Mantap! üëç";
    }
}

function paySelf(id, date) {
    document.getElementById('customModal').style.display = 'flex';
    document.getElementById('mTitle').innerText = "Bayar Tanggal " + date + "?";
    document.getElementById('mDesc').innerText = "Pastikan Anda sudah transfer.";
    document.getElementById('mBtns').innerHTML = `
        <button class="btn-modal" onclick="document.getElementById('customModal').style.display='none'" style="background:#eee;color:#555">Batal</button>
        <button class="btn-modal" style="background:#10b981;color:white" onclick="doPay('${id}')">Ya, Sudah Bayar</button>
    `;
}

function doPay(id) {
    db.collection('invoices').doc(id).update({ status: 'paid' }).then(() => {
        document.getElementById('customModal').style.display = 'none';
        alert("Berhasil dilunasi!");
    });
}

function changeMonth(n) {
    currentMonth += n;
    if(currentMonth > 11) { currentMonth=0; currentYear++; }
    else if(currentMonth < 0) { currentMonth=11; currentYear--; }
    renderCalendar();
}
</script>
</body>
</html>
