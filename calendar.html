<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kalender MAKA</title>

<style>
:root{
 --bg:#030615;
 --card:#0b1324;
 --line:rgba(255,255,255,.08);
 --cyan:#00dfff;      /* wajib */
 --purple:#cc99ff;    /* cicilan dp */
 --yellow:#ffe600;    /* paid */
 --red:#ff4545;       /* libur */
}

body{
 margin:0;
 background:linear-gradient(180deg,#020512,#060a18);
 font-family:Inter,system-ui;
 color:#fff;
}
.app{max-width:520px;margin:auto;padding-bottom:120px}

/* HEADER */
header{padding:20px}
header h1{margin:0;font-size:1.2em}
header p{margin:6px 0 0;color:#aaa;font-size:.8em}

/* MONTH */
.month{
 display:flex;justify-content:space-between;
 align-items:center;padding:0 20px
}
.month h2{font-size:1em}
.month button{
 background:none;border:1px solid var(--line);
 color:#aaa;padding:6px 12px;border-radius:12px
}

/* WEEK */
.week{
 display:grid;grid-template-columns:repeat(7,1fr);
 padding:12px 20px;font-size:.7em;
 text-align:center;color:#7fa3ff
}

/* GRID */
.grid{
 display:grid;grid-template-columns:repeat(7,1fr);
 gap:10px;padding:0 20px 20px
}
.day.empty{pointer-events:none}
.box{
 aspect-ratio:1/1;border-radius:14px;
 display:flex;align-items:center;justify-content:center;
 font-weight:600;font-size:.9em;
 border:1px solid var(--line);
 background:var(--card);color:#8cbaff;
 transition:.2s
}
.box:hover{transform:scale(1.05)}

.wajib{border-color:var(--cyan);color:var(--cyan)}
.cdp{border-color:var(--purple);color:var(--purple)}
.libur{border-color:var(--red);color:var(--red)}

.paid{
 background:var(--yellow);
 color:#000;border:none;
 box-shadow:0 0 18px rgba(255,230,0,.5)
}

/* PREVIEW */
.preview{
 margin:0 20px;background:#0a1330;
 padding:16px;border-radius:16px;
 border:1px solid rgba(0,223,255,.25)
}

/* MODAL */
.modal{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.6);
 display:none;
 align-items:flex-end;
 z-index:2000;
}
.modal.active{display:flex}
.sheet{
 width:100%;max-width:520px;
 background:#050814;
 padding:22px;
 padding-bottom:120px; /* ‚¨ÖÔ∏è biar ga ketutupan nav */
 border-radius:24px 24px 0 0
}
.sheet h3{margin:0 0 8px}
.sheet button{
 width:100%;padding:14px;
 border:none;border-radius:14px;
 font-weight:700;margin-top:12px
}
.btn-pay{background:var(--yellow)}
.btn-cancel{background:#222;color:#aaa}

/* NAV */
.bottom-nav{
 position:fixed;bottom:0;left:50%;
 transform:translateX(-50%);
 width:100%;max-width:520px;
 height:90px;display:flex;
 background:linear-gradient(to top,#050814,#020512);
 border-top:1px solid var(--line);
 z-index:999;
}
.bottom-nav a{
 flex:1;text-align:center;
 font-size:.7em;color:#777;text-decoration:none;
 padding-top:14px
}
.bottom-nav span{
 display:block;font-size:26px;margin-bottom:6px
}
.bottom-nav .active{color:#fff}
.bottom-nav .active span{
 background:#3d5cff;width:56px;height:56px;
 border-radius:50%;display:flex;
 align-items:center;justify-content:center;
 margin:0 auto 6px
}
</style>
</head>

<body>
<div class="app">

<header>
 <h1>Kalender Pembayaran</h1>
 <p>Status real sesuai dashboard</p>
</header>

<div class="month">
 <button onclick="nav(-1)">‚Äπ</button>
 <h2 id="label"></h2>
 <button onclick="nav(1)">‚Ä∫</button>
</div>

<div class="week">
 <div>Min</div><div>Sen</div><div>Sel</div>
 <div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
</div>

<div class="grid" id="grid"></div>

<div class="preview">
 <small>Total tagihan bulan ini</small>
 <strong id="total">Rp 0</strong>
</div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
 <div class="sheet">
  <h3 id="m-date"></h3>
  <p id="m-desc"></p>
  <button class="btn-pay" onclick="pay()">Bayar</button>
  <button class="btn-cancel" onclick="closeModal()">Batal</button>
 </div>
</div>

<footer class="bottom-nav">
<a href="lokasi_fc.html"><span>‚ö°</span>FC</a>
<a href="dashboard.html"><span>üè†</span>Home</a>
<a href="calendar.html" class="active"><span>üìÖ</span>Kalender</a>
</footer>

<script>
/* =============================
   SHARED BILLING LOGIC
   ============================= */

const user = JSON.parse(localStorage.getItem('maka_user'))
const payData = JSON.parse(localStorage.getItem('maka_payments')) || {}
const view = new Date()

const HARIAN = 80000
const CICIL = 70000
const TOTAL_DP = 6

if(!user) throw 'USER NOT FOUND'

/* HITUNG DP LUNAS */
let dpPaid = Object.values(payData).filter(v=>v==='DP').length
let dpLunas = dpPaid >= TOTAL_DP

/* RULE TANGGAL */
function rule(date){
 const d = date.getDate()

 if(d===31) return 'LIBUR'

 if(user.dpMode==='755' && (d===14||d===28)) return 'LIBUR'

 if(user.dpMode==='355' && (d===14||d===28)){
  return dpLunas ? 'LIBUR' : 'CDP'
 }

 return 'NORMAL'
}

/* RENDER */
let activeKey=null,activeType=null,activeAmount=0

function nav(n){view.setMonth(view.getMonth()+n);render()}

function render(){
 const y=view.getFullYear(),m=view.getMonth()
 document.getElementById('label').textContent=
  view.toLocaleDateString('id-ID',{month:'long',year:'numeric'})

 const first=new Date(y,m,1).getDay()
 const days=new Date(y,m+1,0).getDate()
 const grid=document.getElementById('grid')
 grid.innerHTML=''
 let total=0

 const start=new Date(user.tglAmbil)
 start.setDate(start.getDate()+1)
 start.setHours(0,0,0,0)

 const today=new Date()
 today.setHours(0,0,0,0)

 for(let i=0;i<first;i++)
  grid.innerHTML+='<div class="day empty"></div>'

 for(let d=1;d<=days;d++){
  const date=new Date(y,m,d)
  date.setHours(0,0,0,0)

  const key=`${y}-${m+1}-${d}`
  const status=rule(date)

  let cls='box'
  let price=0
  let type=null

  if(date < start){
   cls+=' libur'
  }else{
   if(status==='LIBUR') cls+=' libur'
   if(status==='CDP'){cls+=' cdp';price=CICIL;type='DP'}
   if(status==='NORMAL'){
    cls+=' wajib'
    price=user.makaPlus?HARIAN:CICIL
    type='HARIAN'
   }
  }

  if(payData[key]) cls+=' paid'
  if(!payData[key]&&price>0&&date<=today) total+=price

  grid.innerHTML+=`
   <div class="day">
    <div class="${cls}"
     onclick="openModal('${key}','${type}',${price})">${d}</div>
   </div>`
 }

 document.getElementById('total').textContent=
  `Rp ${total.toLocaleString('id-ID')}`
}

/* MODAL */
function openModal(k,t,p){
 if(!p) return
 activeKey=k;activeType=t;activeAmount=p
 document.getElementById('m-date').textContent=`Tanggal ${k}`
 document.getElementById('m-desc').textContent=
  `Bayar ${t==='DP'?'Cicilan DP':'Harian'} ¬∑ Rp ${p.toLocaleString('id-ID')}`
 document.getElementById('modal').classList.add('active')
}
function closeModal(){
 document.getElementById('modal').classList.remove('active')
}
function pay(){
 payData[activeKey]=activeType
 localStorage.setItem('maka_payments',JSON.stringify(payData))
 closeModal();render()
}

render()
</script>
</body>
</html>
