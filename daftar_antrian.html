<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Antrian FC Public</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link rel="manifest" href="/makarental/manifest.json">

<style>
/* GLOBAL THEME */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --accent-2:#06b6d4; --text:#0f1724; 
    --danger:#ef4444; --success:#10b981; --warning:#fbbf24; --disabled:#cbd5e1;
    --primary-pink: #ff1493; /* Warna Khas Admin */
    --radius-lg:24px;
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body { 
    margin:0; padding:0; font-family:'Inter', sans-serif; 
    background:var(--bg-base); color:var(--text); 
    min-height:100vh; position:relative; overflow-x:hidden;
}

body::before {
    content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: url('1763947427555.jpg') center/cover no-repeat; 
    opacity: 0.15; z-index: -1; pointer-events: none;
}

.app-container { max-width:520px; margin:0 auto; padding:20px 20px 100px; }

/* HEADER */
.header { margin-bottom:20px; display:flex; align-items:center; justify-content:space-between; }
.header h1 { font-family:'Inter'; font-size:1.4em; font-weight:800; margin:0; color:var(--text); line-height:1; }
.header p { color:#64748b; font-size:0.75em; margin:4px 0 0; font-weight:600; }
.live-badge { background:#64748b; color:white; font-weight:800; font-size:0.65em; padding:6px 12px; border-radius:20px; }
.live-badge.online { background:var(--success); box-shadow:0 0 10px var(--success); }

/* FORMULIR */
.reg-card { background:white; border-radius:20px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); margin-bottom: 25px; border:1px solid #e2e8f0; }
.form-input { width:100%; padding:14px; border:1px solid #cbd5e1; border-radius:12px; margin-bottom:12px; font-family:'Inter'; font-size:1em; background:#f8fafc; outline:none; color:var(--text); }
.btn-submit { 
    width:100%; padding:16px; 
    background: #0ea5a6 !important; color: #ffffff !important;
    border: none; border-radius:16px; font-weight:900; font-size:1em; 
    cursor:pointer; box-shadow:0 10px 20px rgba(14,165,166,0.3); 
    text-transform: uppercase; letter-spacing: 1px;
}
.btn-submit:disabled { background:#cbd5e1 !important; color: #94a3b8 !important; cursor:not-allowed; }

/* SLOT CHARGING */
.section-head { font-family:'Inter'; font-size:0.85em; font-weight:800; color:#64748b; margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; }
.slot-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:25px; }
.slot-card { background:rgba(255,255,255,0.7); border:1px solid rgba(255,255,255,0.6); border-radius:18px; padding:15px 5px; text-align:center; min-height:170px; position:relative; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
.slot-card.active { background:white; border:2px solid var(--accent); }
.slot-label { font-size:0.65em; font-weight:800; color:#64748b; margin-bottom:8px; }
.bat-body { width:34px; height:60px; border:2px solid #cbd5e1; border-radius:8px; margin:0 auto 8px; position:relative; display:flex; align-items:flex-end; padding:2px; }
.bat-head { width:12px; height:3px; background:#cbd5e1; position:absolute; top:-5px; left:50%; transform:translateX(-50%); border-radius:2px 2px 0 0; }
.bat-liquid { width:100%; background:linear-gradient(to top, #0ea5a6, #06b6d4); border-radius:4px; transition:height 0.5s; }
.slot-user { font-weight:800; font-size:0.85em; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
.slot-timer { font-family:'Inter'; font-weight:900; font-size:0.9em; color:var(--danger); display:block; margin-top:2px; }
.slot-target { font-size:0.7em; font-weight:bold; color:var(--danger); display:block; }
.slot-status { font-size:0.6em; font-weight:800; padding:4px 6px; border-radius:6px; margin-top:4px; display:inline-block; }
.st-ready { background:#dcfce7; color:#166534; } 
.st-charging { background:#cffafe; color:#0e7490; } 
.st-waiting { background:#fef3c7; color:#854d0e; }

/* ADMIN ACCESS PANEL (Desain Baru) */
#adminPanel {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000;
    display: none; align-items: center; justify-content: center;
    backdrop-filter: blur(10px);
}
.admin-card {
    width: 90%; max-width: 400px; padding: 25px; border-radius: 20px;
    background: #111; color: white; box-shadow: 0 0 30px rgba(255,20,147,0.5);
}
.admin-header {
    font-family: 'Syne'; font-size: 1.5em; font-weight: 900; margin-bottom: 20px;
    text-align: center; color: var(--primary-pink);
}
.admin-action-btn {
    width: 100%; padding: 16px; margin-bottom: 15px; border: none; border-radius: 12px;
    font-weight: 800; font-size: 1em; cursor: pointer; text-transform: uppercase;
    transition: 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.btn-select {
    background: #333; color: white; padding: 16px; border: 2px solid #555;
}
.btn-select-slot {
    width: 100%; height: 50px; background: #333; color: white; border: 2px solid #555;
    border-radius: 12px; margin-bottom: 15px; font-size: 1em;
}

.btn-teal { background: var(--accent); color: white; border-bottom: 4px solid #00898a; }
.btn-pink { background: var(--primary-pink); color: white; border-bottom: 4px solid #cc0077; }
.btn-danger { background: var(--danger); color: white; border-bottom: 4px solid #cc3333; }
.btn-light { background: #555; color: white; }

.admin-action-btn:active { transform: translateY(2px); box-shadow: none; }

/* ADMIN TRIGGER */
.admin-trigger { text-align:center; margin-top:50px; padding: 20px; border-top: 1px dashed #ccc; }
.btn-admin-login { background: transparent; border: 2px solid #cbd5e1; color: #94a3b8; padding: 8px 20px; border-radius: 99px; font-size: 0.8em; font-weight: 700; cursor: pointer; }

/* NAV */
footer.bottom-nav { position:fixed; bottom:25px; left:50%; transform:translateX(-50%); width: auto; min-width: 260px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border-radius: 50px; padding: 10px 30px; display: flex; justify-content: space-between; align-items: center; gap: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.5); z-index: 999; }
.nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #94a3b8; font-size: 9px; font-weight: 700; transition: 0.2s; }
.nav-item span { font-size: 22px; margin-bottom: 2px; }
.nav-item.active { color: var(--accent); }

/* MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; display:none; align-items:center; justify-content:center; }
.modal-overlay.show { display: flex; }
.modal-box { background:white; width:80%; max-width:300px; padding:25px; border-radius:24px; text-align:center; }
.btn-modal { width:100%; padding:12px; margin-top:10px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; }

/* LIST ANTRIAN */
.q-item { display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border-radius:12px; margin-bottom:10px; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
.q-plat { font-weight:800; font-size:1em; }
.q-bat { font-size:0.75em; color:#64748b; }
.ctrl-btn { padding: 8px 12px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 0.8em; transition: 0.1s; }
.btn-red { background: #fecaca; color: #b91c1c; }
.btn-green { background: #dcfce7; color: #166534; }
</style>
</head>
<body>

<audio id="keepAliveAudio" loop><source src="https://www.soundjay.com/nature/sounds/rain-01.mp3" type="audio/mp3"></audio>
<audio id="alarmAudio" loop><source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mp3"></audio>

<div id="alarmScreen" class="modal-overlay" style="background:rgba(220,20,60,0.98);">
    <div style="text-align:center; color:white;">
        <div style="font-size:100px;">‚ö°</div>
        <h1 style="font-family:'Inter'; font-size:3em; margin:0;">SELESAI!</h1>
        <button class="btn-stop" onclick="stopAlarmAndClear()" style="background:white; color:red; border:none; padding:15px 40px; border-radius:50px; font-weight:900; font-size:1.2em; margin-top:30px;">SAYA SUDAH CABUT</button>
    </div>
</div>

<div class="app-container">
    <header class="header">
        <div class="header-text">
            <h1>FC Kelapa Gading</h1>
            <p>Real-time Queue System</p>
        </div>
        <div id="connStatus" class="live-badge">OFFLINE</div>
    </header>

    <div class="reg-card">
        <h3 style="margin:0 0 16px 0;font-family:'Inter';font-weight:800;font-size:1.2em;">Ambil Antrian</h3>
        <input id="uPlat" class="form-input" placeholder="Plat Nomor" style="text-transform:uppercase;">
        <input id="uWa" type="number" class="form-input" placeholder="WhatsApp">
        <input id="uBat" type="number" class="form-input" placeholder="Sisa Baterai (%)">
        
        <button id="btnDaftar" class="btn-submit" disabled>DAFTAR & AKTIFKAN MONITORING</button>
        
        <p id="monitorStatus" style="text-align:center; font-size:0.75em; color:var(--success); font-weight:700; margin-top:15px; display:none; background:#ecfdf5; padding:10px; border-radius:10px; border:1px solid #10b981;">
            üîä <b>MONITORING AKTIF</b><br>Audio "Hujan Pelan" diputar agar browser tidak tidur.
        </p>
    </div>

    <div class="section-head">STATUS CHARGING</div>
    <div class="slot-grid" id="slots">
        </div>

    <div class="section-head">LIST ANTRIAN</div>
    <div class="queue-list" id="qListContainer">
        <div style="text-align:center;padding:20px;color:#999;font-size:0.8em;">Belum ada antrian.</div>
    </div>

    <div class="admin-trigger">
        <button onclick="showAdminPanel()" class="btn-admin-login">üîí Admin / Operator Login</button>
    </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item active"><span>üé´</span>Antrian</a>
</footer>

<div id="adminPanel" class="modal-overlay">
    <div class="admin-card">
        <div class="admin-header">ADMIN ACCESS</div>
        <select id="slotSelector" class="btn-select-slot">
            <option value="0">Slot 1</option>
            <option value="1">Slot 2</option>
            <option value="2">Slot 3</option>
        </select>

        <button onclick="kosongkanSlot()" class="admin-action-btn btn-danger">KOSONGKAN SLOT</button>
        <button onclick="naikkanAntrian()" class="admin-action-btn btn-teal">NAIKKAN ANTRIAN (AUTO)</button>
        
        <div style="height: 10px;"></div>
        
        <input type="text" id="platBlokir" class="form-input btn-select" placeholder="Plat Nomor untuk Blokir">
        <button onclick="blokirUser()" class="admin-action-btn btn-pink">BLOKIR USER</button>
        
        <button onclick="resetDatabase()" class="admin-action-btn btn-danger">‚ö†Ô∏è RESET DATABASE</button>
        <button onclick="hideAdminPanel()" class="admin-action-btn btn-light">TUTUP PANEL</button>
    </div>
</div>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <h3 id="mTitle">Bayar?</h3>
        <p id="mDesc" style="color:#666;font-size:0.9em;margin:10px 0;">Konfirmasi</p>
        <div id="mBtns"></div>
    </div>
</div>

<script>
if('serviceWorker' in navigator){window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js'))}
</script>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};

// --- VARIABLES ---
const SLOT_NAMES = ["SLOT 1", "SLOT 2", "SLOT 3"];
let db;
let isAdmin = false;
let triggered = new Set();
let myActiveSlotIndex = -1;
let chargingSlotsData = []; 
let maxTargetBattery = 100; 
let isInitialized = false;

const keepAliveAudio = document.getElementById('keepAliveAudio');
keepAliveAudio.volume = 0.05; 
const alarmAudio = document.getElementById('alarmAudio');
alarmAudio.volume = 1.0; 

// FIX: Initialize App Function
function initializeApp() {
    if (!isInitialized) {
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            isInitialized = true;
            initFirebase(); 
        } catch (e) {
            if (e.code !== 'app/duplicate-app') {
                console.error("Firebase init error:", e);
                return;
            }
        }
    }

    const u = JSON.parse(localStorage.getItem('maka_user'));
    if(u && u.plat) document.getElementById('uPlat').value = u.plat;
    checkFormInputs();
}

window.addEventListener('load', initializeApp);

// FIX: Listener untuk mengatasi White Screen/State Loss
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        initializeApp(); 
    }
});


function checkFormInputs() {
    const p = document.getElementById('uPlat').value.toUpperCase().trim();
    const w = document.getElementById('uWa').value;
    const b = document.getElementById('uBat').value;
    const btn = document.getElementById('btnDaftar');
    
    // Validasi dasar
    if(p && w && b && p.length > 3 && w.length > 5 && b >= 1 && b <= 100) {
        btn.disabled = false;
    } else {
        btn.disabled = true;
    }
    
    // Status Monitoring
    if (localStorage.getItem('myPlat') === p) {
        btn.innerText = "MONITORING AKTIF";
        document.getElementById('monitorStatus').style.display='block';
        btn.disabled = true;
    } else {
         btn.innerText = "DAFTAR & AKTIFKAN MONITORING";
         document.getElementById('monitorStatus').style.display='none';
    }
}
document.getElementById('uPlat').addEventListener('input', checkFormInputs);
document.getElementById('uWa').addEventListener('input', checkFormInputs);
document.getElementById('uBat').addEventListener('input', checkFormInputs);


// --- TIMER TICKER ---
setInterval(() => {
    chargingSlotsData.forEach((slot, i) => {
        if (slot && slot.startTime && document.getElementById(`timer-${i}`)) {
            const start = new Date(slot.startTime).getTime();
            const end = start + (slot.duration * 60000); 
            const diff = end - Date.now();
            
            const timerEl = document.getElementById(`timer-${i}`);
            const myPlat = localStorage.getItem('myPlat') || "";

            if (diff <= 0) {
                timerEl.innerText = "SELESAI!";
                if (!triggered.has(slot.name) && myPlat === slot.name) {
                    triggered.add(slot.name);
                    myActiveSlotIndex = i; 
                    triggerFullAlert();
                }
            } else {
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                
                const displayTime = h > 0 ? `${h}j ${m}m ${s}s` : `${m}m ${s}s`;
                timerEl.innerText = displayTime;
            }
        }
    });
}, 1000);

// --- LOGIKA DURASI CAS (FIXED RUMUS) ---
function calculateDuration(startBattery, currentQueueLength) {
    let target = 100;
    
    if (currentQueueLength >= 3 && currentQueueLength <= 5) target = 95;
    else if (currentQueueLength >= 6 && currentQueueLength <= 10) target = 90;
    else if (currentQueueLength > 10) target = 85;

    maxTargetBattery = target; 

    let percentNeeded = target - startBattery;
    if(percentNeeded < 0) percentNeeded = 0;
    
    let duration = percentNeeded * 1; 

    if (target < 100) {
        duration = percentNeeded * 0.85; 
    } else if (percentNeeded > 50) {
        duration = percentNeeded * 1.1; 
    }
    
    return Math.max(5, Math.ceil(duration)); 
}


// --- FIREBASE LOGIC ---
function initFirebase() {
    if (!db) return;
    const ref = db.collection("antrian").doc("utama");
    ref.onSnapshot(snap => {
        document.getElementById('connStatus').innerText = "LIVE ‚óè";
        document.getElementById('connStatus').classList.add('online');

        const d = snap.data() || {};
        const s = d.chargingSlots || [null,null,null];
        const q = d.waitingQueue || [];
        const myPlat = localStorage.getItem('myPlat') || "";
        
        chargingSlotsData = s; 

        // RENDER SLOTS (FIX: Baterai Visual)
        document.getElementById('slots').innerHTML = s.map((x,i) => {
            if(!x) return `<div class="slot-card"><div class="slot-label">${SLOT_NAMES[i]}</div><div class="bat-body"><div class="bat-head"></div><div class="bat-liquid" style="height:0%"></div></div><div class="slot-user">-</div><div class="slot-status st-ready">KOSONG</div></div>`;

            const isRun = !!x.startTime;
            let css = isRun ? "st-charging" : "st-waiting";
            
            let batPercent = x.startBattery || 0; 
            if (isRun) batPercent = 100; 

            let targetLabel = (x.target && x.target < 100) ? `<span class="slot-target">Batas: ${x.target}%</span>` : "";
            let controls = "";
            let timerHtml = "";

            if(isRun) {
                timerHtml = `<span id="timer-${i}" class="slot-timer">Menghitung...</span>`;
                controls = `<button onclick="emptySlot(${i})" class="ctrl-btn btn-red">‚èπÔ∏è SELESAI / CABUT</button>`;
            } else {
                timerHtml = `<span class="slot-status ${css}">MENUNGGU</span>`;
                controls = `<button onclick="startCharge(${i})" class="ctrl-btn btn-green">‚ñ∂Ô∏è MULAI CAS</button>`;
            }
            
            const isMySlot = (x.name === myPlat); 
            let controlsDisplay = (isMySlot || isAdmin) ? controls : "";


            return `
            <div class="slot-card ${isRun?'active':''}">
                <div class="slot-label">${SLOT_NAMES[i]}</div>
                <div class="bat-body"><div class="bat-head"></div><div class="bat-liquid" style="height:${batPercent}%"></div></div>
                <div class="slot-user">${x.name} <br> ${targetLabel}</div>
                ${timerHtml}
                ${controlsDisplay}
            </div>`;
        }).join('');

        // RENDER QUEUE (FIX: Tombol Admin di Antrian)
        const qc = document.getElementById('qListContainer');
        if(q.length===0) {
            qc.innerHTML = '<div style="text-align:center;color:#999;font-size:0.8em;padding:20px;">Antrian Kosong</div>';
        } else {
            qc.innerHTML = q.map((x,i) => {
                let adminActs = "";
                if(isAdmin) {
                    adminActs = `
                        <div class="q-actions" style="display:flex; gap:5px;">
                            <button class="ctrl-btn btn-green" onclick="moveQueueToSlot(${i})" style="width: auto; padding: 5px 10px; font-size: 0.7em;">MASUKKAN</button>
                            <button class="ctrl-btn btn-red" onclick="deleteQueue(${i})" style="width: auto; padding: 5px 10px; font-size: 0.7em;">HAPUS</button>
                        </div>
                    `;
                }
                return `<div class="q-item"><div><div class="q-plat">${i+1}. ${x.name}</div><div class="q-bat">Bat: ${x.startBattery}%</div></div>${adminActs}</div>`;
            }).join('');
        }
    });

    // DAFTAR (FIX: Tombol Daftar Error)
    document.getElementById('btnDaftar').onclick = () => {
        const p = document.getElementById('uPlat').value.toUpperCase().trim();
        const w = document.getElementById('uWa').value;
        const b = parseInt(document.getElementById('uBat').value);
        const btn = document.getElementById('btnDaftar');

        if(!p || !w || isNaN(b) || b < 1 || b > 100) return showModal("Error", 'Lengkapi data dengan benar!', "‚ùå");
        
        keepAliveAudio.play().catch(e=>console.log("Audio blocked", e));

        btn.disabled=true; btn.innerText="MEMPROSES...";

        db.runTransaction(async t => {
            const ref = db.collection("antrian").doc("utama");
            const doc = await t.get(ref);
            const d = doc.data() || {};

            let s = d.chargingSlots || [null,null,null];
            let q = d.waitingQueue || [];
            
            if(s.some(x=>x?.name===p) || q.some(x=>x?.name===p)) throw "Sudah terdaftar.";
            
            let currentQueueLength = s.filter(x=>x).length + q.length;
            let duration = calculateDuration(b, currentQueueLength);
            let target = maxTargetBattery; 

            let empty = s.findIndex(x => !x);
            
            const userData = { name:p, phone:w, startBattery:b, target:target, duration:duration, joinedAt: firebase.firestore.FieldValue.serverTimestamp() };

            if(empty !== -1) {
                userData.startTime = null;
                s[empty] = userData;
            } else {
                q.push(userData);
            }
            t.set(ref, {chargingSlots:s, waitingQueue:q}, {merge:true});
        }).then(() => {
            localStorage.setItem('myPlat', p);
            checkFormInputs(); 
            showModal("Berhasil Masuk", "<b>Monitoring Aktif!</b><br>Anda berada di antrian. Audio diputar.", "‚úÖ");
        }).catch(e => {
            showModal("Gagal", (typeof e === 'string' ? e : "Gagal terhubung ke database. Cek Rules Firestore.")); 
            btn.disabled=false; 
            checkFormInputs(); 
        });
    };
}


// --- ADMIN PANEL FUNCTIONS ---
function showAdminPanel() {
    const pin = prompt("Masukkan PIN Admin:");
    if (pin === '1131') { 
        isAdmin = true;
        document.getElementById('adminPanel').classList.add('show');
        showModal("Mode Operator", "Anda masuk sebagai Admin.");
    } else {
        showModal("Akses Ditolak", "PIN Salah.", "‚ùå");
    }
}
function hideAdminPanel() {
    document.getElementById('adminPanel').classList.remove('show');
}

function kosongkanSlot() {
    const i = parseInt(document.getElementById('slotSelector').value);
    if(!confirm(`Kosongkan Slot ${i+1}?`)) return; 
    updateDB(d => { d.chargingSlots[i] = null; return d; });
    hideAdminPanel();
}

function naikkanAntrian() {
    db.runTransaction(async t => {
        const ref = db.collection("antrian").doc("utama");
        const doc = await t.get(ref);
        const d = doc.data();
        let s = d.chargingSlots || [null, null, null];
        let q = d.waitingQueue || [];
        
        if (q.length === 0) throw "Antrian kosong.";

        let emptyIdx = s.findIndex(x => !x);
        if(emptyIdx === -1) throw "Semua slot terisi.";

        let user = q.shift(); 
        
        let currentQueueLength = s.filter(x=>x).length + q.length;
        user.duration = calculateDuration(user.startBattery, currentQueueLength);
        user.target = maxTargetBattery;
        user.startTime = null; 

        s[emptyIdx] = user; 
        
        t.update(ref, {chargingSlots: s, waitingQueue: q});
        return user.name;
    }).then((name) => {
        showModal("Antrian Naik", `${name} dipindahkan ke slot.`, "‚úÖ");
    }).catch(e => showModal("Gagal", (typeof e === 'string' ? e : "Gagal transaksi Firestore.")));
    hideAdminPanel();
}

function deleteQueue(i) {
    if(!confirm(`Hapus antrian #${i+1}?`)) return;
    updateDB(d => { d.waitingQueue.splice(i, 1); return d; });
}

function blokirUser() {
    const plat = document.getElementById('platBlokir').value.toUpperCase().trim();
    if (!plat) return showModal("Error", "Masukkan Plat Nomor.", "‚ùå");
    if (!confirm(`Yakin BLOKIR ${plat}? User akan keluar dari aplikasi.`)) return;

    db.collection('users').doc(plat).update({
        isBanned: true
    }).then(() => {
        updateDB(d => {
            d.chargingSlots = (d.chargingSlots || [null,null,null]).map(x => x?.name === plat ? null : x);
            d.waitingQueue = (d.waitingQueue || []).filter(x => x.name !== plat);
            return d;
        });
        showModal("Blokir Berhasil", `${plat} berhasil diblokir.`, "‚úÖ");
    }).catch(e => {
        showModal("Gagal Blokir", "Plat tidak ditemukan.", "‚ùå");
    });
    hideAdminPanel();
}

function resetDatabase() {
    if(confirm("RESET TOTAL? Ini akan menghapus SEMUA antrian dan slot.")) {
        db.collection("antrian").doc("utama").set({chargingSlots:[null,null,null], waitingQueue:[]})
        .then(() => showModal("Reset Berhasil", "Database antrian telah dikosongkan.", "‚úÖ"))
        .catch(e => showModal("Gagal Reset", "Error saat mengosongkan database.", "‚ùå"));
    }
    hideAdminPanel();
}


// HELPER FUNCTIONS
function emptySlot(i) {
    if(!confirm("Selesai & Cabut?")) return; 
    updateDB(d => { d.chargingSlots[i] = null; return d; });
    localStorage.removeItem('myPlat'); 
    keepAliveAudio.pause();
    checkFormInputs();
}
function startCharge(i) { 
    updateDB(d => { 
        d.chargingSlots[i].startTime = new Date().toISOString(); 
        return d; 
    });
}
function updateDB(callback) {
    const ref = db.collection("antrian").doc("utama");
    db.runTransaction(async t => {
        const doc = await t.get(ref);
        const newData = callback(doc.data() || {});
        t.update(ref, newData);
    }).catch(e => showModal("Error", e));
}

// ALERT SYSTEM
function triggerFullAlert() {
    keepAliveAudio.pause(); 
    alarmAudio.play().catch(e => console.log("Alarm blocked"));
    document.getElementById('alarmScreen').classList.add('show');
    if(navigator.vibrate) navigator.vibrate([1000,500,1000]);
    if(Notification.permission==="granted") new Notification("SELESAI!", {body:"Motor Penuh!", tag:"alarm"});
}
function stopAlarmAndClear() {
    alarmAudio.pause(); alarmAudio.currentTime=0;
    document.getElementById('alarmScreen').classList.remove('show');
    
    if (myActiveSlotIndex !== -1) { 
        emptySlot(myActiveSlotIndex); 
        myActiveSlotIndex = -1; 
    } else {
        keepAliveAudio.pause();
    }
}

// HELPER MODAL
function showModal(title, desc, icon="üîî") {
    document.getElementById('mTitle').innerText = title;
    document.getElementById('mDesc').innerHTML = desc;
    document.getElementById('mBtns').innerHTML = `<button class="btn-modal" style="background:var(--accent); color:white;" onclick="closeModal()">OK</button>`;
    document.getElementById('customModal').classList.add('show');
}
function closeModal() { document.getElementById('customModal').classList.remove('show'); }
</script>
</body>
</html>
