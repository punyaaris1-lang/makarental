<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Antrian FC - Futuristik (Light)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#ffffff;
  --card:#fbfdff;
  --muted:#667085;
  --accent:#0ea5ff; /* blue accent */
  --accent-2:#60c8ff;
  --glass:rgba(255,255,255,0.7);
  --shadow:0 10px 30px rgba(2,6,23,0.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,-apple-system,"Helvetica Neue",Arial;color:#0f1724;background:var(--bg);-webkit-font-smoothing:antialiased}
/* background large image faint */
body::before{content:"";position:fixed;inset:0;background:url('1763947427555.jpg') center/cover no-repeat;opacity:0.06;z-index:-1;pointer-events:none}
.app{max-width:520px;margin:20px auto;padding:18px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(250,250,252,0.9));border-radius:16px;padding:16px;border:1px solid rgba(2,6,23,0.04);box-shadow:var(--shadow)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.h-title{font-weight:800;font-size:1.2rem}
.h-sub{color:var(--muted);font-size:0.8rem}
.live-badge{background:var(--muted);color:#fff;padding:6px 10px;border-radius:999px;font-weight:800;font-size:0.75rem}
.live-badge.online{background:var(--accent);box-shadow:0 6px 24px rgba(14,165,255,0.08)}
.form-row{display:flex;flex-direction:column;gap:10px;margin-bottom:14px}
.input{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(2,6,23,0.06);background:white}
.btn{width:100%;padding:14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:800;box-shadow:0 10px 30px rgba(14,165,255,0.12);cursor:pointer}
.small{font-size:0.85rem;color:var(--muted);font-weight:700}
.section-head{margin:18px 0 8px;font-weight:800;letter-spacing:1px;color:var(--muted);font-size:0.9rem}
.slot-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.slot{border-radius:14px;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(248,250,252,0.9));border:1px solid rgba(2,6,23,0.04);box-shadow:0 8px 24px rgba(2,6,23,0.04);text-align:center;min-height:150px;position:relative}
.slot.active{border:2px solid rgba(14,165,255,0.12);box-shadow:0 12px 40px rgba(14,165,255,0.06)}
.bat-wrap{width:58px;height:86px;margin:6px auto 8px;position:relative}
.bat-svg{width:100%;height:100%}
.progress{height:8px;border-radius:8px;background:rgba(2,6,23,0.06);overflow:hidden;margin-top:8px}
.progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:8px;box-shadow:0 6px 20px rgba(14,165,255,0.08)}
.slot-user{font-weight:800;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.slot-meta{font-size:0.75rem;color:var(--muted);margin-top:6px}
.slot-controls{margin-top:10px;display:flex;flex-direction:column;gap:8px}
.ctrl{padding:8px;border-radius:8px;border:none;font-weight:800;cursor:pointer}
.ctrl.green{background:var(--accent);color:white}
.ctrl.red{background:var(--danger);color:white}
.admin-area{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
.queue{margin-top:8px}
.q-item{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.92),rgba(248,250,252,0.95));border:1px solid rgba(2,6,23,0.03);margin-bottom:8px}
.q-left{display:flex;gap:12px;align-items:center}
.avatar{width:40px;height:40px;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
.q-plat{font-weight:800}
.q-bat{color:var(--muted);font-size:0.85rem}
.modal-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:white;padding:18px;border-radius:12px;max-width:360px;width:90%}
/* responsive */
@media (max-width:420px){.slot-grid{grid-template-columns:repeat(1,1fr)}.app{padding:12px}}
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <div>
      <div class="h-title">FC Kelapa Gading</div>
      <div class="h-sub">Smart Charging - Antrian</div>
    </div>
    <div id="connStatus" class="live-badge">OFFLINE</div>
  </div>

  <div class="card">
    <div class="form-row">
      <input id="uPlat" class="input" placeholder="Plat Nomor (contoh: B1234XYZ)" style="text-transform:uppercase" />
      <input id="uWa" class="input" placeholder="WhatsApp (628...)" />
      <input id="uBat" class="input" placeholder="Sisa Baterai (%)" />
      <button id="btnDaftar" class="btn">DAFTAR & AKTIFKAN MONITORING</button>
      <div id="monitorStatus" class="small" style="display:none">üîä MONITORING AKTIF ‚Äî audio akan diputar</div>
    </div>

    <div id="adminControls" style="display:none">
      <div class="admin-area">
        <button class="ctrl green" onclick="startAll()">‚ñ∂Ô∏è Mulai Semua</button>
        <button class="ctrl" onclick="stopAll()">‚è∏Ô∏è Stop Semua</button>
        <button class="ctrl" onclick="openBlockPrompt()">üîí Blokir Plat</button>
        <button class="ctrl" onclick="openAddToSlotPrompt()">‚ûï Tambah Ke Slot</button>
        <button class="ctrl" onclick="openAdjustTimerPrompt()">‚è±Ô∏è Adjust Timer</button>
        <button class="ctrl red" onclick="resetAll()">‚ö†Ô∏è Reset Semua</button>
      </div>
    </div>

    <div class="section-head">STATUS CHARGING</div>
    <div id="slots" class="slot-grid">
      <!-- slots injected by script -->
      <div class="slot"><div style="color:var(--muted)">Loading...</div></div>
      <div class="slot"><div style="color:var(--muted)">Loading...</div></div>
      <div class="slot"><div style="color:var(--muted)">Loading...</div></div>
    </div>

    <div class="section-head">LIST ANTRIAN</div>
    <div id="qListContainer" class="queue">
      <div style="text-align:center;color:var(--muted);padding:20px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(248,250,252,0.95));">Belum ada antrian.</div>
    </div>

  </div>

  <div style="text-align:center;margin-top:12px"><button onclick="openAdmin()" class="ctrl">üîí Admin / Operator Login</button></div>

</div>

<!-- modal and admin login -->
<div id="customModal" class="modal-overlay"><div class="modal"><div id="mIcon">üîî</div><h3 id="mTitle">Judul</h3><p id="mDesc"></p><div style="margin-top:10px"><button onclick="closeModal()" class="ctrl">OK</button></div></div></div>
<div id="adminModal" class="modal-overlay"><div class="modal"><h3>Operator Login</h3><input id="adminPin" class="input" placeholder="PIN" style="text-align:center"/><div style="display:flex;gap:8px;margin-top:12px"><button onclick="document.getElementById('adminModal').classList.remove('show')" class="ctrl">Batal</button><button onclick="loginAdmin()" class="ctrl green">MASUK</button></div></div></div>

<script>
// firebase config - keep as before
const firebaseConfig = { apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0", authDomain: "rtomaka-e67b5.firebaseapp.com", projectId: "rtomaka-e67b5", storageBucket: "rtomaka-e67b5.firebasestorage.app", messagingSenderId: "472036722228", appId: "1:472036722228:web:11d520f9204db317d02c61" };
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const SLOT_NAMES = ['SLOT 1','SLOT 2','SLOT 3'];
let chargingSlotsData = [];
let blockedPlates = [];
let isAdmin = false;
let myActiveSlotIndex = -1;
const ZAP_WEBHOOK = 'REPLACE_WITH_YOUR_WEBHOOK_URL';
const keepAliveAudio = document.getElementById('keepAliveAudio') || new Audio();
const alarmAudio = document.getElementById('alarmAudio') || new Audio();

function createSlotHtml(slot, i){
  if(!slot) return `<div class="slot"><div style="color:var(--muted)">KOSONG</div></div>`;
  const isRun = !!slot.startTime;
  const pct = slot.startBattery || 0;
  const target = slot.target || 100;
  const name = slot.name || '-';
  const statusText = isRun ? 'CHARGING' : 'MENUNGGU';
  const activeClass = isRun? 'active': '';
  return `
  <div class="slot ${activeClass}">
    <div class="bat-wrap">
      <svg class="bat-svg" viewBox="0 0 24 44" xmlns="http://www.w3.org/2000/svg">
        <rect x="3" y="6" width="18" height="32" rx="3" fill="none" stroke="rgba(2,6,23,0.06)" stroke-width="1.5"></rect>
        <rect x="7" y="10" width="10" height="24" rx="2" fill="url(#g${i})"></rect>
        <rect x="9" y="3" width="6" height="3" rx="1" fill="rgba(2,6,23,0.06)"></rect>
        <defs>
          <linearGradient id="g${i}" x1="0" x2="1">
            <stop offset="0%" stop-color="var(--accent)" />
            <stop offset="100%" stop-color="var(--accent-2)" />
          </linearGradient>
        </defs>
      </svg>
    </div>
    <div class="slot-user">${name}</div>
    <div class="slot-meta">Batas: ${target}% &nbsp;|&nbsp; Status: ${statusText}</div>
    <div class="progress" aria-hidden><i style="width:${pct}%"></i></div>
    <div class="slot-controls">
      ${isAdmin||true? `<button class="ctrl green" onclick="startCharge(${i})">‚ñ∂Ô∏è Mulai</button>`: ''}
      ${isAdmin||true? `<button class="ctrl" onclick="emptySlot(${i})">‚èπÔ∏è Selesai</button>`: ''}
      ${isAdmin? `<button class="ctrl" onclick="openAdjustSlotPrompt(${i})">‚è±Ô∏è Adjust</button>`: ''}
    </div>
  </div>`;
}

function renderSlots(){
  const el = document.getElementById('slots');
  el.innerHTML = chargingSlotsData.map((s,i)=> createSlotHtml(s,i)).join('');
}

// realtime listener
function initFirebase(){
  const ref = db.collection('antrian').doc('utama');
  db.collection('meta').doc('blocked').get().then(d=>{ if(d.exists) blockedPlates = d.data().plates || [] }).catch(()=>{});
  ref.onSnapshot(snap=>{
    document.getElementById('connStatus').innerText = 'LIVE ‚óè'; document.getElementById('connStatus').classList.add('online');
    const d = snap.data() || {};
    chargingSlotsData = d.chargingSlots || [null,null,null];
    const q = d.waitingQueue || [];
    renderSlots();
    const qc = document.getElementById('qListContainer');
    if(q.length===0) qc.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(248,250,252,0.95));">Antrian Kosong</div>';
    else qc.innerHTML = q.map((x,i)=>`<div class="q-item"><div class="q-left"><div class="avatar">${(x.name||'U').slice(0,1)}</div><div><div class="q-plat">${i+1}. ${x.name}</div><div class="q-bat">Bat: ${x.startBattery}%</div></div></div>${isAdmin?`<div class="q-actions"><button class="adm-mini" onclick="moveQueueToSpecificSlot(${i})">Pindah</button><button class="adm-mini" onclick="deleteQueue(${i})">Hapus</button></div>`:''}</div>`).join('');
  }, err=>{
    console.error('firebase error', err); document.getElementById('connStatus').innerText='ERROR ‚ö†Ô∏è'; document.getElementById('connStatus').classList.add('error');
  });
}

// register
window.addEventListener('load', ()=>{ initFirebase(); if('Notification' in window) Notification.requestPermission(); if(navigator.geolocation) navigator.geolocation.watchPosition(p=>{ /* optional store */ },e=>{}, {enableHighAccuracy:true}); const u = JSON.parse(localStorage.getItem('maka_user')||'null'); if(u && u.plat) document.getElementById('uPlat').value = u.plat; });

// --- basic actions kept ---
function showModal(title,desc){ document.getElementById('mTitle').innerText=title; document.getElementById('mDesc').innerHTML=desc; document.getElementById('customModal').classList.add('show'); }
function closeModal(){ document.getElementById('customModal').classList.remove('show'); }
function openAdmin(){ document.getElementById('adminModal').classList.add('show'); }
function loginAdmin(){ const pin = document.getElementById('adminPin').value; if(pin==='1131'){ isAdmin=true; document.getElementById('adminModal').classList.remove('show'); document.getElementById('adminControls').style.display='block'; showModal('Mode Operator','Anda masuk sebagai Admin'); } else showModal('Error','PIN Salah'); }

function updateDB(callback){ const ref = db.collection('antrian').doc('utama'); db.runTransaction(async t=>{ const doc = await t.get(ref); const newData = callback(doc.data()||{}); t.update(ref,newData); }).catch(e=> showModal('Gagal','Gagal update')) }

function startCharge(i){ updateDB(d=>{ d.chargingSlots = d.chargingSlots || [null,null,null]; if(!d.chargingSlots[i]) return d; d.chargingSlots[i].startTime = d.chargingSlots[i].startTime || new Date().toISOString(); return d; }) }
function emptySlot(i){ if(!confirm('Selesai & Kosongkan Slot?')) return; updateDB(d=>{ d.chargingSlots = d.chargingSlots || [null,null,null]; d.chargingSlots[i]= null; return d; }) }
function deleteQueue(i){ if(!confirm('Hapus?')) return; updateDB(d=>{ d.waitingQueue = d.waitingQueue || []; d.waitingQueue.splice(i,1); return d; }) }

function startAll(){ updateDB(d=>{ d.chargingSlots = (d.chargingSlots||[]).map(s=> s? (s.startTime? s : {...s, startTime: new Date().toISOString()}) : null); return d; }) }
function stopAll(){ updateDB(d=>{ d.chargingSlots = (d.chargingSlots||[]).map(s=> s? ({...s, startTime:null}) : null); return d; }) }
function resetAll(){ if(!confirm('RESET TOTAL? Semua data antrian akan hilang!')) return; db.collection('antrian').doc('utama').set({chargingSlots:[null,null,null], waitingQueue:[]}).then(()=> showModal('Sukses','Data direset')).catch(()=> showModal('Gagal','Reset gagal')) }

// admin assistants
function openBlockPrompt(){ const p = prompt('Plat untuk diblokir (contoh B1234XYZ):'); if(!p) return; blockPlate(p.toUpperCase()); }
function blockPlate(plat){ db.collection('meta').doc('blocked').set({plates: firebase.firestore.FieldValue.arrayUnion(plat)},{merge:true}).then(()=> showModal('Sukses','Plat diblokir')).catch(()=>showModal('Gagal','Gagal blokir')) }
function openAddToSlotPrompt(){ const slotIndex = parseInt(prompt('Slot (1-3):'))-1; if(isNaN(slotIndex)||slotIndex<0||slotIndex>2) return; const plat = prompt('Plat (B1234XYZ)'); if(!plat) return; const phone = prompt('WhatsApp (628...)'); if(!phone) return; const bat = parseInt(prompt('Sisa bat (%)')); if(isNaN(bat)) return; addDirectToSlot(slotIndex,plat.toUpperCase(),phone,bat); }
function addDirectToSlot(idx,plat,phone,bat){ updateDB(d=>{ d.chargingSlots = d.chargingSlots || [null,null,null]; if(d.chargingSlots[idx]) throw 'Slot terisi'; d.chargingSlots[idx] = {name:plat, phone:phone, startBattery:bat, target:100, startTime:null, duration: (100-bat)}; return d; }) }

function openAdjustTimerPrompt(){ const slot = parseInt(prompt('Slot (1-3):'))-1; const rem = parseInt(prompt('Sisa menit yang tampil:')); if(isNaN(slot)||slot<0||slot>2||isNaN(rem)) return; adjustSlotTimer(slot,rem); }
function adjustSlotTimer(i,remainingMinutes){ updateDB(d=>{ d.chargingSlots = d.chargingSlots || [null,null,null]; if(!d.chargingSlots[i]) throw 'Slot kosong'; const duration = d.chargingSlots[i].duration || 0; const now = Date.now(); const end = now + remainingMinutes*60000; const newStart = new Date(end - duration*60000).toISOString(); d.chargingSlots[i].startTime = newStart; return d; }).then(()=> showModal('Sukses','Timer disesuaikan')).catch(e=> showModal('Gagal', String(e))) }

// send zap notification (placeholder)
async function sendZapNotification(phone, plat){ if(!ZAP_WEBHOOK || ZAP_WEBHOOK.startsWith('REPLACE')) return; try{ await fetch(ZAP_WEBHOOK,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({to:phone,message:`Motor ${plat} sudah selesai charging.`})}); }catch(e){console.log('zap error',e)} }

// when a slot finishes (triggered by local user who registered)
let triggeredSet = new Set();
setInterval(()=>{
  (chargingSlotsData||[]).forEach((s,i)=>{
    if(!s || !s.startTime) return;
    const start = new Date(s.startTime).getTime();
    const end = start + ( (s.duration||0) * 60000 );
    const diff = end - Date.now();
    const el = document.querySelectorAll('#slots .slot')[i];
    const timerEl = el && el.querySelector('.slot-meta');
    if(diff <= 0){
      if(el) el.querySelector('.slot-meta').innerText = 'SELESAI!';
      if(!triggeredSet.has(i)){
        triggeredSet.add(i); myActiveSlotIndex = i; triggerFullAlert();
      }
    } else {
      const m = Math.floor(diff/60000); const ssec = Math.floor((diff%60000)/1000);
      if(el) el.querySelector('.slot-meta').innerText = `Sisa ${m}m ${ssec}s`;
      // update progress bar width (assume duration minutes -> percent progress)
      const dur = s.duration||1; const elapsed = Math.max(0, (Date.now()-start)/60000); const pct = Math.min(100, Math.round((elapsed/dur)*100));
      if(el) el.querySelector('.progress > i').style.width = pct + '%';
    }
  })
},1000);

function triggerFullAlert(){ alarmAudio.play().catch(()=>{}); document.getElementById('alarmScreen')?.classList.add('show'); if(myActiveSlotIndex!==-1){ const slot = chargingSlotsData[myActiveSlotIndex]; if(slot && slot.phone) sendZapNotification(slot.phone,slot.name); } }

function stopAlarmAndClear(){ alarmAudio.pause(); document.getElementById('alarmScreen')?.classList.remove('show'); if(myActiveSlotIndex!==-1){ emptySlot(myActiveSlotIndex); localStorage.removeItem('myPlat'); myActiveSlotIndex=-1; } }

</script>
</body>
</html>
