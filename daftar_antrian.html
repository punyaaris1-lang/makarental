<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Antrian FC Public</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link rel="manifest" href="/makarental/manifest.json"> 
    
<style>
/* ================= GLOBAL PREMIUM THEME ================= */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --text:#0f1724; 
    --danger:#ef4444; --success:#10b981; --gold:#fbbf24; 
    --glass-bg:rgba(255,255,255,0.9); 
    --glass-border:rgba(255,255,255,0.7); 
    --glass-shadow:0 6px 20px rgba(0,0,0,0.08); 
    --radius-lg: 20px;
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { margin:0; padding:0; font-family:'Inter', sans-serif; background:var(--bg-base); color:var(--text); min-height:100vh; padding-bottom:100px;}
.app-container { max-width:520px; margin:0 auto; padding:20px; }
.header { text-align:center; margin-bottom:20px; }
.section-title { font-size:1.4em; font-weight:800; margin-top:35px; margin-bottom:15px; border-bottom:3px solid var(--accent); display:inline-block; padding-bottom:5px; }

/* Slot Charger (Premium Model) */
.slot-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(130px, 1fr)); gap:15px; }
.slot-item {
    background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: var(--radius-lg);
    box-shadow: var(--glass-shadow); padding:15px; text-align:center; transition:0.3s;
    display:flex; flex-direction:column; align-items:center; position:relative;
}
.slot-item.occupied { background:#e0f7f7; border-color:var(--accent); }
.slot-item.charging { background:#d4edda; border-color:var(--success); animation: chargePulse 2s infinite alternate; }
.slot-item.my-slot { border:3px solid var(--gold); } /* User sendiri */

@keyframes chargePulse { from { box-shadow: 0 0 0 rgba(16,185,129,0.3); } to { box-shadow: 0 0 15px rgba(16,185,129,0.6); } }

.slot-label { font-size:1.5em; font-weight:900; margin-bottom:5px; color:var(--accent); }
.slot-status { font-size:0.8em; font-weight:600; color:#64748b; min-height:1.2em; }
.slot-plat { font-size:1em; font-weight:800; color:var(--text); margin-top:5px; }
.slot-timestamp { font-size:0.7em; color:#94a3b8; margin-top:3px; }

/* Antrian */
.queue-list { display:flex; flex-direction:column; gap:12px; }
.queue-item {
    display:flex; align-items:center;
    background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px;
    box-shadow: var(--glass-shadow); padding:15px; transition:0.3s;
}
.queue-item.my-queue { border:3px solid var(--gold); }

.queue-number { font-size:1.8em; font-weight:900; color:var(--danger); width:50px; text-align:center; flex-shrink:0; }
.queue-details { flex-grow:1; margin-left:15px; }
.queue-plat { font-size:1.1em; font-weight:800; margin:0; }
.queue-name { font-size:0.8em; color:#64748b; }

/* Tombol */
.btn-primary { background:var(--accent); color:white; padding:12px 20px; border:none; border-radius:12px; font-weight:700; font-size:1em; cursor:pointer; transition:0.2s; box-shadow:0 4px 15px rgba(14,165,166,0.3); }
.btn-primary:active { transform:scale(0.98); }
.btn-danger { background:var(--danger); box-shadow:0 4px 15px rgba(239,68,68,0.3); }

/* Alarm Screen */
#alarmScreen { position:fixed; inset:0; background:rgba(239,68,68,0.95); z-index:1000; display:none; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center; }
#alarmScreen h1 { font-size:3em; margin:0; animation: bounce 1s infinite alternate; }
@keyframes bounce { from { transform:scale(1); } to { transform:scale(1.1); } }
#alarmScreen p { font-size:1.5em; font-weight:700; }

/* Modal Custom (for Admin/etc) */
.modal-overlay {
    position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 1001; transition: opacity 0.3s; opacity: 0;
}
.modal-overlay.show { display: flex; opacity: 1; }
.modal-box { background: white; padding: 25px; border-radius: 20px; max-width: 90%; width: 350px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-title { font-size: 1.2em; font-weight: 800; margin: 10px 0 5px; }
.modal-desc { color: #64748b; margin-bottom: 20px; }
.btn-modal { padding: 10px 15px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin: 5px; }
.btn-confirm { background: var(--accent); color: white; }

/* Admin Controls */
.admin-controls { margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.admin-controls button { padding: 8px 12px; font-size: 0.75em; border-radius: 8px; font-weight: 700; }
.btn-admin-small { background: #fee2e2; color: var(--danger); border: none; }
.btn-admin-action { background: #dbeafe; color: #2563eb; border: none; }
.btn-admin-move { background: var(--gold); color: white; border: none; }
</style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1 style="font-size:1.8em; margin:0; font-weight:900;">‚ö° Antrian Charging FC</h1>
        <p style="color:#64748b; margin:5px 0 0;">MAKA Rental - Full Service Charging</p>
    </div>

    <div id="adminLoginSection" style="margin-bottom:20px; border-top:1px dashed #ddd; padding-top:20px; text-align:center;">
        <h3 id="adminStatus" style="font-size:1em; margin:0 0 10px; font-weight:700; color:#ef4444;">Bukan Admin</h3>
        <input type="password" id="adminPass" placeholder="Admin Passcode" style="padding:10px; border:1px solid #ddd; border-radius:8px; width:200px; margin-right:10px;">
        <button id="btnLoginAdmin" onclick="adminLogin()" class="btn-primary" style="padding:10px 15px; font-size:0.9em;">Login Admin</button>
        <div id="adminControlsGlobal" class="admin-controls" style="display:none; border-top:1px solid #ccc; padding-top:10px;">
            <button onclick="confirmResetQueue()" class="btn-admin-small">RESET SEMUA ANTRIAN</button>
        </div>
    </div>
    
    <h2 class="section-title">Slot Charging Aktif</h2>
    <div id="slotsContainer" class="slot-grid">
        <div class="slot-item">Loading...</div>
    </div>

    <h2 class="section-title">Daftar Antrian</h2>
    <div id="queueContainer" class="queue-list">
        <div style="text-align:center; color:#64748b; padding:20px;">Antrian kosong.</div>
    </div>

    <div id="joinQueueSection" style="text-align:center; margin-top:30px; display:none;">
        <button onclick="joinQueue()" class="btn-primary" style="width:100%;">GABUNG ANTRIAN SEKARANG</button>
    </div>
    
    <div id="leaveQueueSection" style="text-align:center; margin-top:30px; display:none;">
        <button onclick="confirmLeave()" class="btn-primary btn-danger" style="width:100%;">KELUAR DARI ANTRIAN/SLOT</button>
    </div>
</div>

<div id="alarmScreen">
    <h1>üîî</h1>
    <p id="alarmText">Slot Anda telah selesai charging!</p>
    <button onclick="stopAlarmAndClear()" class="btn-modal" style="background:white; color:var(--danger); margin-top:30px;">MATIKAN ALARM</button>
</div>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <span id="mIcon" class="modal-icon" style="font-size:2em;">‚ìò</span>
        <h3 id="mTitle" class="modal-title">Judul</h3>
        <p id="mDesc" class="modal-desc">Deskripsi</p>
        <div id="mBtns">
            <button class="btn-modal btn-confirm" onclick="closeModal()">OK</button>
        </div>
    </div>
</div>

<footer class="bottom-nav">
  </footer>

<audio id="alarmAudio" loop src="1709477026725.mp3" preload="auto"></audio>
<audio id="keepAliveAudio" loop src="1709483325170.mp3" preload="auto"></audio>

<script>
// --- FUNGSI UTILITY COOKIE (untuk Admin Login) ---
// Note: Tetap pakai localStorage untuk currentUser agar tidak merusak sesi global saat ini.
// Tapi untuk admin status, kita pakai localStorage sementara.
function getLocal(key) { return localStorage.getItem(key); }
function setLocal(key, value) { localStorage.setItem(key, value); }
function removeLocal(key) { localStorage.removeItem(key); }

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  // PASTE FIREBASE CONFIG ANDA DI SINI
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const SLOTS_COUNT = 6; // Jumlah slot yang Anda miliki
const slotsRef = db.collection('slots');
const queueRef = db.collection('queue');

let currentUser = JSON.parse(getLocal('maka_user'));
let myActiveSlotIndex = -1;
let myActiveQueueId = null;
let isAdmin = false; // Status Admin

// Audio Controls (Poin 1: Volume Maksimal)
const alarmAudio = document.getElementById('alarmAudio');
const keepAliveAudio = document.getElementById('keepAliveAudio');
alarmAudio.volume = 1.0; // Atur ke volume maksimal
keepAliveAudio.volume = 0.01; // Tetap kecil untuk menjaga PWA tetap aktif (Keep Alive)

// =======================================================
// === FUNGSI UTAMA USER (SLOT & QUEUE) ===
// =======================================================

function renderSlots(slotsData, queueData) {
    const container = document.getElementById('slotsContainer');
    container.innerHTML = '';
    myActiveSlotIndex = -1; // Reset slot index aktif

    for (let i = 0; i < SLOTS_COUNT; i++) {
        const slot = slotsData.find(s => s.index === i) || { index: i, plat: null, charging: false, timestamp: null };
        const isOccupied = slot.plat !== null;
        const isCharging = slot.charging;
        const isMySlot = isOccupied && slot.plat === currentUser.plat;

        if (isMySlot) {
            myActiveSlotIndex = i; // Update status slot aktif user
            if (!isCharging) {
                // Jika sudah di slot tapi tidak charging, tampilkan alarm
                // Ini logika finish charging
                startAlarm(`Slot ${i + 1} Selesai Charge!`);
            } else {
                // Di slot dan sedang charging, matikan alarm
                stopAlarmIfRunning();
            }
        }

        let slotClass = '';
        let statusText = 'KOSONG';
        if (isOccupied) {
            slotClass = 'occupied';
            statusText = isCharging ? 'CHARGING AKTIF' : 'SELESAI/STANDBY';
        }

        const timeString = slot.timestamp ? new Date(slot.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }) : '';

        // Tampilan Admin Controls
        let adminControlsHTML = '';
        if (isAdmin) {
            const btnDelete = `<button class="btn-admin-small" onclick="confirmDelete('slot', ${i})">HAPUS</button>`;
            const btnStartStop = isCharging
                ? `<button class="btn-admin-small" onclick="adminStopCharging(${i})">STOP CHARGE</button>`
                : `<button class="btn-admin-action" onclick="adminStartCharging(${i})">MULAI CHARGE</button>`;
            
            const btnEmpty = isOccupied ? `<button class="btn-admin-small" onclick="emptySlot(${i})">KOSONGKAN</button>` : '';

            adminControlsHTML = `
                <div class="admin-controls">
                    ${isOccupied ? btnStartStop + btnEmpty : ''}
                </div>
            `;
        }

        container.innerHTML += `
            <div id="slot-${i}" class="slot-item ${slotClass} ${isCharging ? 'charging' : ''} ${isMySlot ? 'my-slot' : ''}">
                <div class="slot-label">Slot ${i + 1}</div>
                <div class="slot-status" style="color:${isCharging ? var('--success') : '#64748b'}">${statusText}</div>
                <div class="slot-plat">${slot.plat || '-'}</div>
                <div class="slot-timestamp">${isOccupied ? slot.name : ''} ${timeString}</div>
                ${adminControlsHTML}
            </div>
        `;
    }
    updateActionButtons(queueData.length);
}

function renderQueue(queueData) {
    const container = document.getElementById('queueContainer');
    container.innerHTML = '';
    myActiveQueueId = null; // Reset ID antrian aktif

    if (queueData.length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#64748b; padding:20px; background:var(--glass-bg); border-radius:var(--radius-lg);">Antrian kosong. Mari bergabung!</div>`;
    } else {
        queueData.forEach((item, index) => {
            const isMyQueue = item.plat === currentUser.plat;
            if (isMyQueue) { myActiveQueueId = item.id; }
            
            // Tampilan Admin Controls
            let adminControlsHTML = '';
            if (isAdmin) {
                const moveButtons = Array.from({ length: SLOTS_COUNT }, (_, i) => 
                    `<button class="btn-admin-move" onclick="confirmMoveToSlot('${item.id}', ${i})">Pindah ke Slot ${i + 1}</button>`
                ).join('');
                
                adminControlsHTML = `
                    <div class="admin-controls">
                        ${moveButtons}
                        <button class="btn-admin-small" onclick="confirmDelete('queue', '${item.id}')">HAPUS ANTRIAN</button>
                    </div>
                `;
            }

            container.innerHTML += `
                <div class="queue-item ${isMyQueue ? 'my-queue' : ''}">
                    <div class="queue-number">${index + 1}</div>
                    <div class="queue-details">
                        <p class="queue-plat">${item.plat}</p>
                        <p class="queue-name">${item.name}</p>
                    </div>
                    ${adminControlsHTML}
                </div>
            `;
        });
    }
    updateActionButtons(queueData.length);
}

function updateActionButtons(queueLength) {
    const inSlotOrQueue = myActiveSlotIndex !== -1 || myActiveQueueId !== null;
    document.getElementById('joinQueueSection').style.display = inSlotOrQueue ? 'none' : 'block';
    document.getElementById('leaveQueueSection').style.display = inSlotOrQueue ? 'block' : 'none';
    
    // Auto-alert jika antrian penuh dan bukan user admin
    if (queueLength >= SLOTS_COUNT * 2 && myActiveSlotIndex === -1 && myActiveQueueId === null && !isAdmin) {
        showModal("‚ö†Ô∏è Antrian Penuh", "Antrian dan slot sedang penuh. Coba lagi nanti.", "warning");
    }
}

// =======================================================
// === USER ACTIONS ===
// =======================================================

function joinQueue() {
    // 1. Cek apakah ada slot kosong
    slotsRef.get().then(snap => {
        const slotsData = snap.docs.map(doc => doc.data());
        const occupiedCount = slotsData.filter(s => s.plat !== null).length;
        
        if (occupiedCount < SLOTS_COUNT) {
            // Ada slot kosong, pindah ke slot
            const firstEmptyIndex = Array.from({ length: SLOTS_COUNT }, (_, i) => i).find(i => !slotsData.find(s => s.index === i));
            
            showModal("Slot Tersedia", `Slot ${firstEmptyIndex + 1} tersedia. Anda akan masuk ke Slot ${firstEmptyIndex + 1}.`, "confirm", () => {
                moveToSlot(firstEmptyIndex, 'user_join');
            });
            return;
        }

        // 2. Jika slot penuh, gabung antrian
        queueRef.get().then(qSnap => {
            const queueLength = qSnap.size;
            if (queueLength >= SLOTS_COUNT * 2) {
                showModal("Antrian Penuh", "Antrian sudah terlalu panjang. Coba lagi nanti.", "error");
                return;
            }
            
            const newQueueItem = {
                plat: currentUser.plat,
                name: currentUser.nama,
                timestamp: Date.now(),
                order: queueLength + 1
            };

            queueRef.add(newQueueItem).then(docRef => {
                showModal("Antrian Berhasil", `Anda berada di antrian ke ${queueLength + 1}. Mohon tunggu notifikasi slot tersedia.`, "success");
            }).catch(e => showModal("Error", "Gagal bergabung antrian: " + e.message, "error"));
        });
    });
}

function confirmLeave() {
    showModal("Konfirmasi", "Anda yakin ingin keluar dari Slot/Antrian?", "confirm", leaveQueue);
}

function leaveQueue() {
    if (myActiveSlotIndex !== -1) {
        // Keluar dari Slot
        emptySlot(myActiveSlotIndex, true);
    } else if (myActiveQueueId !== null) {
        // Keluar dari Antrian
        queueRef.doc(myActiveQueueId).delete().then(() => {
            myActiveQueueId = null;
            showModal("Keluar Sukses", "Berhasil keluar dari antrian.", "success");
        }).catch(e => showModal("Error", "Gagal keluar antrian: " + e.message, "error"));
    }
}

// Function to put motorcycle into a slot (Used by User and Admin)
function moveToSlot(slotIndex, source = 'admin') {
    const newSlotData = {
        index: slotIndex,
        plat: currentUser.plat,
        name: currentUser.nama,
        charging: source === 'user_join' ? true : false, // User yang join slot langsung charging
        timestamp: Date.now()
    };

    slotsRef.doc('slot_' + slotIndex).set(newSlotData).then(() => {
        // Jika asalnya dari queue, hapus dari queue
        if (myActiveQueueId !== null) {
             queueRef.doc(myActiveQueueId).delete().then(() => { myActiveQueueId = null; });
        }
        showModal("Masuk Slot Sukses", `Motor Anda masuk Slot ${slotIndex + 1}. Charging: ${newSlotData.charging ? 'Aktif' : 'Standby'}.`, "success");
    }).catch(e => showModal("Error", "Gagal masuk slot: " + e.message, "error"));
}

// Function to empty a slot (Used by User and Admin)
function emptySlot(slotIndex, isUserLeaving = false) {
    const emptyData = {
        index: slotIndex,
        plat: null,
        name: null,
        charging: false,
        timestamp: null
    };

    slotsRef.doc('slot_' + slotIndex).set(emptyData).then(() => {
        if (isUserLeaving) {
            myActiveSlotIndex = -1;
            stopAlarmIfRunning();
        }
        
        // Cek antrian, jika ada, pindahkan antrian pertama ke slot kosong ini.
        queueRef.orderBy('timestamp').limit(1).get().then(snap => {
            if (!snap.empty) {
                const nextInQueue = snap.docs[0];
                const data = nextInQueue.data();
                
                // NOTIFIKASI OTOMATIS KE USER ANTRIAN BERIKUTNYA
                // Di sini Anda perlu sistem notifikasi yang kompleks (FCM)
                // Untuk sementara, kita hanya jalankan fungsi move otomatis
                
                // Pindah ke slot baru
                slotsRef.doc('slot_' + slotIndex).set({
                    index: slotIndex,
                    plat: data.plat,
                    name: data.name,
                    charging: false,
                    timestamp: Date.now()
                }).then(() => {
                    nextInQueue.ref.delete(); // Hapus dari antrian
                    if (isUserLeaving) {
                         showModal("Slot Kosong", `Slot ${slotIndex + 1} dikosongkan. Antrian berikutnya masuk slot.`, "success");
                    }
                });
            } else if (isUserLeaving) {
                showModal("Slot Kosong", `Slot ${slot + 1} dikosongkan. Antrian kosong.`, "success");
            }
        });
    }).catch(e => showModal("Error", "Gagal mengosongkan slot: " + e.message, "error"));
}

// =======================================================
// === ADMIN ACTIONS (POIN 4) ===
// =======================================================

function adminLogin() {
    const pass = document.getElementById('adminPass').value;
    const adminCode = "MAKAADMIN123"; // GANTI DENGAN KODE RAHASIA ANDA

    if (pass === adminCode) {
        isAdmin = true;
        setLocal('maka_is_admin', 'true');
        document.getElementById('adminStatus').innerText = "‚úÖ Admin Aktif";
        document.getElementById('adminStatus').style.color = var('--success');
        document.getElementById('adminLoginSection').style.display = 'none';
        document.getElementById('adminControlsGlobal').style.display = 'flex';
        renderListeners(); // Render ulang untuk menampilkan tombol admin
    } else {
        showModal("Gagal Login", "Passcode Admin salah.", "error");
    }
}

// Global Reset
function confirmResetQueue() {
    showModal("‚ö†Ô∏è Reset Antrian", "Yakin ingin MENGHAPUS SEMUA motor di DAFTAR ANTRIAN? Slot Charging TIDAK akan di-reset.", "confirm", resetQueue);
}
function resetQueue() {
    queueRef.get().then(snap => {
        const batch = db.batch();
        snap.docs.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
    }).then(() => {
        showModal("Reset Sukses", "Semua antrian telah dihapus.", "success");
    }).catch(e => showModal("Error", "Gagal reset antrian: " + e.message, "error"));
}

// Slot Controls
function adminStartCharging(slotIndex) {
    slotsRef.doc('slot_' + slotIndex).update({ charging: true }).then(() => {
        showModal("Sukses", `Slot ${slotIndex + 1} mulai charging.`, "success");
    }).catch(e => showModal("Error", "Gagal mulai charging: " + e.message, "error"));
}

function adminStopCharging(slotIndex) {
    slotsRef.doc('slot_' + slotIndex).update({ charging: false }).then(() => {
        showModal("Sukses", `Slot ${slotIndex + 1} berhenti charging (Standby).`, "success");
    }).catch(e => showModal("Error", "Gagal stop charging: " + e.message, "error"));
}

// Queue Controls - Delete
function confirmDelete(type, id) {
    showModal("‚ö†Ô∏è Hapus Motor", `Yakin ingin menghapus motor ini dari ${type === 'slot' ? 'Slot ' + (id + 1) : 'Antrian'}?`, "confirm", () => {
        if (type === 'slot') { emptySlot(id); } // Gunakan emptySlot untuk Slot
        else if (type === 'queue') { queueRef.doc(id).delete().then(() => showModal("Sukses", "Antrian dihapus.", "success")); }
    });
}

// Queue Controls - Move
function confirmMoveToSlot(queueId, slotIndex) {
    showModal("Konfirmasi Pindah", `Pindahkan motor antrian ke Slot ${slotIndex + 1}?`, "confirm", () => {
        queueRef.doc(queueId).get().then(doc => {
            const data = doc.data();
            const newSlotData = {
                index: slotIndex,
                plat: data.plat,
                name: data.name,
                charging: true,
                timestamp: Date.now()
            };
            
            // 1. Tulis ke Slot
            slotsRef.doc('slot_' + slotIndex).set(newSlotData).then(() => {
                // 2. Hapus dari Antrian
                doc.ref.delete().then(() => {
                    showModal("Pindah Sukses", `Motor ${data.plat} dipindah ke Slot ${slotIndex + 1} dan mulai charging.`, "success");
                });
            });
        }).catch(e => showModal("Error", "Gagal memindahkan: " + e.message, "error"));
    });
}

// =======================================================
// === ALARM & MODAL ===
// =======================================================

function startAlarm(text) {
    if (alarmAudio.paused) {
        keepAliveAudio.pause(); // Matikan keep alive
        alarmAudio.play(); 
        document.getElementById('alarmText').innerText = text;
        document.getElementById('alarmScreen').style.display='flex';
        if(navigator.vibrate) navigator.vibrate([1000,500,1000]);
        // Tampilkan notifikasi (standar browser)
        if(Notification.permission==="granted") new Notification("SELESAI!", {body:text, tag:"alarm", icon:"/makarental/icon-512.png"});
    }
}

function stopAlarmIfRunning() {
    if (!alarmAudio.paused) {
        stopAlarmAndClear();
    }
}

// STOP ALARM & AUTO-CLEAR SLOT
function stopAlarmAndClear() {
    alarmAudio.pause(); 
    alarmAudio.currentTime=0;
    document.getElementById('alarmScreen').style.display='none';
    keepAliveAudio.play(); // Balik ke mode standby
    
    // Auto kosongkan slot milik user
    if (myActiveSlotIndex !== -1) {
        emptySlot(myActiveSlotIndex, true); // True untuk isUserLeaving=true
        myActiveSlotIndex = -1;
    }
}

// HELPER MODAL
function showModal(title, desc, type="info", onConfirm) {
    document.getElementById('mTitle').innerText = title;
    document.getElementById('mDesc').innerHTML = desc;
    
    let icon = "‚ìò";
    let btnHTML = `<button class="btn-modal btn-confirm" onclick="closeModal()">OK</button>`;

    if (type === "confirm") {
        icon = "‚ùì";
        btnHTML = `
            <button class="btn-modal" onclick="closeModal()" style="background:#eee;color:#555">Batal</button>
            <button class="btn-modal btn-confirm" style="background:var(--danger);color:white" onclick="closeModal(); ${onConfirm.name}()">${onConfirm.name.includes('Delete') || onConfirm.name.includes('Reset') ? 'YA, HAPUS' : 'YA, LANJUT'}</button>
        `;
    } else if (type === "success") {
        icon = "‚úÖ";
    } else if (type === "error") {
        icon = "‚ùå";
    } else if (type === "warning") {
        icon = "‚ö†Ô∏è";
    }

    document.getElementById('mIcon').innerText = icon;
    document.getElementById('mBtns').innerHTML = btnHTML;
    document.getElementById('customModal').classList.add('show');
}
function closeModal() { document.getElementById('customModal').classList.remove('show'); }

// =======================================================
// === FIREBASE LISTENERS & INIT ===
// =======================================================

function renderListeners() {
    // 1. Cek Admin Status
    isAdmin = getLocal('maka_is_admin') === 'true';
    if(isAdmin) {
        document.getElementById('adminStatus').innerText = "‚úÖ Admin Aktif";
        document.getElementById('adminStatus').style.color = var('--success');
        document.getElementById('adminLoginSection').style.display = 'none';
        document.getElementById('adminControlsGlobal').style.display = 'flex';
    }

    // 2. Load Slot & Queue Data (Listener Real-time)
    slotsRef.onSnapshot(slotsSnap => {
        const slotsData = slotsSnap.docs.map(doc => doc.data());
        
        queueRef.orderBy('timestamp').onSnapshot(queueSnap => {
            const queueData = queueSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            renderSlots(slotsData, queueData);
            renderQueue(queueData);
            
            // Cek apakah antrian pertama bisa masuk slot kosong
            // Ini untuk Admin/Sistem Otomatis (di luar lingkup user)
        });
    }, error => console.error("Error fetching slots:", error));
    
    // 3. Keep Alive Audio
    keepAliveAudio.play().catch(e => console.log('Keep Alive Blocked:', e));
}

document.addEventListener("DOMContentLoaded", function() {
    if(!currentUser) { window.location.href='index.html'; return; }
    
    // Minta izin Notifikasi (agar bisa tampil di PWA)
    if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Notification.requestPermission();
    }
    
    renderListeners();
});
</script>
</body>
</html>
