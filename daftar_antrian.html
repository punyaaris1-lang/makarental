<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Antrian FC Public</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* --- GLOBAL THEME PREMIUM --- */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --accent-2:#06b6d4; --text:#0f1724; 
    --muted:#64748b; --danger:#ef4444; --success:#10b981; --gold:#fbbf24; 
    --glass-bg:rgba(255,255,255,0.65); --glass-border:rgba(255,255,255,0.4); 
    --glass-shadow:0 8px 32px 0 rgba(31,38,135,0.15); --backdrop-blur:blur(12px); 
    --radius-lg:24px; --max-width:520px; 
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { margin:0; padding:0; font-family:'Inter', sans-serif; background:var(--bg-base); color:var(--text); min-height:100vh; position:relative; overflow-x:hidden; }
body::before { content:""; position:fixed; top:0; left:0; right:0; bottom:0; background:url('1763947427555.jpg') center/cover no-repeat; opacity:0.15; z-index:-1; pointer-events:none; }
.app-container { max-width:var(--max-width); margin:0 auto; padding:20px 20px 50px; }

/* HEADER */
.header { margin-bottom:24px; display:flex; align-items:center; justify-content:space-between; }
.header h1 { font-family:'Inter'; font-size:1.6em; font-weight:800; margin:0; color:var(--text); line-height:1; }
.header p { color:var(--muted); font-size:0.8em; margin:4px 0 0; font-weight:600; }
.live-badge { background:var(--muted); color:white; font-weight:800; font-size:0.65em; padding:6px 12px; border-radius:20px; transition:0.3s; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
.live-badge.online { background:var(--success); animation:pulseGreen 2s infinite; }
@keyframes pulseGreen { 0%{box-shadow:0 0 0 0 rgba(16,185,129,0.7)} 70%{box-shadow:0 0 0 10px rgba(16,185,129,0)} 100%{box-shadow:0 0 0 0 rgba(16,185,129,0)} }

/* SLOT SYSTEM */
.slot-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:24px; }
.slot-card { background:var(--glass-bg); backdrop-filter:var(--backdrop-blur); border:1px solid var(--glass-border); border-radius:20px; padding:15px 5px; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:space-between; min-height:180px; position:relative; overflow:hidden; box-shadow:var(--glass-shadow); transition:0.3s; }
.slot-card.active { background:rgba(255,255,255,0.9); border-color:var(--accent); box-shadow:0 0 25px rgba(14,165,166,0.3); }
.slot-label { font-size:0.65em; font-weight:700; color:var(--muted); margin-bottom:8px; letter-spacing:1px; }
.bat-body { width:34px; height:60px; border:2px solid #cbd5e1; border-radius:8px; position:relative; display:flex; align-items:flex-end; padding:3px; background:rgba(255,255,255,0.5); margin-bottom:8px; }
.bat-head { width:12px; height:3px; background:#cbd5e1; position:absolute; top:-5px; left:50%; transform:translateX(-50%); border-radius:2px 2px 0 0; }
.bat-liquid { width:100%; background:linear-gradient(to top,var(--accent),var(--accent-2)); border-radius:4px; transition:height 0.5s; box-shadow:0 0 15px rgba(14,165,166,0.4); }
.slot-user { font-family:'Inter'; font-weight:800; font-size:0.8em; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
.slot-status { font-size:0.6em; font-weight:700; padding:4px 6px; border-radius:6px; margin-top:4px; }
.st-ready { color:var(--success); background:rgba(16,185,129,0.1); } .st-charging { color:var(--accent); background:rgba(14,165,166,0.1); } .st-waiting { color:var(--gold); background:rgba(251,191,36,0.1); }

/* ADMIN BUTTONS INSIDE SLOT */
.adm-slot-btn { width:90%; padding:6px; font-size:0.6em; border-radius:6px; border:none; margin-top:5px; font-weight:800; cursor:pointer; }
.adm-red { background:#fee2e2; color:red; } .adm-green { background:#d1fae5; color:#047857; }

/* QUEUE LIST */
.queue-list { background:var(--glass-bg); backdrop-filter:var(--backdrop-blur); border-radius:20px; padding:10px; margin-bottom:24px; border:1px solid var(--glass-border); max-height:250px; overflow-y:auto; }
.q-item { display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid rgba(0,0,0,0.05); font-size:0.9em; } 
.q-item:last-child { border-bottom:none; }
.q-plat { font-weight:700; } .q-bat { color:var(--muted); font-size:0.8em; }
.q-actions { display:flex; gap:5px; } 
.adm-mini { padding:4px 8px; font-size:0.6em; border-radius:4px; border:none; font-weight:bold; cursor:pointer; }

/* FORM */
.reg-card { background:var(--glass-bg); backdrop-filter:var(--backdrop-blur); border-radius:24px; padding:24px; box-shadow:var(--glass-shadow); border:1px solid var(--glass-border); }
.form-input { width:100%; padding:14px; border:1px solid #e2e8f0; border-radius:12px; margin-bottom:12px; font-family:'Inter'; font-size:1em; background:rgba(255,255,255,0.8); outline:none; transition:0.2s; }
.form-input:focus { border-color:var(--accent); background:#fff; }
.btn-submit { width:100%; padding:16px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; border:none; border-radius:16px; font-weight:800; font-size:1em; cursor:pointer; box-shadow:0 10px 20px rgba(14,165,166,0.2); transition:0.2s; font-family:'Inter'; }
.btn-submit:active { transform:scale(0.98); } .btn-submit:disabled { background:#cbd5e1; box-shadow:none; }

/* ALARM SCREEN */
.alarm-overlay { position:fixed; inset:0; background:rgba(220,20,60,0.98); z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; color:white; animation:shake 0.5s infinite; }
@keyframes shake { 0%{transform:translate(1px,1px)} 50%{transform:translate(-1px,-1px)} 100%{transform:translate(1px,-1px)} }
.btn-stop { background:white; color:red; border:none; padding:20px 50px; border-radius:50px; font-weight:900; font-size:1.5em; cursor:pointer; box-shadow:0 0 30px rgba(255,255,255,0.8); margin-top:40px; }

/* MODAL OVERLAY (GLOBAL) */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:9999; display:none; align-items:center; justify-content:center; opacity:0; transition:opacity 0.3s; }
.modal-overlay.show { display:flex; opacity:1; }
.modal-box { background:white; padding:25px; border-radius:24px; width:85%; max-width:320px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); transform:scale(0.9); transition:0.3s; }
.modal-overlay.show .modal-box { transform:scale(1); }
.modal-icon { font-size:40px; margin-bottom:15px; display:block; }
.modal-title { font-family:'Inter'; font-size:1.3em; font-weight:800; margin:0 0 10px; color:var(--text); }
.modal-desc { font-size:0.9em; color:#64748b; line-height:1.5; margin-bottom:20px; }
.modal-btns { display:flex; gap:10px; justify-content:center; }
.btn-modal { flex:1; padding:12px; border-radius:12px; border:none; font-weight:700; cursor:pointer; font-size:0.9em; }
.btn-confirm { background:var(--text); color:white; }
.btn-cancel { background:#f1f5f9; color:#64748b; }

/* NAV */
footer.bottom-nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:auto; min-width:280px; background:rgba(255,255,255,0.9); backdrop-filter:blur(20px); border-radius:999px; padding:12px 30px; display:flex; justify-content:space-between; align-items:center; gap:30px; box-shadow:0 10px 40px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.5); z-index:999; }
.nav-item { display:flex; flex-direction:column; align-items:center; text-decoration:none; color:#94a3b8; font-size:10px; font-weight:700; transition:0.2s; }
.nav-item span { font-size:20px; margin-bottom:2px; } .nav-item.active { color:var(--accent); }
</style>
</head>
<body>

<audio id="silentAudio" loop><source src="data:audio/mp3;base64,//uQxAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq" type="audio/mp3"></audio>
<audio id="alarmAudio" loop><source src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" type="audio/mp3"></audio>

<div id="alarmScreen" class="alarm-overlay">
    <div style="font-size:100px;">‚ö°</div>
    <h1 style="font-family:'Inter'; font-size:3em; margin:0; text-shadow:0 0 20px black;">SELESAI!</h1>
    <p style="font-size:1.5em; max-width:80%;">Giliran Anda / Baterai Penuh</p>
    <button class="btn-stop" onclick="stopAlarm()">MATIKAN ALARM</button>
</div>

<div class="app-container">
    <header class="header">
        <div class="header-text">
            <h1>FC Kelapa Gading</h1>
            <p>Real-time Queue System</p>
        </div>
        <div id="connStatus" class="live-badge">OFFLINE</div>
    </header>

    <div class="slot-grid" id="slots">
        <div class="slot-card"><div class="slot-status">Loading...</div></div>
        <div class="slot-card"><div class="slot-status">Loading...</div></div>
        <div class="slot-card"><div class="slot-status">Loading...</div></div>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="margin:0; font-family:'Inter'; color:var(--text); font-weight:800;">Daftar Tunggu</h3>
        <span id="qCount" style="background:var(--text); color:white; padding:2px 8px; border-radius:10px; font-size:0.8em; font-weight:bold;">0</span>
    </div>
    
    <div class="queue-list" id="qListContainer">
        <div style="text-align:center;padding:20px;color:#999;font-size:0.8em;">Belum ada antrian.</div>
    </div>

    <div class="reg-card">
        <h3 style="margin:0 0 16px 0;font-family:'Inter';font-weight:800;font-size:1.2em;">Ambil Antrian</h3>
        <input id="uPlat" class="form-input" placeholder="Plat Nomor" style="text-transform:uppercase;">
        <input id="uWa" type="number" class="form-input" placeholder="WhatsApp">
        <input id="uBat" type="number" class="form-input" placeholder="Sisa Baterai (%)">
        
        <button id="btnDaftar" class="btn-submit">DAFTAR & AKTIFKAN MONITORING</button>
        
        <p id="monitorStatus" style="text-align:center; font-size:0.75em; color:var(--success); font-weight:700; margin-top:15px; display:none; background:#ecfdf5; padding:10px; border-radius:10px; border:1px solid #10b981;">
            üîä <b>MONITORING AKTIF</b><br>Jangan tutup tab ini.
        </p>
    </div>

    <div style="text-align:center; margin-top:40px;">
        <span onclick="openAdmin()" style="font-size:0.7em; color:#ccc; cursor:pointer;">üîí Admin Login</span>
    </div>
    
    <div id="adminResetArea" style="display:none; text-align:center; margin-top:20px;">
        <button onclick="resetAll()" style="background:#fee2e2; color:red; border:1px solid red; padding:10px; border-radius:10px; font-weight:bold; font-size:0.8em;">‚ö†Ô∏è RESET SEMUA DATA</button>
    </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item active"><span>üé´</span>Antrian</a>
</footer>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <span id="mIcon" class="modal-icon">üîî</span>
        <h3 id="mTitle" class="modal-title">Judul</h3>
        <p id="mDesc" class="modal-desc">Keterangan...</p>
        <div id="mBtns" class="modal-btns"></div>
    </div>
</div>

<div id="adminModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Operator Login</h3>
        <input type="password" id="adminPin" class="form-input" placeholder="PIN" style="text-align:center;">
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button onclick="document.getElementById('adminModal').classList.remove('show')" class="btn-modal btn-cancel">Batal</button>
            <button class="btn-modal btn-confirm" onclick="loginAdmin()">MASUK</button>
        </div>
    </div>
</div>

<script>
// --- FIREBASE CONFIG (PASTE PUNYA ANDA) ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- VARIABLES ---
const SLOT_NAMES = ["SLOT 3", "SLOT 2", "SLOT 1"];
const STATION_LOC = { lat: -6.171583, lng: 106.899844 }; 
const MAX_DIST = 200; 
let isAdmin = false;
let userLat=null;
let triggered = new Set();

const silentAudio = document.getElementById('silentAudio');
const alarmAudio = document.getElementById('alarmAudio');

window.addEventListener('load', () => {
    initFirebase();
    if("Notification" in window) Notification.requestPermission();
    if(navigator.geolocation) navigator.geolocation.watchPosition(p=>{ userLat=p.coords.latitude; }, e=>{}, {enableHighAccuracy:true});
    
    // Auto fill user
    const u = JSON.parse(localStorage.getItem('maka_user'));
    if(u && u.plat) document.getElementById('uPlat').value = u.plat;
});

// --- MODAL HELPER ---
function showModal(title, desc, onOk) {
    document.getElementById('mTitle').innerText = title;
    document.getElementById('mDesc').innerHTML = desc;
    document.getElementById('mIcon').innerText = "‚ìò";
    const btns = document.getElementById('mBtns');
    btns.innerHTML = `<button class="btn-modal btn-confirm" onclick="closeModal()">OK</button>`;
    if(onOk) btns.querySelector('button').onclick = function(){ closeModal(); onOk(); };
    document.getElementById('customModal').classList.add('show');
}
function closeModal() { document.getElementById('customModal').classList.remove('show'); }

// --- FIREBASE LOGIC ---
function initFirebase() {
    const ref = db.collection("antrian").doc("utama");
    ref.onSnapshot(snap => {
        document.getElementById('connStatus').innerText = "LIVE ‚óè";
        document.getElementById('connStatus').classList.add('online');

        const d = snap.data() || {};
        const s = d.chargingSlots || [null,null,null];
        const q = d.waitingQueue || [];
        const myPlat = localStorage.getItem('myPlat') || "";

        document.getElementById('qCount').innerText = q.length;

        // RENDER SLOTS
        document.getElementById('slots').innerHTML = s.map((x,i) => {
            if(!x) return `
            <div class="slot-card">
                <div class="slot-label">${SLOT_NAMES[i]}</div>
                <div class="bat-body"><div class="bat-head"></div><div class="bat-liquid" style="height:0%"></div></div>
                <div class="slot-user">-</div>
                <div class="slot-status st-ready">KOSONG</div>
            </div>`;

            const isRun = !!x.startTime;
            let txt = isRun ? "MENGISI" : "MENUNGGU";
            let css = isRun ? "st-charging" : "st-waiting";
            let h = x.startBattery;
            let adminControls = "";

            if(isRun) {
                let start = x.startTime.toMillis ? x.startTime.toMillis() : new Date(x.startTime).getTime();
                let end = start + (x.duration*60000);
                if(Date.now() > end) {
                    txt = "SELESAI"; css = "st-ready";
                    if(!triggered.has(x.name) && myPlat === x.name) {
                        triggered.add(x.name); triggerFullAlert();
                    }
                } else {
                    h = 100;
                }
            }

            // IF ADMIN: SHOW BUTTONS
            if(isAdmin) {
                if(isRun) {
                    adminControls = `<button class="adm-slot-btn adm-red" onclick="emptySlot(${i})">KOSONGKAN / SELESAI</button>`;
                } else {
                    adminControls = `<button class="adm-slot-btn adm-green" onclick="startCharge(${i})">MULAI CAS</button>
                                     <button class="adm-slot-btn adm-red" onclick="emptySlot(${i})">BATAL</button>`;
                }
            }

            return `
            <div class="slot-card ${isRun?'active':''}">
                <div class="slot-label">${SLOT_NAMES[i]}</div>
                <div class="bat-body"><div class="bat-head"></div><div class="bat-liquid" style="height:${h}%"></div></div>
                <div class="slot-user">${x.name}</div>
                <div class="slot-status ${css}">${txt}</div>
                ${adminControls}
            </div>`;
        }).join('');

        // RENDER QUEUE
        const qc = document.getElementById('qListContainer');
        if(q.length===0) {
            qc.innerHTML = '<div style="text-align:center;color:#999;font-size:0.8em;padding:20px;">Antrian Kosong</div>';
        } else {
            qc.innerHTML = q.map((x,i) => {
                let adminActs = "";
                if(isAdmin) {
                    adminActs = `
                    <div class="q-actions">
                        <button class="adm-mini adm-green" style="background:#d1fae5;color:#047857;" onclick="moveQueueToSlot(${i})">MASUKKAN</button>
                        <button class="adm-mini adm-red" style="background:#fee2e2;color:red;" onclick="deleteQueue(${i})">HAPUS</button>
                    </div>`;
                }
                return `
                <div class="q-item">
                    <div><div class="q-plat">${i+1}. ${x.name}</div><div class="q-bat">Bat: ${x.startBattery}%</div></div>
                    ${adminActs}
                </div>`;
            }).join('');
        }
    });

    // DAFTAR USER
    document.getElementById('btnDaftar').onclick = () => {
        const p = document.getElementById('uPlat').value.toUpperCase().trim();
        const w = document.getElementById('uWa').value;
        const b = parseInt(document.getElementById('uBat').value);
        const btn = document.getElementById('btnDaftar');

        if(!p || !w || isNaN(b)) return showModal('Error', 'Lengkapi data!');
        
        silentAudio.play().then(()=>{
            document.getElementById('monitorStatus').style.display='block';
            if('wakeLock' in navigator) navigator.wakeLock.request('screen');
        }).catch(e=>console.log("Audio blocked", e));

        btn.disabled=true; btn.innerText="MEMPROSES...";

        if(!userLat && !isAdmin) { 
            btn.disabled=false; btn.innerText="DAFTAR";
            showModal('GPS Diperlukan', 'Mohon aktifkan GPS untuk mendaftar.'); return;
        }

        db.runTransaction(async t => {
            const d = (await t.get(ref)).data() || {};
            let s = d.chargingSlots || [null,null,null];
            let q = d.waitingQueue || [];
            if(s.some(x=>x?.name===p) || q.some(x=>x?.name===p)) throw "Sudah terdaftar.";
            
            // Auto Masuk Slot jika kosong
            let empty = s.findIndex(x => !x);
            if(empty !== -1) {
                s[empty] = { name:p, phone:w, startBattery:b, target:100, startTime:null, duration:(100-b)*1.5 };
            } else {
                q.push({ name:p, phone:w, startBattery:b, target:100, duration:0 });
            }
            t.set(ref, {chargingSlots:s, waitingQueue:q}, {merge:true});
        }).then(() => {
            localStorage.setItem('myPlat', p);
            btn.innerText = "MONITORING AKTIF";
            showModal("Berhasil Masuk Antrian", "<b>Monitoring Aktif!</b><br>Alarm akan berbunyi saat giliran Anda tiba. Jangan tutup tab ini.");
        }).catch(e => {
            showModal("Gagal", e); btn.disabled=false; btn.innerText="DAFTAR";
        });
    };
}

// --- ADMIN LOGIC ---
function openAdmin() { document.getElementById('adminModal').classList.add('show'); }
function loginAdmin() {
    if(document.getElementById('adminPin').value === '1131') {
        isAdmin = true;
        document.getElementById('adminModal').classList.remove('show');
        document.getElementById('adminResetArea').style.display='block';
        showModal("Mode Operator", "Anda masuk sebagai Admin.");
        // Trigger re-render
        const ref = db.collection("antrian").doc("utama");
        ref.get(); 
    } else {
        showModal("Error", "PIN Salah");
    }
}

// Admin Actions
function emptySlot(i) {
    if(!confirm("Kosongkan slot ini?")) return;
    updateDB(d => { d.chargingSlots[i] = null; return d; });
}
function startCharge(i) {
    updateDB(d => { d.chargingSlots[i].startTime = new Date().toISOString(); return d; });
}
function moveQueueToSlot(qIdx) {
    updateDB(d => {
        let empty = d.chargingSlots.findIndex(x => !x);
        if(empty === -1) throw "Slot Penuh!";
        let u = d.waitingQueue[qIdx];
        d.waitingQueue.splice(qIdx, 1);
        u.duration = (100 - u.startBattery) * 1.5;
        u.startTime = null;
        d.chargingSlots[empty] = u;
        return d;
    });
}
function deleteQueue(i) {
    if(!confirm("Hapus?")) return;
    updateDB(d => { d.waitingQueue.splice(i, 1); return d; });
}
function resetAll() {
    if(confirm("RESET TOTAL?")) db.collection("antrian").doc("utama").set({chargingSlots:[null,null,null], waitingQueue:[]});
}

function updateDB(callback) {
    const ref = db.collection("antrian").doc("utama");
    db.runTransaction(async t => {
        const doc = await t.get(ref);
        const newData = callback(doc.data());
        t.update(ref, newData);
    }).catch(e => showModal("Error", e));
}

// --- ALERT SYSTEM ---
function triggerFullAlert() {
    silentAudio.pause(); alarmAudio.volume=1.0; alarmAudio.play();
    document.getElementById('alarmScreen').style.display='flex';
    if(navigator.vibrate) navigator.vibrate([1000,500,1000]);
    if(Notification.permission==="granted") new Notification("SELESAI!", {body:"Motor Penuh!", tag:"alarm"});
}
function stopAlarm() {
    alarmAudio.pause(); alarmAudio.currentTime=0;
    document.getElementById('alarmScreen').style.display='none';
    silentAudio.play();
}
</script>
</body>
</html>
