<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MAKA Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* CSS SAMA SEPERTI SEBELUMNYA (PREMIUM GLASS) */
:root { --bg-base:#f0f4f8; --accent:#0ea5a6; --accent-2:#06b6d4; --text:#0f1724; --danger:#ef4444; --glass-bg:rgba(255,255,255,0.65); --glass-border:rgba(255,255,255,0.4); --glass-shadow:0 8px 32px 0 rgba(31,38,135,0.15); --backdrop-blur:blur(12px); --radius-lg:24px; --max-width:520px; }
body { margin:0; font-family:'Inter'; background:var(--bg-base); color:var(--text); min-height:100vh; position:relative; }
body::before { content:""; position:fixed; inset:0; background:url('1763947427555.jpg') center/cover; opacity:0.15; z-index:-1; pointer-events:none; }
.app-container { max-width:var(--max-width); margin:0 auto; padding:20px 20px 120px; }
.glass-card { background:var(--glass-bg); box-shadow:var(--glass-shadow); backdrop-filter:var(--backdrop-blur); -webkit-backdrop-filter:var(--backdrop-blur); border-radius:var(--radius-lg); border:1px solid var(--glass-border); }
.header { margin-bottom:24px; }
.profile-section { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
.profile-pic { width:55px; height:55px; background:linear-gradient(135deg,var(--accent),var(--accent-2)); border-radius:18px; display:flex; align-items:center; justify-content:center; color:white; font-family:'Syne'; font-size:1.5em; font-weight:800; }
.hero-tunggakan { background:linear-gradient(135deg,rgba(6,182,212,0.9),rgba(14,165,166,0.9)); padding:24px; display:flex; justify-content:space-between; align-items:center; color:white; border-radius:var(--radius-lg); position:relative; overflow:hidden; }
.hero-tunggakan span { font-family:'Syne'; font-size:1.6em; font-weight:800; display:block; }
.icon-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:16px; margin-top:20px; }
.icon-item { padding:18px 10px; text-align:center; display:flex; flex-direction:column; align-items:center; text-decoration:none; }
.icon-item span { font-size:28px; margin-bottom:10px; }
.icon-item p { font-size:0.75em; color:var(--text); font-weight:600; margin:0; }
.sos-card { background:rgba(255,245,245,0.7)!important; border:1px solid rgba(239,68,68,0.3)!important; }
footer.bottom-nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:calc(100% - 40px); max-width:480px; background:rgba(255,255,255,0.8); backdrop-filter:blur(16px); border-radius:999px; padding:12px 20px; display:flex; justify-content:space-around; z-index:999; }
.nav-item { display:flex; flex-direction:column; align-items:center; text-decoration:none; color:#64748b; font-size:11px; }
.nav-item.active { color:var(--accent); font-weight:700; }

/* MODAL SOS ALARM */
.sos-overlay { position:fixed; inset:0; background:rgba(239,68,68,0.9); z-index:9999; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; color:white; animation:pulseRed 1s infinite; }
@keyframes pulseRed { 0%{opacity:1} 50%{opacity:0.8} 100%{opacity:1} }
.sos-overlay h1 { font-family:'Syne'; font-size:3em; margin:0; }
.sos-btn-close { margin-top:30px; padding:15px 30px; background:white; color:red; border:none; border-radius:30px; font-weight:bold; font-size:1.2em; }
</style>
</head>
<body class="dashboard">

<div id="sosScreen" class="sos-overlay">
    <div style="font-size:80px;">üö®</div>
    <h1>DARURAT!</h1>
    <p id="sosMsg" style="font-size:1.2em; max-width:80%;">Ada user butuh bantuan!</p>
    <button class="sos-btn-close" onclick="closeSos()">SAYA MENGERTI</button>
</div>

<div class="app-container">
<header class="header">
  <div class="profile-section">
    <div style="display:flex; gap:16px; align-items:center;">
        <div class="profile-pic" id="user-avatar">U</div>
        <div>
            <h1 id="user-name-display" style="margin:0; font-family:'Syne'; font-size:1.2em;">Halo User</h1>
            <p id="user-plate-display" style="margin:4px 0 0; color:#64748b; font-size:0.9em;">...</p>
        </div>
    </div>
  </div>

  <div class="hero-tunggakan glass-card">
    <div>
      <h3 style="margin:0 0 6px; font-size:0.75em; opacity:0.9;">TAGIHAN BULAN INI</h3>
      <p style="margin:0; font-size:0.9em;">Total Yang Harus Dibayar</p>
    </div>
    <div style="text-align:right;">
      <span id="hero-tunggakan-nominal">Rp 0</span>
      <small id="hero-status-badge" style="background:white; color:var(--accent); padding:4px 10px; border-radius:20px; font-size:0.75em; font-weight:700;">Aman</small>
    </div>
  </div>
</header>

<section class="icon-grid-section">
  <h2 style="font-family:'Syne'; color:var(--text);">‚ú®MLU | Mau Ape Lu</h2>
  <div class="icon-grid">
    <a href="calendar.html" class="icon-item glass-card"><span>üìÖ</span><p>Bayar</p></a>
    <a href="history.html" class="icon-item glass-card"><span>üóíÔ∏è</span><p>Riwayat</p></a>
    <a href="part_tracker.html" class="icon-item glass-card"><span>üéÅ</span><p>Gratisan</p></a>
    <a href="info_mlu.html" class="icon-item glass-card"><span>üì∞</span><p>Info</p></a>
    <a href="tips_maka.html" class="icon-item glass-card"><span>üí°</span><p>Tips</p></a>
    <a href="#" onclick="window.open('https://etle-pmj.info','_blank')" class="icon-item glass-card"><span>üöì</span><p>ETLE</p></a>
    <a href="settings.html" class="icon-item glass-card"><span>‚öôÔ∏è</span><p>Setting</p></a>
    <a href="maka_plus.html" class="icon-item glass-card"><span>‚≠ê</span><p>MAKA+</p></a>
    
    <div class="icon-item glass-card sos-card" onclick="triggerSOS()">
        <span>üö®</span><p style="color:var(--danger);">SOS</p>
    </div>
  </div>
</section>
</div>

<footer class="bottom-nav">
  <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
  <a href="dashboard.html" class="nav-item active"><span>üè†</span>Home</a>
  <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = JSON.parse(localStorage.getItem('maka_user'));

document.addEventListener("DOMContentLoaded", function() {
    if(!currentUser) { window.location.href='index.html'; return; }

    // Render User Data
    document.getElementById('user-name-display').innerText = "Halo, " + currentUser.nama;
    document.getElementById('user-plate-display').innerText = currentUser.plat;
    document.getElementById('user-avatar').innerText = currentUser.nama.charAt(0).toUpperCase();

    // Request Izin Notifikasi
    if ("Notification" in window) Notification.requestPermission();

    calculateLocalBill();

    // 1. LISTEN NOTIFIKASI BROADCAST DARI ADMIN
    // Jika admin kirim pesan di admin_user.html
    const now = new Date();
    const oneMinAgo = new Date(now.getTime() - 60000).toISOString();

    db.collection('broadcasts')
      .where('timestamp', '>', firebase.firestore.Timestamp.now()) // Listen yg baru aja
      .onSnapshot((snapshot) => {
          snapshot.docChanges().forEach((change) => {
              if (change.type === "added") {
                  const data = change.doc.data();
                  // Tampilkan Notifikasi Sistem
                  if (Notification.permission === "granted") {
                      navigator.vibrate([200, 100, 200]);
                      new Notification(data.title, {
                          body: data.body,
                          icon: 'https://cdn-icons-png.flaticon.com/512/3602/3602145.png' // Icon Lonceng
                      });
                  } else {
                      alert("üîî " + data.title + "\n" + data.body);
                  }
              }
          });
      });

    // 2. LISTEN SOS (SAMA SEPERTI SEBELUMNYA)
    db.collection('sos_alerts')
      .where('timestamp', '>', oneMinAgo)
      .onSnapshot((snapshot) => {
          snapshot.docChanges().forEach((change) => {
              if (change.type === "added") {
                  const data = change.doc.data();
                  if (data.plat !== currentUser.plat) {
                      showSosScreen(data.plat, data.msg);
                  }
              }
          });
      });
});

function calculateLocalBill() {
    // HARGA DASAR SUDAH 70.000
    const today = new Date(); today.setHours(0,0,0,0);
    let bill = 70000; 
    
    // Cek Cicilan MAKA+
    const plusData = JSON.parse(localStorage.getItem('maka_plus_data'));
    if(plusData && plusData.active) {
        bill += 10000; // Jadi 80rb
    }
    document.getElementById('hero-tunggakan-nominal').innerText = "Rp " + bill.toLocaleString('id-ID');
}

// KIRIM SOS
function triggerSOS() {
    if(!confirm("‚ö†Ô∏è PANGGILAN DARURAT ‚ö†Ô∏è\n\nIni akan mengirim alarm ke SEMUA user yang sedang online. Lanjutkan?")) return;
    const msg = prompt("Tulis pesan singkat:", "Darurat!");
    if(!msg) return;

    db.collection('sos_alerts').add({
        plat: currentUser.plat, nama: currentUser.nama, msg: msg,
        timestamp: new Date().toISOString()
    }).then(() => { alert("SOS Terkirim!"); });
}

function showSosScreen(plat, msg) {
    document.getElementById('sosMsg').innerHTML = `User <b>${plat}</b> butuh bantuan:<br>"${msg}"`;
    document.getElementById('sosScreen').style.display = 'flex';
    if(navigator.vibrate) navigator.vibrate([1000, 500, 1000]);
}
function closeSos() { document.getElementById('sosScreen').style.display = 'none'; }
</script>
</body>
</html>
