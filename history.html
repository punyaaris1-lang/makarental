<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Riwayat Pembayaran</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=Syne:wght@700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* GLOBAL THEME */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --accent-2:#06b6d4; --text:#0f1724; 
    --danger:#ef4444; --success:#10b981; --muted:#64748b;
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body { 
    margin:0; font-family:'Inter', sans-serif; 
    background:var(--bg-base); color:var(--text); 
    min-height:100vh; position:relative; padding-bottom:100px;
}

/* BACKGROUND */
body::before {
    content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: url('1763947427555.jpg') center/cover no-repeat; 
    opacity: 0.15; z-index: -1; pointer-events: none;
}

.app-container { max-width:520px; margin:0 auto; padding:20px 20px 100px; }

/* HEADER */
.header { margin-bottom:25px; text-align: center; }
.header h1 { font-family:'Syne'; font-size:1.8em; font-weight:800; margin:0; color:var(--text); letter-spacing:-0.5px; }
.header p { color:var(--muted); margin-top:5px; font-weight: 600; }

/* RIWAYAT LIST */
.history-list { display: flex; flex-direction: column; gap: 15px; }
.history-item { 
    background: white; border-radius: 18px; padding: 15px; 
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    display: flex; justify-content: space-between; align-items: center;
    border-left: 5px solid var(--success);
}
.hi-info h4 { 
    margin: 0; font-size: 1em; font-weight: 800; color: var(--text);
    display: flex; align-items: center; gap: 8px;
}
.hi-info p { margin: 2px 0 0; font-size: 0.75em; color: var(--muted); font-weight: 600; }
.hi-amount { 
    font-size: 1.2em; font-weight: 900; color: var(--success);
    text-align: right;
}
.hi-amount.unpaid { color: var(--danger); }

/* STATUS BADGE */
.status-badge { 
    font-size: 0.7em; font-weight: 800; padding: 4px 8px; border-radius: 8px;
    background: #d1fae5; color: var(--success);
}
.status-badge.unpaid { background: #fee2e2; color: var(--danger); }

/* FOOTER NAV */
footer.bottom-nav {
    position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
    width: auto; min-width: 260px; 
    background: rgba(255, 255, 255, 0.95); 
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 50px; padding: 10px 30px; 
    display: flex; justify-content: space-between; align-items: center; gap: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.5); z-index: 999;
}
.nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #94a3b8; font-size: 9px; font-weight: 700; transition: 0.2s; }
.nav-item span { font-size: 22px; margin-bottom: 2px; }
.nav-item.active { color: var(--accent); }
</style>
</head>
<body>

<div class="app-container">
  <header class="header">
    <h1>Riwayat</h1>
    <p>Log pembayaran unit <span id="platDisplay">...</span></p>
  </header>

  <div class="history-list" id="historyList">
    <div style="text-align:center; padding:50px; color:#94a3b8;">Memuat riwayat pembayaran...</div>
  </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(err => console.log('PWA Error', err));
    });
  }
</script>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = JSON.parse(localStorage.getItem('maka_user'));

document.addEventListener('DOMContentLoaded', () => {
    if(!currentUser) { window.location.href='index.html'; return; }
    document.getElementById('platDisplay').innerText = currentUser.plat;
    loadPaymentHistory();
});

function loadPaymentHistory() {
    // Tarik data dari collection 'daily_payments'
    db.collection('daily_payments')
      .where('plat', '==', currentUser.plat)
      .orderBy('paidAt', 'desc') // Urutkan dari yang terbaru dibayar
      .limit(30)
      .onSnapshot(snap => {
          const container = document.getElementById('historyList');
          let html = '';
          
          if (snap.empty) {
              container.innerHTML = '<div style="text-align:center; padding:50px; color:#94a3b8;">Belum ada riwayat pembayaran yang tercatat.</div>';
              return;
          }

          snap.forEach(doc => {
              const d = doc.data();
              
              // Tanggal Tagihan/Sewa
              const dateSewa = new Date(d.date + 'T00:00:00'); // Convert date string to date object
              const dateSewaFmt = dateSewa.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'long' });

              // Tanggal Pembayaran (Paid At)
              const paidAt = d.paidAt.toDate(); // Mengambil timestamp dari server
              const paidAtFmt = paidAt.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }) + ' ' + paidAt.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

              const amountFmt = d.amount.toLocaleString('id-ID');
              
              const isPaid = true; // Di sini, semua data dari daily_payments dianggap LUNAS
              const statusClass = isPaid ? '' : 'unpaid';
              const statusText = isPaid ? 'Lunas' : 'Tunggakan';
              const borderStyle = isPaid ? 'border-left: 5px solid var(--success);' : 'border-left: 5px solid var(--danger);';

              html += `
              <div class="history-item" style="${borderStyle}">
                  <div class="hi-info">
                      <h4>Sewa Harian <span class="status-badge ${statusClass}">${statusText}</span></h4>
                      <p>Untuk Tgl Sewa: ${dateSewaFmt}</p>
                      <p>Dibayar: ${paidAtFmt}</p>
                  </div>
                  <div class="hi-amount ${statusClass}">
                      Rp ${amountFmt}
                  </div>
              </div>
              `;
          });

          container.innerHTML = html;
      });
}
</script>
</body>
</html>
