<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Riwayat Pembayaran</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* === MAKA MOTORS THEME === */
:root { 
    --maka-black: #0f1724; 
    --maka-white: #ffffff;
    --maka-teal: #0ea5a6;
    --bg-page: #f8fafc;
    --border-color: #e2e8f0;
}

body { 
    margin:0; font-family:'Inter', sans-serif; 
    background: var(--bg-page); color:#0f1724; 
    min-height:100vh; padding-bottom:100px;
}

.app-container { max-width:480px; margin:0 auto; padding:20px 24px; }

/* HEADER */
.header-simple {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 24px; padding-top: 10px;
}
.page-title {
    font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.5em;
    margin: 0; letter-spacing: -0.5px;
}
.plat-badge {
    font-size: 0.8em; font-weight: 700; background: #fff; padding: 6px 12px; 
    border-radius: 8px; border: 1px solid var(--border-color); color: var(--maka-black);
}

/* HISTORY LIST */
.history-list { display: flex; flex-direction: column; gap: 12px; }

.history-card { 
    background: var(--maka-white); border-radius: 16px; padding: 16px; 
    border: 1px solid var(--border-color);
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    transition: transform 0.2s;
}
.history-card:active { transform: scale(0.98); }

.hc-left h4 { 
    margin: 0; font-size: 0.95em; font-weight: 700; color: var(--maka-black);
    font-family: 'Syne'; margin-bottom: 4px;
}
.hc-left p { margin: 0; font-size: 0.75em; color: #64748b; font-weight: 500; }

.hc-right { text-align: right; }
.hc-amount { 
    font-size: 1em; font-weight: 800; color: var(--maka-black); 
    display: block; margin-bottom: 4px;
}
.status-pill { 
    display: inline-block; font-size: 0.65em; font-weight: 700; 
    padding: 3px 8px; border-radius: 6px;
    background: #dcfce7; color: #166534; /* Green Success */
}

/* EMPTY STATE */
.empty-state { text-align: center; padding: 40px 20px; color: #94a3b8; }
.empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

/* NAV */
footer.bottom-nav {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--maka-black); border-radius: 100px; padding: 12px 30px;
    display: flex; gap: 30px; box-shadow: 0 15px 40px rgba(0,0,0,0.25); z-index: 999;
}
.nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; font-size: 10px; font-weight: 600; }
.nav-item span { font-size: 20px; margin-bottom: 2px; }
.nav-item.active span { color: #fbbf24; }
</style>
</head>
<body>

<div class="app-container">
  <div class="header-simple">
    <h1 class="page-title">Riwayat</h1>
    <div class="plat-badge" id="platDisplay">...</div>
  </div>

  <div class="history-list" id="historyList">
    <div class="empty-state">
        <div class="spinner"></div>
        <p>Memuat data...</p>
    </div>
  </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<script>
// CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};

let db;
let currentUser = JSON.parse(localStorage.getItem('maka_user'));

function init() {
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch(e) { console.log(e); }

    if(!currentUser) { window.location.href='index.html'; return; }
    document.getElementById('platDisplay').innerText = currentUser.plat;
    loadHistory();
}

function loadHistory() {
    const container = document.getElementById('historyList');
    
    // FIX PENTING: Mengubah orderBy dari 'paidAt' ke 'date' 
    // agar tidak perlu composite index yang rumit di Firestore.
    db.collection('daily_payments')
      .where('plat', '==', currentUser.plat)
      .orderBy('date', 'desc') // Mengurutkan berdasarkan Tanggal Sewa (YYYY-MM-DD)
      .limit(50)
      .onSnapshot(snap => {
          if (snap.empty) {
              container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üßæ</div>
                    <p>Belum ada riwayat pembayaran.</p>
                </div>`;
              return;
          }

          let html = '';
          snap.forEach(doc => {
              const d = doc.data();
              
              // Format Tanggal Sewa (YYYY-MM-DD) -> Readable
              const dateSewa = new Date(d.date); 
              const dateSewaFmt = dateSewa.toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'long' });

              // Format Waktu Bayar (paidAt)
              let paidTime = '-';
              if (d.paidAt && d.paidAt.toDate) {
                  const pt = d.paidAt.toDate();
                  paidTime = pt.toLocaleDateString('id-ID', {day:'numeric', month:'short'}) + ' ‚Ä¢ ' + pt.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
              } else {
                  paidTime = "Data Lama";
              }

              const amount = parseInt(d.amount).toLocaleString('id-ID');

              html += `
              <div class="history-card">
                  <div class="hc-left">
                      <h4>Sewa: ${dateSewaFmt}</h4>
                      <p>Dibayar: ${paidTime}</p>
                  </div>
                  <div class="hc-right">
                      <span class="hc-amount">Rp ${amount}</span>
                      <span class="status-pill">LUNAS ‚úÖ</span>
                  </div>
              </div>
              `;
          });
          container.innerHTML = html;
      }, error => {
          console.error("Firestore Error:", error);
          container.innerHTML = `
              <div class="empty-state" style="color:#ef4444;">
                  <div class="empty-icon">‚ö†Ô∏è</div>
                  <p><b>Gagal memuat data.</b><br>
                  <small>${error.message}</small></p>
              </div>`;
      });
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
