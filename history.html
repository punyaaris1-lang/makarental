<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Riwayat - MAKA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
<style>
/* === MAKA MOTORS THEME === */
:root { 
    --maka-black: #0f1724; 
    --maka-teal: #0ea5a6;
    --bg-page: #f8fafc;
    --border-color: #e2e8f0;
}
body { 
    margin:0; font-family:'Inter', sans-serif; 
    background: var(--bg-page); color:#0f1724; 
    min-height:100vh; padding-bottom:120px;
}
.app-container { max-width:480px; margin:0 auto; padding:20px 24px; }

/* HEADER */
.header-simple {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 25px; padding-top: 10px;
}
.page-title {
    font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.6em;
    margin: 0; letter-spacing: -0.5px; color: var(--maka-black);
}
.plat-badge {
    font-size: 0.85em; font-weight: 700; background: #fff; padding: 8px 14px; 
    border-radius: 10px; border: 1px solid var(--border-color); color: var(--maka-black);
    font-family: 'Syne';
}

/* LIST */
.history-list { display: flex; flex-direction: column; gap: 12px; }

.history-card { 
    background: #ffffff; border-radius: 16px; padding: 18px; 
    border: 1px solid var(--border-color);
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 4px 10px rgba(0,0,0,0.02);
}
.hc-left h4 { 
    margin: 0 0 5px; font-size: 0.95em; font-weight: 700; color: var(--maka-black);
}
.hc-left p { margin: 0; font-size: 0.75em; color: #64748b; font-weight: 500; }

.hc-right { text-align: right; }
.hc-amount { 
    font-size: 1.1em; font-weight: 800; color: var(--maka-black); 
    display: block; margin-bottom: 5px; font-family: 'Syne';
}
.status-pill { 
    display: inline-block; font-size: 0.65em; font-weight: 800; 
    padding: 4px 10px; border-radius: 6px; letter-spacing: 0.5px;
    background: #dcfce7; color: #166534; /* Hijau */
}

/* EMPTY */
.empty-state { text-align: center; padding: 50px 20px; color: #94a3b8; }
.empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }

/* NAV */
footer.bottom-nav {
    position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
    background: var(--maka-black); border-radius: 100px; padding: 14px 35px;
    display: flex; gap: 40px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); z-index: 999;
}
.nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #64748b; font-size: 10px; font-weight: 700; }
.nav-item span { font-size: 22px; margin-bottom: 3px; }
.nav-item.active span { color: #fbbf24; }
</style>
</head>
<body>

<div class="app-container">
  <div class="header-simple">
    <h1 class="page-title">Riwayat</h1>
    <div class="plat-badge" id="platDisplay">...</div>
  </div>

  <div class="history-list" id="historyList">
    <div class="empty-state"><p>Memuat data...</p></div>
  </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};

let db;
let currentUser = JSON.parse(localStorage.getItem('maka_user'));

function init() {
    try {
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
    } catch(e) {}

    if(!currentUser) { window.location.href='index.html'; return; }
    document.getElementById('platDisplay').innerText = currentUser.plat;
    loadHistory();
}

function loadHistory() {
    const container = document.getElementById('historyList');
    
    // FIX: Hapus orderBy di query untuk hindari error index
    db.collection('daily_payments')
      .where('plat', '==', currentUser.plat)
      .limit(50) 
      .onSnapshot(snap => {
          if (snap.empty) {
              container.innerHTML = `<div class="empty-state"><div class="empty-icon">üßæ</div><p>Belum ada riwayat.</p></div>`;
              return;
          }

          let allData = [];
          snap.forEach(doc => allData.push(doc.data()));

          // FIX: Urutkan manual lewat Javascript (Terbaru di atas)
          allData.sort((a, b) => new Date(b.date) - new Date(a.date));

          let html = '';
          allData.forEach(d => {
              const dateSewa = new Date(d.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
              
              let paidTime = 'Manual';
              if (d.paidAt && d.paidAt.toDate) {
                  const pt = d.paidAt.toDate();
                  paidTime = pt.toLocaleDateString('id-ID', {day:'numeric', month:'short'}) + ', ' + pt.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'});
              }

              html += `
              <div class="history-card">
                  <div class="hc-left">
                      <h4>Sewa: ${dateSewa}</h4>
                      <p>Dibayar: ${paidTime}</p>
                  </div>
                  <div class="hc-right">
                      <span class="hc-amount">Rp ${parseInt(d.amount).toLocaleString('id-ID')}</span>
                      <span class="status-pill">LUNAS</span>
                  </div>
              </div>`;
          });
          container.innerHTML = html;
      });
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
