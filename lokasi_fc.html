<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>MAKA FastCharging</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

  <!-- LEAFLET CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <style>
    /*
      THEME: iPhone-like Clean (Light / Glass)
      This CSS replaces the original dark theme with a modern, soft, mobile-first light UI.
    */

    :root{
      --bg: #f6f8fb;
      --surface: #ffffff;
      --muted: #6b7280;
      --accent: #0ea5a6;       /* teal accent */
      --accent-2: #06b6d4;     /* secondary accent */
      --glass: rgba(255,255,255,0.7);
      --card-shadow: 0 8px 30px rgba(15,23,42,0.06);
      --text: #0f1724;
      --subtle: #eef2f7;
      --danger: #ef4444;
      --radius-lg: 20px;
      --radius-md: 14px;
      --nav-height: 74px;
      --max-width: 980px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html,body { height:100%; margin:0; padding:0; font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; color:var(--text); background: linear-gradient(180deg,var(--bg) 0%, #eef3f8 100%); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    /* Optional global background image class (not enabled by default)
       To use a background image with opacity, add class "bg-image" to <body> and uncomment the --bg-image url. */
    .bg-image {
      /* background-image: url('1763947427555.jpg'); */
      /* background-size: cover; background-position: center; */
      /* overlay for readability */
    }

    /* Main layout */
    .app {
      max-width: var(--max-width);
      margin: 0 auto;
      min-height: calc(100vh - var(--nav-height));
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
    }

    /* Header */
    .header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 12px 6px;
      border-radius: var(--radius-lg);
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.55));
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(8px);
    }
    .header-text { display:flex; flex-direction:column; gap:6px; max-width: 65%; }
    .label-top { font-size: 11px; color:var(--muted); letter-spacing:1px; font-weight:700; text-transform:uppercase; }
    .header h1 { margin:0; font-family:'Syne', sans-serif; font-size: clamp(20px, 7vw, 36px); line-height:1; color:var(--text); letter-spacing:-0.6px; }
    .label-bottom { font-size: 12px; color:var(--accent); font-weight:700; letter-spacing:0.8px; }

    /* Top controls (toggle map/list) */
    .top-controls { display:flex; gap:10px; align-items:center; }
    .toggle-mode { display:flex; border-radius:999px; padding:3px; background: linear-gradient(180deg,#fff,#fbfdff); border:1px solid rgba(15,23,42,0.04); box-shadow: 0 2px 8px rgba(15,23,42,0.04);}
    .t-btn {
      padding:8px 12px; font-size:13px; font-weight:800; color:var(--muted); border-radius:999px; cursor:pointer; background:transparent; border:none;
    }
    .t-btn.active { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color: #fff; box-shadow: 0 6px 18px rgba(6,182,212,0.12); }

    /* Containers */
    #view-list { display:flex; flex-direction:column; gap:12px; flex:1; overflow:hidden; }
    #view-map { display:none; flex:1; width:100%; height:100%; position:relative; border-radius:var(--radius-lg); overflow:hidden; }

    /* Hero */
    .hero-section { padding: 6px 0; }
    .hero-card {
      background: linear-gradient(180deg,#ffffff, #fbfdff);
      border-radius: 18px;
      padding: 18px;
      box-shadow: var(--card-shadow);
      border: 1px solid rgba(15,23,42,0.03);
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:140px;
    }
    .hero-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .radar-status { padding:6px 10px; background: rgba(14,165,166,0.08); color:var(--accent); border-radius:999px; font-weight:800; font-size:12px; }
    .gps-dot { width:10px; height:10px; background:var(--accent); border-radius:50%; box-shadow:0 6px 18px rgba(14,165,166,0.12); }
    .hero-dist { background: linear-gradient(90deg,#f8fafc,#e6fffb); color:var(--accent-2); padding:6px 10px; border-radius:10px; font-weight:800; font-family:'Syne'; border:1px solid rgba(14,165,166,0.08); }
    .hero-name { margin:0; font-size: clamp(18px, 6.5vw, 28px); font-weight:800; color:var(--text); }
    .hero-info { color:var(--muted); font-size:14px; padding-left:10px; border-left:3px solid rgba(14,165,166,0.12); line-height:1.4; }

    .btn-nav-hero { padding:12px; border-radius:12px; border:none; background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; font-weight:800; font-size:14px; cursor:pointer; }

    /* List */
    .list-section { flex:1; overflow-y:auto; padding-bottom: 90px; display:block; }
    .city-group { margin-bottom:22px; }
    .city-header { display:flex; align-items:center; gap:12px; padding:4px 2px; margin-bottom:12px; }
    .city-title { font-family:'Syne'; font-weight:700; font-size:13px; color:var(--text); text-transform:uppercase; letter-spacing:0.6px; }
    .city-line { flex:1; height:1px; background: linear-gradient(90deg, rgba(15,23,42,0.03), rgba(15,23,42,0.02)); }

    .h-scroll { display:flex; gap:12px; overflow-x:auto; padding:8px 2px; scroll-snap-type:x mandatory; }
    .h-scroll::-webkit-scrollbar { display:none; }

    .mini-card {
      min-width: 172px; width: 172px; height: 210px; border-radius:16px; padding:14px; display:flex; flex-direction:column; justify-content:space-between; background:var(--surface); box-shadow: var(--card-shadow); border:1px solid rgba(15,23,42,0.03);
      scroll-snap-align:start; cursor:pointer; transition: transform .15s ease, box-shadow .15s ease;
    }
    .mini-card:active { transform: translateY(2px); }
    .style-1 { background: linear-gradient(180deg,#ffffff,#fbfdff); color:var(--text); }
    .style-2 { background: linear-gradient(180deg,#f1fbfb,#e6fffb); color:#044f46; border: 1px solid rgba(4,79,70,0.06); }
    .style-3 { background: linear-gradient(180deg,#f8fbff,#eef6ff); color:#0b254f; border: 1px solid rgba(14,165,233,0.04); }
    .bg-bolt { position:absolute; right: -6px; bottom:-12px; font-size:4rem; opacity:0.06; transform: rotate(-15deg); pointer-events:none; color:var(--accent-2); }

    .mini-top h3 { margin:0; font-size:15px; font-weight:700; line-height:1.2; color:inherit; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .mini-info { font-size:12px; color:var(--muted); margin-top:8px; border-top:1px solid rgba(15,23,42,0.02); padding-top:8px; }
    .mini-dist { text-align:right; font-weight:800; color:var(--accent); font-size:13px; }

    /* Map Overlay (modal-like) */
    .map-overlay { position:fixed; inset:0; display:flex; flex-direction:column; transform: translateY(110%); transition: transform .36s cubic-bezier(.2,.9,.2,1); z-index:9999; }
    .map-overlay.active { transform: translateY(0%); }
    .map-container { flex:1; border-radius: 0 0 18px 18px; overflow:hidden; background: #eff7fb; }
    .map-controls { padding:18px; background: linear-gradient(180deg,#ffffff,#fbfdff); border-top:1px solid rgba(15,23,42,0.03); box-shadow: 0 -8px 30px rgba(15,23,42,0.04); }
    .map-title { margin:0; font-weight:800; font-size:18px; color:var(--text); }
    .map-subtitle { margin:6px 0 0 0; color:var(--muted); font-size:13px; padding-left:6px; border-left: 3px solid rgba(14,165,166,0.12); }

    .btn-gmaps-start { width:100%; padding:12px; border-radius:12px; border:none; background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:white; font-weight:800; font-size:14px; display:inline-flex; align-items:center; justify-content:center; gap:10px; text-decoration:none; }

    .btn-map-close { position:absolute; left:16px; top:14px; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.9); border:1px solid rgba(15,23,42,0.04); box-shadow: 0 6px 20px rgba(15,23,42,0.06); font-weight:700; cursor:pointer; z-index:10001; }

    /* bottom nav */
    footer.bottom-nav {
      position:fixed; left:50%; transform:translateX(-50%); bottom:12px; width:calc(100% - 36px); max-width:640px;
      background: rgba(255,255,255,0.92); border-radius:999px; padding:8px 12px; display:flex; gap:12px; justify-content:space-around; align-items:center; box-shadow: 0 10px 30px rgba(15,23,42,0.08);
      z-index: 999;
    }
    .nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; text-decoration:none; color:var(--muted); font-size:12px; gap:6px; padding:6px 10px; border-radius:10px; }
    .nav-item.active { color:var(--accent); font-weight:700; }

    /* Responsive tweaks */
    @media(min-width:900px){
      .app { padding: 28px; }
      .mini-card { min-width: 220px; height:240px; }
      .hero-card { min-height:220px; }
    }

    /* Hide leaflet attribution for cleaner UI (kept from original) */
    .leaflet-control-attribution { display:none !important; }
    .leaflet-routing-container { display:none !important; }
  </style>
</head>

<body class="">
  <div class="app">
    <!-- Header -->
    <div class="header" role="banner">
      <div class="header-text">
        <div class="label-top">LOKASI</div>
        <h1>FAST<br/>CHARGING</h1>
        <div class="label-bottom">MAKA LINTAS UTARA</div>
      </div>

      <div class="top-controls">
        <div class="toggle-mode" role="tablist" aria-label="Mode">
          <button id="btnList" class="t-btn active" onclick="switchView('list')" aria-pressed="true">LIST</button>
          <button id="btnMap" class="t-btn" onclick="switchView('map')" aria-pressed="false">PETA</button>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <main id="view-list" role="main">
      <section class="hero-section">
        <div id="heroContainer">
          <div id="scanState" class="hero-card" style="align-items:center; text-align:center;">
            <div class="gps-dot" style="width:22px; height:22px; margin-bottom:10px;"></div>
            <h2 style="opacity:0.7; font-size:1.1rem; margin:0;">Mencari Sinyal GPS...</h2>
            <p style="color:var(--muted); font-size:0.95rem; margin:6px 0 0 0;">Pastikan Lokasi/GPS HP Aktif</p>
          </div>

          <div id="foundState" class="hero-card" style="display:none;">
            <div class="hero-header">
              <div class="radar-status"><div class="gps-dot" style="width:10px;height:10px"></div> FC TERDEKAT</div>
              <div class="hero-dist" id="heroDist">-- KM</div>
            </div>
            <h2 class="hero-name" id="heroName">Nama Lokasi</h2>
            <div class="hero-info" id="heroInfo">Info Loading...</div>
            <button id="btnHeroNav" class="btn-nav-hero" onclick="openMapModal()">LIHAT DI PETA üìç</button>
          </div>
        </div>
      </section>

      <section class="list-section" id="mainListContainer" aria-live="polite"></section>
    </main>

    <!-- MAP VIEW (hidden by default) -->
    <div id="view-map">
      <div id="fullMap" style="width:100%;height:100%;"></div>
    </div>
  </div>

  <!-- Map overlay modal -->
  <div id="mapOverlay" class="map-overlay" aria-hidden="true">
    <button class="btn-map-close" onclick="closeMapModal()" aria-label="Close map overlay">‚úï</button>
    <div id="map" class="map-container" style="min-height:320px"></div>
    <div class="map-controls">
      <div>
        <h3 id="mapTitle" class="map-title">Nama Lokasi</h3>
        <p id="mapSub" class="map-subtitle">Jarak: -- KM</p>
      </div>
      <a href="#" id="btnGmaps" target="_blank" rel="noopener" class="btn-gmaps-start">MULAI JALAN (GOOGLE MAPS) ‚Üó</a>
    </div>
  </div>

  <!-- bottom nav -->
  <footer class="bottom-nav" role="navigation" aria-label="Main navigation">
    <a href="lokasi_fc.html" class="nav-item active" aria-current="page">‚ö°<span style="font-size:11px">Lokasi</span></a>
    <a href="dashboard.html" class="nav-item">üè†<span style="font-size:11px">Home</span></a>
    <a href="daftar_antrian.html" class="nav-item">üé´<span style="font-size:11px">Antrian</span></a>
  </footer>

  <!-- LEAFLET & ROUTING -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

  <!-- Original JS (kept, only minor adjustments may be needed) -->
  <script>
    // --- CONFIG API & DATABASE (Berita Dihapus) ---
    const JAWG_API = "l1PdBwk1arfZcY7wECff2jE2Ts7qpJyMqGGqHK8cjCxcLb6m0FPHm1sExB5NvLyA";
    const URL_LOKASI = "https://docs.google.com/spreadsheets/d/1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM/export?format=csv";

    let chargers = [];
    let userLat = null; let userLng = null;
    let map = null; let mapFull = null; let currentMapTarget = null;

    async function loadDataBackground() {
      try {
        const txtLoc = await fetch(URL_LOKASI).then(r=>r.text());
        chargers = txtLoc.split('\n').slice(1).map((r, i) => {
          const c = r.split(',');
          let latStr = c[4] ? c[4].replace(',', '.') : '';
          let lngStr = c[5] ? c[5].replace(',', '.') : '';
          let latVal = parseFloat(latStr);
          let lngVal = parseFloat(lngStr);
          if(c.length < 5 || isNaN(latVal) || isNaN(lngVal)) return null;
          return {
            id: i,
            name: c[0],
            city: c[1],
            type: c[2],
            status: c[3],
            lat: latVal,
            lng: lngVal,
            link: c[6] || '',
            nozzle: c[7] || '-',
            cost: c[8] || '-'
          };
        }).filter(i=>i);
        renderList();

        if (navigator.geolocation) {
          navigator.geolocation.watchPosition(
            (p) => {
              userLat = p.coords.latitude;
              userLng = p.coords.longitude;
              processData();
            },
            (err) => { processData(); },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
          );
        } else {
          processData();
        }
      } catch(e) { console.error('loadDataBackground error', e); }
    }

    function switchView(mode) {
      const listBtn = document.getElementById('btnList');
      const mapBtn = document.getElementById('btnMap');
      const listView = document.getElementById('view-list');
      const mapView = document.getElementById('view-map');

      if(mode === 'list') {
        listBtn.classList.add('active'); mapBtn.classList.remove('active');
        listView.style.display = 'flex'; mapView.style.display = 'none';
      } else {
        mapBtn.classList.add('active'); listBtn.classList.remove('active');
        listView.style.display = 'none'; mapView.style.display = 'block';
        initFullMap();
      }
    }

    function initFullMap() {
      if(!mapFull) {
        mapFull = L.map('fullMap', { zoomControl: false }).setView([-6.200000, 106.816666], 11);
        L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {}).addTo(mapFull);
      }
      setTimeout(() => { mapFull.invalidateSize(); }, 200);

      if(userLat) {
        const userIcon = L.divIcon({ className: 'gps-dot', iconSize: [15,15] });
        L.marker([userLat, userLng], { icon: userIcon }).addTo(mapFull);
        mapFull.setView([userLat, userLng], 12);
      }

      chargers.forEach(item => {
        L.marker([item.lat, item.lng]).addTo(mapFull)
         .bindPopup(`<b>${item.name}</b><br>${item.nozzle} Nozzle<br><a href="#" onclick="openMapModalFromCluster(${item.id})" style="color:${getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#06b6d4'}; font-weight:bold; margin-top:5px; display:block;">LIHAT DETAIL</a>`);
      });
    }

    function openMapModalFromCluster(id) {
      const item = chargers.find(c => c.id === id);
      if(item) openMapModal(item);
    }

    function openMapModal(item) {
      if (!item) item = currentMapTarget;
      currentMapTarget = item;

      document.getElementById('mapOverlay').classList.add('active');
      document.getElementById('mapTitle').innerText = item.name;
      document.getElementById('mapSub').innerText = `Jarak: ${item.dist ? item.dist.toFixed(1) : '--'} KM`;

      const realLink = (item.link && item.link.length > 10) ? item.link : `https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}`;
      document.getElementById('btnGmaps').href = realLink;

      setTimeout(() => {
        if(map) { map.remove(); map = null; }
        map = L.map('map', { zoomControl: false }).setView([item.lat, item.lng], 14);
        L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${JAWG_API}`, {}).addTo(map);

        if(userLat) {
          const userIcon = L.divIcon({ className: 'gps-dot', iconSize: [15,15] });
          L.marker([userLat, userLng], { icon: userIcon }).addTo(map).bindPopup("Lokasi Anda");

          L.Routing.control({
            waypoints: [
              L.latLng(userLat, userLng),
              L.latLng(item.lat, item.lng)
            ],
            lineOptions: { styles: [{color: '#06b6d4', opacity: 0.85, weight:5}] },
            createMarker: function() { return null; },
            addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false
          }).addTo(map);
        }

        L.marker([item.lat, item.lng]).addTo(map).bindPopup(item.name).openPopup();
      }, 300);
    }

    function closeMapModal() { document.getElementById('mapOverlay').classList.remove('active'); }

    function getDist(lat1, lon1, lat2, lon2) {
      const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return (R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))).toFixed(1);
    }

    function processData() {
      if(userLat) {
        chargers.forEach(c => c.dist = parseFloat(getDist(userLat, userLng, c.lat, c.lng)));
        chargers.sort((a,b) => { if(isNaN(a.dist)) return 1; if(isNaN(b.dist)) return -1; return a.dist-b.dist; });
      } else {
        chargers.sort((a,b) => a.city.localeCompare(b.city) || a.name.localeCompare(b.name));
      }

      if(chargers.length > 0) {
        const n = chargers[0];
        currentMapTarget = n;
        document.getElementById('scanState').style.display = 'none';
        document.getElementById('foundState').style.display = 'flex';
        document.getElementById('heroName').innerText = n.name;
        document.getElementById('heroDist').innerText = n.dist ? n.dist + ' KM' : 'N/A';
        document.getElementById('heroInfo').innerText = `${n.city} ‚Ä¢ ${n.type}\n${n.nozzle} Nozzle ‚Ä¢ ${n.cost}`;
        document.getElementById('btnHeroNav').onclick = function() { openMapModal(n); };
        renderList();
      }
    }

    function renderList() {
      const listCont = document.getElementById('mainListContainer');

      // preserve scroll position per city
      const scrollState = {};
      document.querySelectorAll('.city-group').forEach(group => {
        const title = group.querySelector('.city-title').innerText;
        scrollState[title] = group.querySelector('.h-scroll').scrollLeft;
      });

      listCont.innerHTML = '';
      const grouped = {};
      for(let i=0;i<chargers.length;i++){
        const item = chargers[i];
        const city = item.city || 'Lainnya';
        if(!grouped[city]) grouped[city] = [];
        grouped[city].push(item);
      }
      let colorIdx = 0;
      Object.keys(grouped).forEach(city => {
        let groupHTML = `<div class="city-group"><div class="city-header"><div class="city-title">${city}</div><div class="city-line"></div></div><div class="h-scroll">`;
        grouped[city].forEach(item => {
          let styleClass = `style-${(colorIdx % 3) + 1}`;
          colorIdx++;
          const itemJson = JSON.stringify(item).replace(/'/g,"\\'");
          groupHTML += `
            <div onclick='openMapModal(${itemJson})' class="mini-card ${styleClass}">
              <div class="bg-bolt">‚ö°</div>
              <div class="mini-top"><h3>${item.name}</h3><div class="mini-info">${item.type}<br>${item.nozzle} Nozzle ‚Ä¢ ${item.cost}</div></div>
              <div class="mini-bot"><div class="mini-dist">${item.dist ? item.dist.toFixed(1)+' KM' : ''}</div></div>
            </div>`;
        });
        groupHTML += `</div></div>`;
        listCont.innerHTML += groupHTML;
      });

      // restore scroll
      document.querySelectorAll('.city-group').forEach(group => {
        const title = group.querySelector('.city-title').innerText;
        if(scrollState[title]) group.querySelector('.h-scroll').scrollLeft = scrollState[title];
      });
    }

    // Entry
    document.addEventListener('DOMContentLoaded', loadDataBackground);
  </script>
</body>
</html>
