<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAKA - Lokasi FC</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --royal-blue: #0A2259;
            --electric-blue: #2D63ED;
            --bg-surface: #F8FAFC;
            --text-main: #1A1F36;
            --text-muted: #64748B;
            --white: #FFFFFF;
            --success: #10B981;
        }

        body { margin: 0; padding: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-surface); overflow: hidden; }

        /* --- MAP --- */
        #map { width: 100%; height: 100vh; z-index: 1; }

        /* --- LOADING --- */
        #loader {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 2000;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            gap: 15px; transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #E2E8F0;
            border-top-color: var(--royal-blue); border-radius: 50%;
            animation: spin 1s infinite linear;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- HEADER & SUGGESTION --- */
        .header-float {
            position: fixed; top: 20px; left: 0; width: 100%;
            padding: 0 20px; z-index: 1000; pointer-events: none;
            display: flex; flex-direction: column; gap: 10px;
        }

        .header-pill {
            pointer-events: auto;
            background: rgba(10, 34, 89, 0.9); backdrop-filter: blur(10px);
            color: white; padding: 10px 20px; border-radius: 50px;
            display: inline-flex; align-items: center; gap: 10px; align-self: flex-start;
            box-shadow: 0 10px 20px rgba(10, 34, 89, 0.2);
        }
        
        /* Kartu Suggest Terdekat */
        .nearest-card {
            pointer-events: auto;
            background: var(--white); padding: 15px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid #EFF2F5;
            display: none; align-items: center; justify-content: space-between;
            animation: slideDown 0.5s ease;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .nc-info { display: flex; flex-direction: column; }
        .nc-label { font-size: 10px; font-weight: 700; color: var(--success); text-transform: uppercase; margin-bottom: 2px; }
        .nc-title { font-family: 'Space Grotesk'; font-size: 16px; font-weight: 700; color: var(--text-main); }
        .nc-dist { font-size: 12px; color: var(--text-muted); font-weight: 600; }
        
        .btn-go {
            background: var(--electric-blue); color: white; border: none;
            width: 36px; height: 36px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 5px 15px rgba(45, 99, 237, 0.3);
        }

        /* --- USER MARKER ANIMATION (KEDIP-KEDIP) --- */
        .user-pin-marker { position: relative; display: flex; align-items: center; justify-content: center; }
        .user-dot {
            width: 16px; height: 16px; background: #2D63ED;
            border: 3px solid white; border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 2;
        }
        .user-pulse {
            position: absolute; width: 50px; height: 50px;
            background: rgba(45, 99, 237, 0.4); border-radius: 50%;
            animation: pulse-ring 2s infinite; z-index: 1;
        }
        @keyframes pulse-ring {
            0% { transform: scale(0.5); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        /* --- INFO CARD (BOTTOM SHEET) --- */
        .info-card {
            position: fixed; bottom: 100px; left: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-radius: 24px; padding: 25px; z-index: 1000;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.8);
            transform: translateY(150%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .info-card.active { transform: translateY(0); }

        .btn-nav-map {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            background: linear-gradient(135deg, var(--royal-blue) 0%, #15398F 100%);
            color: white; padding: 16px; border-radius: 16px;
            font-weight: 700; font-size: 14px; text-decoration: none;
            box-shadow: 0 8px 20px rgba(10, 34, 89, 0.25); margin-top: 15px;
        }

        /* --- DOCK NAV --- */
        .dock-container { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 1001; pointer-events: none; }
        .nav-pill { pointer-events: auto; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); padding: 12px 30px; border-radius: 100px; display: flex; gap: 35px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 20px 50px rgba(10, 34, 89, 0.15), 0 1px 0 rgba(255,255,255,0.5) inset; }
        .nav-tab { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: #94A3B8; transition: all 0.3s ease; position: relative; }
        .nav-tab.active { color: var(--royal-blue); transform: translateY(-3px); }
        .nav-tab.active::after { content: ''; position: absolute; bottom: -8px; width: 4px; height: 4px; background: var(--royal-blue); border-radius: 50%; }
        .nav-tab svg { width: 24px; height: 24px; fill: currentColor; margin-bottom: 4px; }
        .nav-tab span { font-size: 10px; font-weight: 700; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div style="font-weight:700; color:var(--royal-blue); font-size:12px; letter-spacing:1px; margin-top:10px;">MENCARI SATELIT...</div>
    </div>

    <div class="header-float">
        <div class="header-pill">
            <div style="width:8px; height:8px; background:#10B981; border-radius:50%;"></div>
            <span style="font-weight:700; font-size:12px; font-family:'Space Grotesk'">MAKA STATION MAP</span>
        </div>

        <div id="nearestCard" class="nearest-card" onclick="focusNearest()">
            <div class="nc-info">
                <div class="nc-label">REKOMENDASI TERDEKAT</div>
                <div class="nc-title" id="nrName">Station Name</div>
                <div class="nc-dist" id="nrDist">0.0 KM dari posisi Anda</div>
            </div>
            <button class="btn-go">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="white"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>
            </button>
        </div>
    </div>

    <div id="map"></div>

    <div id="infoCard" class="info-card">
        <div style="position:absolute; top:15px; right:15px; width:30px; height:30px; background:#F1F5F9; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;" onclick="closeCard()">Ã—</div>
        <div style="font-size:10px; font-weight:700; color:#64748B; letter-spacing:1px;">FAST CHARGING STATION</div>
        <h2 style="font-family:'Space Grotesk'; font-size:20px; font-weight:700; color:var(--royal-blue); margin:5px 0;" id="fcName">...</h2>
        <div style="font-size:13px; color:#64748B; line-height:1.5;" id="fcDesc">...</div>
        
        <a href="#" id="btnMaps" target="_blank" class="btn-nav-map">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>
            NAVIGASI GOOGLE MAPS
        </a>
    </div>

    <div class="dock-container">
        <nav class="nav-pill">
            <a href="dashboard.html" class="nav-tab"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></a>
            <a href="calendar.html" class="nav-tab"><svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg><span>Bayar</span></a>
            <a href="lokasi_fc.html" class="nav-tab active"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg><span>Lokasi</span></a>
            <a href="history.html" class="nav-tab"><svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 1 1 7 7 6.93 6.93 0 0 1-5-2.09l-1.41 1.41A8.92 8.92 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>History</span></a>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        // --- 1. SETUP MAP ---
        const map = L.map('map', {zoomControl: false}).setView([-6.2088, 106.8456], 11);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 19 }).addTo(map);

        // Icons
        const fcIcon = L.divIcon({
            className: 'custom-pin',
            html: `<svg width="40" height="40" viewBox="0 0 24 24" fill="#0A2259" style="filter: drop-shadow(0px 5px 8px rgba(0,0,0,0.3));"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/><circle cx="12" cy="9" r="2.5" fill="white"/></svg>`,
            iconSize: [40, 40], iconAnchor: [20, 40]
        });

        const userIcon = L.divIcon({
            className: 'user-pin-marker',
            html: `<div class="user-pulse"></div><div class="user-dot"></div>`,
            iconSize: [50, 50], iconAnchor: [25, 25]
        });

        // Data Storage
        let fcData = [];
        let userMarker = null;
        let routeLine = null;
        let nearestStation = null;

        // --- 2. LOAD DATA ---
        const SHEET_ID = '1kp7bHdgSTTNZF3uyd1ul-LnTZVjuLs1TVQnRxoViPfQ';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

        Papa.parse(CSV_URL, {
            download: true, header: true,
            complete: function(results) {
                document.getElementById('loader').style.display = 'none';
                
                results.data.forEach(row => {
                    let lat = parseFloat(row['Latitude'] || row['Lat'] || 0);
                    let lng = parseFloat(row['Longitude'] || row['Lng'] || 0);
                    
                    if (!lat || !lng) { // Fallback search
                        Object.values(row).forEach(val => {
                            if (val && typeof val==='string' && val.includes(',')) val=val.replace(',','.');
                            if (!isNaN(val) && val < -5 && val > -11) lat = parseFloat(val);
                            if (!isNaN(val) && val > 95 && val < 141) lng = parseFloat(val);
                        });
                    }

                    if (lat && lng) {
                        const name = row['Nama'] || row['Lokasi'] || "Station";
                        const desc = row['Alamat'] || "FC Point";
                        const fc = { name, desc, lat, lng };
                        fcData.push(fc);

                        const m = L.marker([lat, lng], {icon: fcIcon}).addTo(map);
                        m.on('click', () => { showInfoCard(fc); });
                    }
                });

                // Start GPS after data loaded
                initGPS();
            }
        });

        // --- 3. GPS LOGIC & NEAREST CALC ---
        function initGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (pos) => {
                        const { latitude, longitude } = pos.coords;
                        
                        // Update Marker User
                        if (!userMarker) {
                            userMarker = L.marker([latitude, longitude], {icon: userIcon}).addTo(map);
                            map.setView([latitude, longitude], 14);
                        } else {
                            userMarker.setLatLng([latitude, longitude]);
                        }

                        // Cari Terdekat
                        findNearest(latitude, longitude);
                    },
                    (err) => console.log("GPS Error", err),
                    { enableHighAccuracy: true, maximumAge: 10000 }
                );
            }
        }

        function findNearest(userLat, userLng) {
            let minKm = 99999;
            let nearest = null;

            fcData.forEach(fc => {
                const dist = getDistance(userLat, userLng, fc.lat, fc.lng);
                if (dist < minKm) {
                    minKm = dist;
                    nearest = fc;
                }
            });

            if (nearest && nearest !== nearestStation) {
                nearestStation = nearest;
                
                // Tampilkan Kartu Suggest
                const nc = document.getElementById('nearestCard');
                document.getElementById('nrName').innerText = nearest.name;
                document.getElementById('nrDist').innerText = `${minKm.toFixed(1)} KM dari posisi Anda`;
                nc.style.display = 'flex';

                // Gambar Garis Konektor (Putus-putus)
                if (routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline([[userLat, userLng], [nearest.lat, nearest.lng]], {
                    color: '#2D63ED', weight: 4, dashArray: '10, 10', opacity: 0.6
                }).addTo(map);
            }
        }

        // --- 4. INTERACTION ---
        function focusNearest() {
            if (nearestStation) {
                showInfoCard(nearestStation);
                map.flyTo([nearestStation.lat, nearestStation.lng], 16);
            }
        }

        function showInfoCard(fc) {
            const card = document.getElementById('infoCard');
            document.getElementById('fcName').innerText = fc.name;
            document.getElementById('fcDesc').innerText = fc.desc;
            document.getElementById('btnMaps').href = `https://www.google.com/maps/dir/?api=1&destination=$${fc.lat},${fc.lng}`;
            card.classList.add('active');
        }

        function closeCard() { document.getElementById('infoCard').classList.remove('active'); }

        // Haversine Distance
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI/180) * Math.cos(lat2 * Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
    </script>
</body>
</html>
