<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAKA - Trip Planner</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --royal-blue: #0A2259;
            --royal-dark: #051336;
            --electric-blue: #2D63ED;
            --bg-surface: #F8FAFC;
            --text-main: #1A1F36;
            --text-muted: #64748B;
            --white: #FFFFFF;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --border-thin: #E2E8F0;
        }

        body {
            margin: 0; background: var(--bg-surface);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: var(--text-main); padding-bottom: 120px;
        }

        /* --- HEADER --- */
        .premium-header {
            background: radial-gradient(circle at 100% 0%, #163680 0%, var(--royal-blue) 60%, var(--royal-dark) 100%);
            padding: 40px 25px 30px 25px;
            color: var(--white);
            border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px -10px rgba(10, 34, 89, 0.3);
            margin-bottom: 20px;
        }
        
        .header-top { display: flex; align-items: center; gap: 15px; margin-bottom: 5px; }
        .back-btn { color: white; text-decoration: none; font-size: 20px; }
        .header-title { font-family: 'Space Grotesk'; font-size: 22px; font-weight: 700; margin: 0; }
        .header-sub { font-size: 11px; opacity: 0.8; margin-left: 35px; }

        /* --- CONTENT WRAPPER --- */
        .content { padding: 0 20px; }

        /* --- INPUT GROUP --- */
        .input-box { position: relative; margin-bottom: 12px; }
        .input-icon { position: absolute; left: 16px; top: 16px; color: var(--text-muted); font-size: 14px; z-index: 2; }
        
        .form-control {
            width: 100%; padding: 16px 16px 16px 45px; border-radius: 16px;
            border: 1px solid var(--border-thin); background: var(--white);
            font-family: 'Plus Jakarta Sans'; font-size: 14px; font-weight: 600;
            color: var(--text-main); outline: none; transition: 0.3s;
            box-sizing: border-box;
        }
        .form-control:focus { border-color: var(--electric-blue); box-shadow: 0 0 0 3px rgba(45, 99, 237, 0.1); }
        .form-control::placeholder { color: #CBD5E1; font-weight: 500; }

        /* --- BUTTONS --- */
        .btn-add {
            background: #EFF6FF; color: var(--electric-blue); width: 100%; padding: 14px;
            border: 1px dashed var(--electric-blue); border-radius: 14px;
            cursor: pointer; font-weight: 700; font-size: 12px; margin-bottom: 20px;
            transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-add:active { background: #DBEAFE; transform: scale(0.98); }

        .btn-action {
            width: 100%; padding: 18px; border: none; border-radius: 18px;
            background: linear-gradient(135deg, var(--royal-blue) 0%, #15398F 100%);
            color: white; font-family: 'Space Grotesk'; font-size: 16px; font-weight: 700;
            cursor: pointer; box-shadow: 0 10px 20px rgba(10, 34, 89, 0.2);
            transition: 0.2s; margin-top: 10px;
        }
        .btn-action:active { transform: scale(0.97); }

        .remove-btn {
            position: absolute; right: 15px; top: 15px; background: none; border: none;
            color: var(--danger); font-size: 18px; cursor: pointer;
        }

        /* --- MAP --- */
        #map {
            height: 350px; width: 100%; border-radius: 24px; margin-top: 30px;
            border: 1px solid var(--border-thin); box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        /* --- RESULT CARD --- */
        .route-card {
            background: var(--white); border-radius: 20px; padding: 20px; margin-bottom: 20px;
            border: 1px solid var(--border-thin); box-shadow: 0 10px 25px -5px rgba(148, 163, 184, 0.1);
            position: relative; overflow: hidden;
        }
        .route-card.aman { border-left: 5px solid var(--success); }
        .route-card.nekat { border-left: 5px solid var(--warning); }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #F1F5F9; }
        
        .badge-type { padding: 6px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; color: white; text-transform: uppercase; letter-spacing: 0.5px; }
        .aman .badge-type { background: var(--success); }
        .nekat .badge-type { background: var(--warning); }

        .btn-swap {
            background: #F1F5F9; color: var(--text-muted); border: none; font-size: 10px;
            padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 700;
            display: flex; align-items: center; gap: 5px;
        }

        /* --- TIMELINE --- */
        .timeline { position: relative; padding-left: 25px; }
        .timeline::before { content: ''; position: absolute; left: 6px; top: 8px; bottom: 8px; width: 2px; background: #E2E8F0; }
        
        .t-item { position: relative; margin-bottom: 30px; }
        .t-item:last-child { margin-bottom: 0; }
        
        .t-dot {
            position: absolute; left: -25px; top: 2px; width: 14px; height: 14px;
            border-radius: 50%; background: white; border: 3px solid #CBD5E1;
            z-index: 2; box-shadow: 0 0 0 3px white;
        }
        
        .t-title { font-weight: 700; font-size: 13px; color: var(--text-main); }
        .t-desc { font-size: 11px; color: var(--text-muted); margin-top: 4px; font-weight: 500; }
        
        .dist-label {
            position: absolute; left: -65px; top: 25px; width: 50px; text-align: right;
            font-size: 9px; color: var(--text-muted); font-weight: 700; background: var(--white);
        }

        .detected-addr {
            display: inline-block; margin-top: 5px; font-size: 10px; color: var(--electric-blue);
            background: #EFF6FF; padding: 4px 8px; border-radius: 6px; font-weight: 600;
        }

        .gmaps-btn {
            display: block; text-align: center; background: var(--white);
            border: 1px solid var(--border-thin); color: var(--text-main);
            padding: 14px; border-radius: 14px; margin-top: 20px;
            text-decoration: none; font-weight: 700; font-size: 12px;
            transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.02);
        }
        .gmaps-btn:active { background: #F8FAFC; }

        /* --- LOADING OVERLAY --- */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 10000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(10px); color: white;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--electric-blue); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(10, 34, 89, 0.4); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .m-box { width: 85%; max-width: 350px; background: var(--white); border-radius: 24px; padding: 25px; max-height: 70vh; overflow-y: auto; }
        
        .alt-item {
            padding: 15px; border: 1px solid var(--border-thin); border-radius: 12px;
            margin-bottom: 10px; cursor: pointer; transition: 0.2s;
        }
        .alt-item:active { border-color: var(--electric-blue); background: #EFF6FF; }

        /* --- DOCK NAV --- */
        .dock-container { position: fixed; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: center; z-index: 100; pointer-events: none; }
        .nav-pill { pointer-events: auto; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); padding: 12px 30px; border-radius: 100px; display: flex; gap: 35px; border: 1px solid rgba(255, 255, 255, 0.5); box-shadow: 0 20px 50px rgba(10, 34, 89, 0.15), 0 1px 0 rgba(255,255,255,0.5) inset; }
        .nav-tab { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; color: #94A3B8; transition: all 0.3s ease; position: relative; }
        .nav-tab.active { color: var(--royal-blue); transform: translateY(-3px); }
        .nav-tab.active::after { content: ''; position: absolute; bottom: -8px; width: 4px; height: 4px; background: var(--royal-blue); border-radius: 50%; }
        .nav-tab svg { width: 24px; height: 24px; fill: currentColor; margin-bottom: 4px; }
        .nav-tab span { font-size: 10px; font-weight: 700; }

    </style>
</head>
<body>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <div style="font-family:'Space Grotesk'; font-weight:700; letter-spacing:2px;">CALCULATING ROUTE...</div>
    </div>

    <header class="premium-header">
        <div class="header-top">
            <a href="dashboard.html" class="back-btn">&#8592;</a>
            <h1 class="header-title">PLAN TRIP</h1>
        </div>
        <p class="header-sub">Estimasi Baterai & Rute Charging</p>
    </header>

    <div class="content">
        <div id="db-status" style="font-size:10px; color:var(--text-muted); font-weight:700; margin-bottom:15px; text-align:center;">
            ‚è≥ Syncing Database...
        </div>

        <div id="waypoints">
            <div class="input-box">
                <i class="fas fa-circle input-icon" style="color:var(--electric-blue)"></i>
                <input type="text" class="form-control loc-input" placeholder="Titik Awal (Start)">
            </div>
            <div class="input-box">
                <i class="fas fa-map-marker-alt input-icon" style="color:var(--danger)"></i>
                <input type="text" class="form-control loc-input" placeholder="Tujuan Akhir (Finish)">
            </div>
        </div>
        
        <button class="btn-add" onclick="addStop()">
            <i class="fas fa-plus"></i> Tambah Titik Singgah
        </button>

        <div class="input-box">
            <i class="fas fa-bolt input-icon" style="color:var(--warning)"></i>
            <input type="number" id="battery" class="form-control" value="20" placeholder="Baterai Awal (%)">
        </div>

        <button class="btn-action" onclick="calculateRoute()">ANALISA RUTE</button>

        <div id="result-area" style="margin-top:30px;"></div>
        <div id="map"></div>
    </div>

    <div id="modal-overlay" class="modal">
        <div class="m-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <span style="font-family:'Space Grotesk'; font-weight:700; color:var(--royal-blue);">Pilih Charger Lain</span>
                <span onclick="closeModal()" style="cursor:pointer; color:var(--text-muted);">‚úï</span>
            </div>
            <div id="modal-list"></div>
        </div>
    </div>

    <div class="dock-container">
        <nav class="nav-pill">
            <a href="dashboard.html" class="nav-tab"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span></a>
            <a href="calendar.html" class="nav-tab"><svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11z"/></svg><span>Bayar</span></a>
            <a href="plan_trip.html" class="nav-tab active"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg><span>Trip</span></a>
            <a href="history.html" class="nav-tab"><svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 0 0-9 9H1l3.89 3.89.07.14L9 12H6a7 7 0 1 1 7 7 6.93 6.93 0 0 1-5-2.09l-1.41 1.41A8.92 8.92 0 0 0 13 21a9 9 0 0 0 0-18zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>History</span></a>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        const map = L.map('map', {zoomControl: false}).setView([-6.2, 106.8], 10);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '' }).addTo(map);
        
        let fcLocations = [];
        let mapLayers = L.layerGroup().addTo(map);
        let currentData = { points: [], bat: 0, safeList: [], nekatList: [], nearDest: null };

        const SHEET_ID = '1EJOTMMfGpBMFPqR0LzbMbh7tZUcTCZld4x387OO9aJM';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=Sheet1`;

        window.onload = function() {
            Papa.parse(CSV_URL, {
                download: true, header: true,
                complete: function(res) {
                    res.data.forEach(row => {
                        const lat = parseFloat((row['lat']||'').replace(',', '.'));
                        const lng = parseFloat((row['lng']||'').replace(',', '.'));
                        if(!isNaN(lat)) fcLocations.push({
                            name: row['Nama'] || Object.values(row)[0],
                            lat: lat, lng: lng,
                            biaya: row['biaya'] || 'Berbayar'
                        });
                    });
                    document.getElementById('db-status').innerText = '‚úÖ Database Connected';
                    document.getElementById('db-status').style.color = 'var(--success)';
                }
            });
        };

        function addStop() {
            const div = document.createElement('div');
            div.className = 'input-box';
            div.innerHTML = `<i class="fas fa-stop-circle input-icon" style="color:var(--text-muted)"></i><input type="text" class="form-control loc-input" placeholder="Singgah"><button class="remove-btn" onclick="this.parentElement.remove()">√ó</button>`;
            document.getElementById('waypoints').insertBefore(div, document.getElementById('waypoints').lastElementChild);
        }

        async function calculateRoute() {
            const inputs = document.querySelectorAll('.loc-input');
            const batStart = parseInt(document.getElementById('battery').value);
            const resArea = document.getElementById('result-area');
            const loading = document.getElementById('loading-overlay');
            
            let inputTexts = [];
            inputs.forEach(i => { if(i.value.trim()) inputTexts.push(i.value.trim()); });
            if(inputTexts.length < 2) return alert("Masukkan minimal 2 lokasi!");

            loading.style.display = 'flex';
            mapLayers.clearLayers();
            resArea.innerHTML = '';

            try {
                let points = [];
                for(let txt of inputTexts) {
                    const c = await getGeo(txt);
                    if(!c) throw new Error(`‚ùå Lokasi "${txt}" tidak ditemukan.`);
                    points.push(c);
                }

                const directRoute = await getOSRM(points);
                const totalDist = directRoute.distance / 1000;
                const batNeeded = Math.ceil(totalDist);
                const sisaAkhir = batStart - batNeeded;
                const nearDest = await findNearestFC(points[points.length-1]);

                currentData = { points, bat: batStart, nearDest, safeList: [], nekatList: [] };

                if (sisaAkhir >= 20) {
                    const itinerary = await buildItinerary(points, batStart, null); 
                    resArea.innerHTML = renderCard('aman', '‚úÖ RUTE LANGSUNG AMAN', itinerary, nearDest, false);
                    drawRoute(points, '#10B981'); // Success color
                } 
                else {
                    const opts = await findChargerOptions(points, batStart);
                    currentData.safeList = opts.safeList;
                    currentData.nekatList = opts.nekatList;

                    if(opts.safeList.length > 0) {
                        const itinSafe = await buildItinerary(points, batStart, opts.safeList[0]);
                        resArea.innerHTML += `<div id="card-aman-cont">${renderCard('aman', 'üõ°Ô∏è OPSI 1: REKOMENDASI AMAN', itinSafe, nearDest, true)}</div>`;
                        drawComplexRoute(points, opts.safeList[0], '#10B981');
                    }

                    if(opts.nekatList.length > 0) {
                        let idx = 0;
                        if(opts.safeList.length > 0 && opts.nekatList[0].name === opts.safeList[0].name && opts.nekatList.length > 1) idx = 1;
                        const itinNekat = await buildItinerary(points, batStart, opts.nekatList[idx]);
                        resArea.innerHTML += `<div id="card-nekat-cont">${renderCard('nekat', 'üöÄ OPSI 2: LEBIH CEPAT', itinNekat, nearDest, true)}</div>`;
                    } else if (opts.safeList.length === 0) {
                        resArea.innerHTML = `<div style="padding:20px; text-align:center; color:var(--danger); border:1px solid var(--danger); border-radius:12px; background:#FEF2F2; font-weight:700;">‚ùå Tidak ada charger terjangkau!</div>`;
                    }
                }

            } catch (e) {
                alert(e.message);
            } finally {
                loading.style.display = 'none';
            }
        }

        async function buildItinerary(originalPoints, startBat, charger) {
            let path = [];
            if (charger) {
                const chargerPoint = { lat: charger.lat, lon: charger.lng, name: charger.name, isCharger: true };
                path = [originalPoints[0], chargerPoint, ...originalPoints.slice(1)];
            } else {
                path = [...originalPoints];
            }

            let timelineData = [];
            let currentBat = startBat;
            
            for (let i = 0; i < path.length; i++) {
                let distToNext = 0;
                if (i < path.length - 1) {
                    const leg = await getOSRM([path[i], path[i+1]]);
                    distToNext = leg.distance / 1000;
                }

                let pointData = {
                    name: path[i].name.split(',')[0],
                    fullName: path[i].name, 
                    isCharger: path[i].isCharger,
                    currentBat: currentBat,
                    distToNext: distToNext
                };

                if (path[i].isCharger) {
                    pointData.action = "Isi Full (100%)";
                    currentBat = 100; 
                }
                
                if (i < path.length - 1) {
                    currentBat = Math.floor(currentBat - Math.ceil(distToNext));
                }
                timelineData.push(pointData);
            }
            return { path, timelineData };
        }

        function renderCard(type, title, itineraryData, nearDest, showSwap) {
            const colorClass = type === 'aman' ? 'var(--success)' : 'var(--warning)';
            const swapHtml = showSwap ? `<button class="btn-swap" onclick="openModal('${type}')"><i class="fas fa-sync"></i> Ganti</button>` : '';
            
            let html = `
            <div class="route-card ${type}">
                <div class="card-header">
                    <div class="badge-type">${title}</div>
                    ${swapHtml}
                </div>
                <div class="timeline">`;

            itineraryData.timelineData.forEach((pt, index) => {
                const isLast = index === itineraryData.timelineData.length - 1;
                let dotColor = '#E2E8F0'; 
                if(index === 0) dotColor = 'var(--royal-blue)'; 
                if(pt.isCharger) dotColor = colorClass; 
                if(isLast) dotColor = 'var(--electric-blue)'; 

                let distHtml = '';
                if (!isLast) {
                    distHtml = `<div class="dist-label">‚¨á ${pt.distToNext.toFixed(1)} km</div>`;
                }

                let batColor = 'var(--success)';
                if(pt.currentBat < 20) batColor = 'var(--danger)';
                else if(pt.currentBat < 40) batColor = 'var(--warning)';

                let addrHtml = pt.isCharger ? '' : `<div class="detected-addr">üìç ${pt.fullName.substring(0, 30)}...</div>`;

                let content = `
                    <div class="t-title">${pt.name} ${pt.isCharger ? '‚ö°' : ''}</div>
                    ${addrHtml}
                    <div class="t-desc">${pt.isCharger ? '<b style="color:'+colorClass+'">ISI DAYA (100%)</b>' : 'Sisa Baterai: <b style="color:'+batColor+'">'+pt.currentBat+'%</b>'}</div>
                `;

                html += `
                <div class="t-item">
                    <div class="t-dot" style="background:${dotColor}; border-color:${dotColor}"></div>
                    ${distHtml}
                    <div class="t-content">${content}</div>
                </div>`;
            });

            let link = `https://www.google.com/maps/dir/`;
            itineraryData.path.forEach(p => link += `${p.lat},${p.lon}/`);

            html += `</div>
                <a href="${link}" target="_blank" class="gmaps-btn">üó∫Ô∏è BUKA GOOGLE MAPS</a>
            </div>`;

            return html;
        }

        async function drawComplexRoute(origPoints, charger, color) {
            const stopCoord = {lat: charger.lat, lon: charger.lng};
            const path = [origPoints[0], stopCoord, ...origPoints.slice(1)];
            const r = await getOSRM(path);
            const l = decodePolyline(r.geometry);
            L.polyline(l, {color: color, weight: 5}).addTo(mapLayers);
            
            path.forEach((p, idx) => {
                L.circleMarker([p.lat, p.lon], {radius: 5, color: '#0A2259', fillColor: 'white', fillOpacity: 1}).addTo(mapLayers);
            });
            L.marker([charger.lat, charger.lng]).addTo(mapLayers).bindPopup(charger.name).openPopup();
            map.fitBounds(L.latLngBounds(l), {padding:[40,40]});
        }

        function openModal(type) {
            const list = type === 'aman' ? currentData.safeList : currentData.nekatList;
            const div = document.getElementById('modal-list');
            div.innerHTML = '';
            list.forEach(opt => {
                div.innerHTML += `<div class="alt-item" onclick="selectAlt('${type}', '${opt.name}')">
                    <div style="font-weight:700; color:var(--royal-blue)">${opt.name}</div>
                    <div style="font-size:11px; color:var(--text-muted)">Jarak Lurus: ${opt.distFromStart.toFixed(1)} km | Detour: ${opt.detour.toFixed(1)} km</div>
                </div>`;
            });
            document.getElementById('modal-overlay').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
        
        async function selectAlt(type, name) {
            closeModal();
            const list = type === 'aman' ? currentData.safeList : currentData.nekatList;
            const selected = list.find(x => x.name === name);
            const container = type === 'aman' ? 'card-aman-cont' : 'card-nekat-cont';
            const title = type === 'aman' ? 'üõ°Ô∏è OPSI 1: REKOMENDASI AMAN' : 'üöÄ OPSI 2: LEBIH CEPAT';
            
            document.getElementById(container).style.opacity = '0.5';
            
            const itin = await buildItinerary(currentData.points, currentData.bat, selected);
            document.getElementById(container).innerHTML = renderCard(type, title, itin, currentData.nearDest, true);
            document.getElementById(container).style.opacity = '1';
            
            mapLayers.clearLayers();
            drawComplexRoute(currentData.points, selected, type==='aman'?'#10B981':'#F59E0B');
        }

        async function findChargerOptions(points, batStart) {
            const start = points[0]; const end = points[points.length-1];
            let safeList = [], nekatList = [];
            fcLocations.forEach(fc => {
                const d = getCrowDist(start.lat, start.lon, fc.lat, fc.lng);
                const dEnd = getCrowDist(fc.lat, fc.lng, end.lat, end.lon);
                const direct = getCrowDist(start.lat, start.lon, end.lat, end.lon);
                const detour = (d + dEnd) - direct;
                const data = { ...fc, distFromStart: d, detour: detour };
                if(d <= (batStart - 5)) safeList.push(data);
                if(d <= batStart) nekatList.push(data);
            });
            safeList.sort((a,b) => a.distFromStart - b.distFromStart);
            nekatList.sort((a,b) => a.detour - b.detour);
            return { safeList, nekatList };
        }

        async function getGeo(q) {
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q+" Indonesia")}&limit=1&addressdetails=1`);
            const d = await r.json();
            return d[0] ? {lat: parseFloat(d[0].lat), lon: parseFloat(d[0].lon), name: d[0].display_name} : null;
        }
        async function getOSRM(pts) {
            const s = pts.map(p => `${p.lon},${p.lat}`).join(';');
            const r = await fetch(`https://router.project-osrm.org/route/v1/driving/${s}?overview=full`);
            const d = await r.json();
            return d.routes[0];
        }
        async function findNearestFC(coord) {
            let sorted = fcLocations.map(fc => {
                return {...fc, dist: getCrowDist(coord.lat, coord.lon, fc.lat, fc.lng)};
            }).sort((a,b) => a.dist - b.dist);
            return sorted[0];
        }
        async function drawRoute(pts, color, dash=null) {
            const r = await getOSRM(pts);
            const l = decodePolyline(r.geometry);
            L.polyline(l, {color: color, weight: 5, dashArray: dash}).addTo(mapLayers);
            map.fitBounds(L.latLngBounds(l), {padding:[40,40]});
        }
        function getCrowDist(lat1, lon1, lat2, lon2) {
            const R = 6371; const p = Math.PI/180;
            const a = 0.5 - Math.cos((lat2-lat1)*p)/2 + Math.cos(lat1*p)*Math.cos(lat2*p)*(1-Math.cos((lon2-lon1)*p))/2;
            return 2 * R * Math.asin(Math.sqrt(a));
        }
        function decodePolyline(str) {
            let index=0,lat=0,lng=0,coordinates=[],shift=0,result=0,byte=null,latitude_change,longitude_change,factor=1e5;
            while(index<str.length){
                byte=null;shift=0;result=0;
                do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
                latitude_change=((result&1)?~(result>>1):(result>>1)); shift=result=0;
                do{byte=str.charCodeAt(index++)-63;result|=(byte&0x1f)<<shift;shift+=5;}while(byte>=0x20);
                longitude_change=((result&1)?~(result>>1):(result>>1));
                lat+=latitude_change;lng+=longitude_change;
                coordinates.push([lat/factor,lng/factor]);
            }
            return coordinates;
        }
    </script>
</body>
</html>
