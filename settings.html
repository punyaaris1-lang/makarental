<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pengaturan Akun</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&family=Syne:wght@700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* CSS SETTINGS (SAMA SEPERTI SEBELUMNYA) */
:root { --bg-base:#f0f4f8; --surface:#ffffff; --accent:#0ea5a6; --text:#0f1724; --radius-lg:24px; }
body { margin:0; padding:0; font-family:'Inter'; background:var(--bg-base); color:var(--text); }
.app-container { max-width:520px; margin:0 auto; padding:20px; }
.header { text-align:center; margin-bottom:20px; }
.profile-card { background:white; border-radius:var(--radius-lg); padding:20px; display:flex; align-items:center; gap:20px; box-shadow:0 8px 30px rgba(0,0,0,0.05); }
.avatar-box { position:relative; width:70px; height:70px; }
.avatar { width:100%; height:100%; border-radius:50%; object-fit:cover; background:#eee; display:flex; align-items:center; justify-content:center; font-size:1.5em; font-weight:800; color:#888; }
.btn-edit-pic { position:absolute; bottom:0; right:0; background:var(--text); color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; cursor:pointer; }
.profile-info h2 { margin:0; font-family:'Syne'; }
.settings-group { background:white; border-radius:var(--radius-lg); margin-top:20px; overflow:hidden; }
.settings-item { padding:15px 20px; border-bottom:1px solid #f1f5f9; display:flex; justify-content:space-between; align-items:center; }
footer.bottom-nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:calc(100% - 40px); max-width:480px; background:rgba(255,255,255,0.9); border-radius:999px; padding:12px; display:flex; justify-content:space-around; z-index:999; box-shadow:0 10px 40px rgba(0,0,0,0.1); }
.nav-item { text-decoration:none; color:#999; font-size:20px; } .nav-item.active{ color:var(--accent); }
</style>
</head>
<body>

<div class="app-container">
  <header class="header">
    <h1 style="font-family:'Syne';">Pengaturan</h1>
  </header>

  <div class="profile-card">
    <div class="avatar-box">
        <input type="file" id="fileInp" accept="image/*" style="display:none;" onchange="uploadPhoto()">
        
        <img id="imgAvatar" class="avatar" src="" style="display:none;">
        <div id="txtAvatar" class="avatar">U</div>
        
        <div class="btn-edit-pic" onclick="document.getElementById('fileInp').click()">‚úé</div>
    </div>
    <div class="profile-info">
      <h2 id="uName">Loading...</h2>
      <p id="uPlat" style="color:#666; margin:5px 0;">...</p>
    </div>
  </div>

  <div class="settings-group">
    <div class="settings-item"><span>Versi Aplikasi</span> <b>1.0.0 (Live)</b></div>
    <div class="settings-item" onclick="handleLogout()" style="color:red; font-weight:bold; cursor:pointer;">
        üö™ Keluar (Logout)
    </div>
  </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item">‚ö°</a>
    <a href="dashboard.html" class="nav-item">üè†</a>
    <a href="daftar_antrian.html" class="nav-item">üé´</a>
</footer>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const currentUser = JSON.parse(localStorage.getItem('maka_user'));

document.addEventListener('DOMContentLoaded', () => {
    if(currentUser) {
        document.getElementById('uName').innerText = currentUser.nama;
        document.getElementById('uPlat').innerText = currentUser.plat;
        loadCurrentPhoto();
    } else {
        window.location.href='index.html';
    }
});

function loadCurrentPhoto() {
    // Cek realtime dari firebase
    db.collection('users').doc(currentUser.plat).get().then(doc => {
        if(doc.exists && doc.data().photoUrl) {
            document.getElementById('imgAvatar').src = doc.data().photoUrl;
            document.getElementById('imgAvatar').style.display = 'block';
            document.getElementById('txtAvatar').style.display = 'none';
            
            // Update local storage biar dashboard cepet loadnya
            currentUser.photoUrl = doc.data().photoUrl;
            localStorage.setItem('maka_user', JSON.stringify(currentUser));
        } else {
            document.getElementById('txtAvatar').innerText = currentUser.nama.charAt(0).toUpperCase();
        }
    });
}

// LOGIC UPLOAD FOTO (RESIZE CLIENT SIDE)
function uploadPhoto() {
    const file = document.getElementById('fileInp').files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
            // Resize agar tidak berat di database (Max 150px)
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const MAX_SIZE = 150; 
            let w = img.width; let h = img.height;
            
            if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } } 
            else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
            
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            
            const base64 = canvas.toDataURL('image/jpeg', 0.7); // Kompres 70% quality
            
            // Simpan ke Firebase
            db.collection('users').doc(currentUser.plat).update({ photoUrl: base64 }).then(() => {
                alert("Foto Profil Diperbarui!");
                loadCurrentPhoto(); // Refresh tampilan
            });
        }
    }
    reader.readAsDataURL(file);
}

function handleLogout() {
    if(confirm("Logout?")) {
        localStorage.removeItem('maka_user');
        window.location.href='index.html';
    }
}
</script>
</body>
</html>
