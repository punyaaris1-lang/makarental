<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pengaturan - RTO MAKA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Syne:wght@700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* GLOBAL THEME */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --accent-2:#06b6d4; --text:#0f1724; 
    --danger:#ef4444; --success:#10b981; --muted:#64748b;
    --glass-bg:rgba(255,255,255,0.85); --glass-border:rgba(255,255,255,0.6); 
    --glass-shadow:0 8px 32px 0 rgba(31, 38, 135, 0.15); --backdrop-blur:blur(12px);
    --radius-lg:24px;
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body { 
    margin:0; padding:0; font-family:'Inter', sans-serif; 
    background:var(--bg-base); color:var(--text); 
    min-height:100vh; position:relative; overflow-x:hidden;
}

/* BACKGROUND IMAGE (Pastikan file jpg ada di folder) */
body::before {
    content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: url('1763947427555.jpg') center/cover no-repeat; 
    opacity: 0.15; z-index: -1; pointer-events: none;
}

.app-container { max-width:520px; margin:0 auto; padding:20px 20px 100px; }

/* HEADER */
.header { margin-bottom:25px; text-align: center; }
.header h1 { font-family:'Syne'; font-size:1.8em; font-weight:800; margin:0; color:var(--text); letter-spacing:-0.5px; }

/* PROFILE CARD */
.profile-card { 
    background:var(--glass-bg); backdrop-filter:var(--backdrop-blur);
    border:1px solid var(--glass-border); border-radius:var(--radius-lg); 
    padding:25px; display:flex; flex-direction:column; align-items:center; gap:15px; 
    box-shadow:var(--glass-shadow); margin-bottom: 25px; text-align: center;
}
.avatar-box { position:relative; width:90px; height:90px; }
.avatar { 
    width:100%; height:100%; border-radius:50%; object-fit:cover; 
    background:linear-gradient(135deg,var(--accent),var(--accent-2)); 
    display:flex; align-items:center; justify-content:center; 
    font-size:2.5em; font-weight:800; color:white; font-family: 'Syne';
    box-shadow: 0 5px 15px rgba(14,165,166,0.3); border: 3px solid white;
}
.btn-edit-pic { 
    position:absolute; bottom:0; right:0; 
    background:var(--text); color:white; width:30px; height:30px; 
    border-radius:50%; display:flex; align-items:center; justify-content:center; 
    font-size:14px; cursor:pointer; border: 2px solid white;
}
.profile-info h2 { margin:0; font-family:'Inter'; font-weight: 800; font-size: 1.3em; color:var(--text); }
.profile-info p { margin:5px 0 0; color:var(--muted); font-size: 0.9em; font-weight: 600; }

/* MENU LIST */
.menu-group { 
    background:white; border-radius:20px; 
    overflow:hidden; border:1px solid rgba(0,0,0,0.05); margin-bottom: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
}
.menu-item { 
    padding:18px 20px; border-bottom:1px solid #f1f5f9; 
    display:flex; justify-content:space-between; align-items:center; 
    font-size: 0.95em; font-weight: 600; color: #334155;
    transition: 0.2s; cursor: pointer;
}
.menu-item:last-child { border-bottom: none; }
.menu-item:active { background: #f8fafc; }
.menu-icon { margin-right: 12px; font-size: 1.1em; }
.menu-arrow { color: #cbd5e1; font-weight: 800; }

/* DATA ROW (READ ONLY) */
.data-row { 
    display: flex; justify-content: space-between; 
    font-size: 0.85em; color: var(--muted); margin-top: 4px;
}
.data-val { font-weight: 700; color: var(--text); }

/* SWITCH TOGGLE */
.switch { position: relative; display: inline-block; width: 40px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e2e8f0; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(18px); }

/* FOOTER NAV */
footer.bottom-nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:auto; min-width:280px; background:rgba(255,255,255,0.9); backdrop-filter:blur(20px); border-radius:999px; padding:12px 30px; display:flex; justify-content:space-between; align-items:center; gap:30px; box-shadow:0 10px 40px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.5); z-index:999; }
.nav-item { display:flex; flex-direction:column; align-items:center; text-decoration:none; color:#94a3b8; font-size:10px; font-weight:700; transition:0.2s; }
.nav-item span { font-size:20px; margin-bottom:2px; } .nav-item.active { color:var(--accent); }

/* CUSTOM MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:9999; display:none; align-items:center; justify-content:center; opacity:0; transition:opacity 0.3s; }
.modal-overlay.show { display:flex; opacity:1; }
.modal-box { background:white; padding:25px; border-radius:24px; width:85%; max-width:320px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); transform:scale(0.9); transition:0.3s; }
.modal-overlay.show .modal-box { transform:scale(1); }
.modal-icon { font-size:40px; margin-bottom:15px; display:block; }
.modal-title { font-family:'Inter'; font-size:1.3em; font-weight:800; margin:0 0 10px; color:var(--text); }
.modal-desc { font-size:0.9em; color:#64748b; line-height:1.5; margin-bottom:20px; }
.btn-modal { width:100%; padding:12px; border-radius:12px; border:none; font-weight:700; cursor:pointer; font-size:0.9em; background:var(--text); color:white; }
</style>
</head>
<body>

<div class="app-container">
  <header class="header">
    <h1>Pengaturan</h1>
  </header>

  <div class="profile-card">
    <div class="avatar-box">
        <input type="file" id="fileInp" accept="image/*" style="display:none;" onchange="uploadPhoto()">
        <img id="imgAvatar" class="avatar" src="" style="display:none;">
        <div id="txtAvatar" class="avatar">U</div>
        <div class="btn-edit-pic" onclick="document.getElementById('fileInp').click()">üì∑</div>
    </div>
    <div class="profile-info">
      <h2 id="uName">Loading...</h2>
      <p id="uPlat" style="background:rgba(0,0,0,0.05); padding:4px 10px; border-radius:8px; display:inline-block; margin-top:8px;">...</p>
    </div>
  </div>

  <div style="padding-left:15px; margin-bottom:8px; font-weight:800; font-size:0.8em; color:var(--muted);">INFORMASI AKUN</div>
  <div class="menu-group">
    <div class="menu-item" style="display:block;">
        <div class="data-row"><span>Nomor WhatsApp</span> <span class="data-val" id="dWa">-</span></div>
        <div class="data-row"><span>Tgl Bergabung</span> <span class="data-val" id="dJoin">-</span></div>
        <div class="data-row"><span>Status</span> <span class="data-val" style="color:var(--success);">Aktif</span></div>
    </div>
  </div>

  <div style="padding-left:15px; margin-bottom:8px; font-weight:800; font-size:0.8em; color:var(--muted);">PREFERENSI</div>
  <div class="menu-group">
    <div class="menu-item">
        <span>üîî Suara Notifikasi</span>
        <label class="switch"><input type="checkbox" checked><span class="slider"></span></label>
    </div>
    <div class="menu-item">
        <span>üì≥ Getaran Sistem</span>
        <label class="switch"><input type="checkbox" checked><span class="slider"></span></label>
    </div>
  </div>

  <div style="padding-left:15px; margin-bottom:8px; font-weight:800; font-size:0.8em; color:var(--muted);">PUSAT BANTUAN</div>
  <div class="menu-group">
    <div class="menu-item" onclick="chatAdmin()">
        <span>üí¨ Chat Admin / Mekanik</span>
        <span class="menu-arrow">‚Ä∫</span>
    </div>
    <div class="menu-item" onclick="window.location.href='tips_maka.html'">
        <span>üìñ Panduan Aplikasi</span>
        <span class="menu-arrow">‚Ä∫</span>
    </div>
  </div>

  <div class="menu-group" style="margin-top:30px; border:1px solid #fee2e2;">
    <div class="menu-item" onclick="handleLogout()" style="background:#fff1f2;">
        <span style="color:var(--danger); width:100%; text-align:center;">üö™ KELUAR (LOGOUT)</span>
    </div>
  </div>
  
  <p style="text-align:center; font-size:0.7em; color:#cbd5e1; margin-top:20px;">Versi 1.0.5 (PWA) ‚Ä¢ MAKA Rental</p>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <span id="mIcon" class="modal-icon">üîî</span>
        <h3 id="mTitle" class="modal-title">Judul</h3>
        <p id="mDesc" class="modal-desc">Isi...</p>
        <button class="btn-modal" onclick="closeModal()">OK</button>
    </div>
</div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
    });
  }
</script>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const currentUser = JSON.parse(localStorage.getItem('maka_user'));

document.addEventListener('DOMContentLoaded', () => {
    if(currentUser) {
        document.getElementById('uName').innerText = currentUser.nama;
        document.getElementById('uPlat').innerText = currentUser.plat;
        document.getElementById('dWa').innerText = currentUser.hp || "-";
        
        // Format Tanggal
        if(currentUser.joinedAt) {
            const d = new Date(currentUser.joinedAt);
            document.getElementById('dJoin').innerText = d.toLocaleDateString('id-ID');
        }
        
        loadCurrentPhoto();
    } else {
        window.location.href='index.html';
    }
});

function loadCurrentPhoto() {
    db.collection('users').doc(currentUser.plat).get().then(doc => {
        if(doc.exists && doc.data().photoUrl) {
            document.getElementById('imgAvatar').src = doc.data().photoUrl;
            document.getElementById('imgAvatar').style.display = 'block';
            document.getElementById('txtAvatar').style.display = 'none';
            // Update local
            currentUser.photoUrl = doc.data().photoUrl;
            localStorage.setItem('maka_user', JSON.stringify(currentUser));
        } else {
            document.getElementById('txtAvatar').innerText = currentUser.nama.charAt(0).toUpperCase();
        }
    });
}

function uploadPhoto() {
    const file = document.getElementById('fileInp').files[0];
    if(!file) return;

    // Show Loading
    showModal("Mengupload...", "Sedang mengompres & mengupload foto. Tunggu sebentar...", "‚è≥");

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
            // Resize (Max 250px biar enteng)
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const MAX_SIZE = 250; 
            let w = img.width; let h = img.height;
            
            if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } } 
            else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
            
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            
            // Kompres JPG 50%
            const base64 = canvas.toDataURL('image/jpeg', 0.5);
            
            // Simpan ke Firestore (Merge:True agar data lain aman)
            db.collection('users').doc(currentUser.plat).set({ photoUrl: base64 }, { merge: true })
            .then(() => {
                showModal("Berhasil", "Foto profil baru telah disimpan!", "‚úÖ");
                loadCurrentPhoto();
            })
            .catch(err => {
                showModal("Gagal", "Error: " + err.message, "‚ùå");
            });
        }
    }
    reader.readAsDataURL(file);
}

function chatAdmin() {
    // Ganti nomor WA Admin di sini
    window.open('https://wa.me/6281234567890?text=Halo%20Admin%20MAKA,%20saya%20butuh%20bantuan', '_blank');
}

function handleLogout() {
    // Custom Confirm Modal
    const modal = document.getElementById('customModal');
    document.getElementById('mTitle').innerText = "Keluar Akun?";
    document.getElementById('mDesc').innerText = "Anda harus login ulang nanti.";
    document.getElementById('mIcon').innerText = "üö™";
    
    // Ganti tombol jadi 2 (Batal / Ya)
    const btns = modal.querySelector('.modal-box');
    const oldBtn = btns.querySelector('.btn-modal');
    if(oldBtn) oldBtn.remove();
    
    // Cek jika tombol sudah ada (biar ga double)
    if(!document.getElementById('btnYes')) {
        btns.innerHTML += `
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="closeModal()" style="flex:1; padding:12px; border:none; background:#f1f5f9; color:#64748b; border-radius:12px; font-weight:bold;">Batal</button>
                <button id="btnYes" onclick="processLogout()" style="flex:1; padding:12px; border:none; background:var(--danger); color:white; border-radius:12px; font-weight:bold;">Ya, Keluar</button>
            </div>
        `;
    }
    modal.classList.add('show');
}

function processLogout() {
    localStorage.removeItem('maka_user');
    window.location.href='index.html';
}

function showModal(title, msg, icon="üîî") {
    // Reset isi modal standar
    const box = document.querySelector('.modal-box');
    box.innerHTML = `
        <span id="mIcon" class="modal-icon">${icon}</span>
        <h3 id="mTitle" class="modal-title">${title}</h3>
        <p id="mDesc" class="modal-desc">${msg}</p>
        <button class="btn-modal" onclick="closeModal()">OK</button>
    `;
    document.getElementById('customModal').classList.add('show');
}
function closeModal() { document.getElementById('customModal').classList.remove('show'); }
</script>
</body>
</html>
