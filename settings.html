<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pengaturan - RTO MAKA</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Syne:wght@700;800&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* GLOBAL THEME */
:root { 
    --bg-base:#f0f4f8; --accent:#0ea5a6; --accent-2:#06b6d4; --text:#0f1724; 
    --danger:#ef4444; --success:#10b981; --muted:#64748b;
    --glass-bg:rgba(255,255,255,0.75); --glass-border:rgba(255,255,255,0.6); 
    --glass-shadow:0 8px 32px 0 rgba(31, 38, 135, 0.15); --backdrop-blur:blur(12px);
    --radius-lg:24px;
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

body { 
    margin:0; padding:0; font-family:'Inter', sans-serif; 
    background:var(--bg-base); color:var(--text); 
    min-height:100vh; position:relative; overflow-x:hidden;
}

/* BACKGROUND IMAGE */
body::before {
    content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: url('1763947427555.jpg') center/cover no-repeat; 
    opacity: 0.15; z-index: -1; pointer-events: none;
}

.app-container { max-width:520px; margin:0 auto; padding:20px 20px 100px; }

/* HEADER */
.header { margin-bottom:20px; text-align: center; }
.header h1 { font-family:'Syne'; font-size:1.8em; font-weight:800; margin:0; color:var(--text); letter-spacing:-1px; }

/* PROFILE CARD */
.profile-card { 
    background:var(--glass-bg); backdrop-filter:var(--backdrop-blur);
    border:1px solid var(--glass-border); border-radius:var(--radius-lg); 
    padding:25px; display:flex; align-items:center; gap:20px; 
    box-shadow:var(--glass-shadow); margin-bottom: 25px;
}
.avatar-box { position:relative; width:80px; height:80px; flex-shrink: 0; }
.avatar { 
    width:100%; height:100%; border-radius:50%; object-fit:cover; 
    background:linear-gradient(135deg,var(--accent),var(--accent-2)); 
    display:flex; align-items:center; justify-content:center; 
    font-size:2em; font-weight:800; color:white; font-family: 'Syne';
    box-shadow: 0 5px 15px rgba(14,165,166,0.3);
}
.btn-edit-pic { 
    position:absolute; bottom:0; right:0; 
    background:var(--text); color:white; width:28px; height:28px; 
    border-radius:50%; display:flex; align-items:center; justify-content:center; 
    font-size:14px; cursor:pointer; border: 2px solid white;
}
.profile-info h2 { margin:0; font-family:'Inter'; font-weight: 800; font-size: 1.2em; line-height: 1.2; }
.profile-info p { margin:5px 0 0; color:var(--muted); font-size: 0.9em; font-weight: 600; }

/* SETTINGS GROUP */
.section-title { font-size: 0.8em; font-weight: 800; color: var(--muted); margin: 20px 0 10px; text-transform: uppercase; letter-spacing: 1px; padding-left: 10px; }

.settings-group { 
    background:rgba(255,255,255,0.8); border-radius:20px; 
    overflow:hidden; border:1px solid rgba(255,255,255,0.5);
}
.settings-item { 
    padding:16px 20px; border-bottom:1px solid rgba(0,0,0,0.05); 
    display:flex; justify-content:space-between; align-items:center; 
    font-size: 0.95em; font-weight: 600;
}
.settings-item:last-child { border-bottom: none; }
.settings-item:active { background: rgba(0,0,0,0.02); }

/* SWITCH TOGGLE */
.switch { position: relative; display: inline-block; width: 40px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: var(--accent); }
input:checked + .slider:before { transform: translateX(18px); }

/* FOOTER NAV */
footer.bottom-nav { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); width:auto; min-width:280px; background:rgba(255,255,255,0.9); backdrop-filter:blur(20px); border-radius:999px; padding:12px 30px; display:flex; justify-content:space-between; align-items:center; gap:30px; box-shadow:0 10px 40px rgba(0,0,0,0.1); border:1px solid rgba(255,255,255,0.5); z-index:999; }
.nav-item { display:flex; flex-direction:column; align-items:center; text-decoration:none; color:#94a3b8; font-size:10px; font-weight:700; transition:0.2s; }
.nav-item span { font-size:20px; margin-bottom:2px; } .nav-item.active { color:var(--accent); }

/* CUSTOM MODAL */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(8px); z-index:9999; display:none; align-items:center; justify-content:center; opacity:0; transition:opacity 0.3s; }
.modal-overlay.show { display:flex; opacity:1; }
.modal-box { background:white; padding:25px; border-radius:24px; width:85%; max-width:320px; text-align:center; box-shadow:0 20px 60px rgba(0,0,0,0.3); transform:scale(0.9); transition:0.3s; }
.modal-overlay.show .modal-box { transform:scale(1); }
.modal-icon { font-size:40px; margin-bottom:15px; display:block; }
.modal-title { font-family:'Inter'; font-size:1.3em; font-weight:800; margin:0 0 10px; color:var(--text); }
.modal-desc { font-size:0.9em; color:#64748b; line-height:1.5; margin-bottom:20px; }
.btn-modal { width:100%; padding:12px; border-radius:12px; border:none; font-weight:700; cursor:pointer; font-size:0.9em; background:var(--text); color:white; }
</style>
</head>
<body>

<div class="app-container">
  <header class="header">
    <h1>Pengaturan</h1>
  </header>

  <div class="profile-card">
    <div class="avatar-box">
        <input type="file" id="fileInp" accept="image/*" style="display:none;" onchange="uploadPhoto()">
        <img id="imgAvatar" class="avatar" src="" style="display:none;">
        <div id="txtAvatar" class="avatar">U</div>
        <div class="btn-edit-pic" onclick="document.getElementById('fileInp').click()">üì∑</div>
    </div>
    <div class="profile-info">
      <h2 id="uName">Loading...</h2>
      <p id="uPlat">...</p>
      <p style="font-size:0.75em; color:var(--accent); margin-top:4px;">‚óè Member Aktif</p>
    </div>
  </div>

  <div class="section-title">Preferensi Aplikasi</div>
  <div class="settings-group">
    <div class="settings-item">
        <span>Suara Alarm</span>
        <label class="switch"><input type="checkbox" checked disabled><span class="slider"></span></label>
    </div>
    <div class="settings-item">
        <span>Getaran (Vibration)</span>
        <label class="switch"><input type="checkbox" checked disabled><span class="slider"></span></label>
    </div>
  </div>

  <div class="section-title">Bantuan & Info</div>
  <div class="settings-group">
    <div class="settings-item" onclick="window.open('https://wa.me/6281234567890?text=Halo%20Admin%20MAKA,%20saya%20butuh%20bantuan', '_blank')">
        <span>üìû Hubungi Admin (WA)</span>
        <span style="font-size:1.2em;">‚Ä∫</span>
    </div>
    <div class="settings-item">
        <span>üìÑ Syarat & Ketentuan</span>
        <span style="font-size:1.2em;">‚Ä∫</span>
    </div>
    <div class="settings-item">
        <span>Versi Aplikasi</span>
        <b style="color:var(--accent);">1.0.2 (PWA)</b>
    </div>
  </div>

  <div class="section-title">Akun</div>
  <div class="settings-group">
    <div class="settings-item" onclick="handleLogout()" style="background:#fff1f2;">
        <span style="color:red; font-weight:800;">üö™ Keluar (Logout)</span>
    </div>
  </div>
</div>

<footer class="bottom-nav">
    <a href="lokasi_fc.html" class="nav-item"><span>‚ö°</span>Lokasi</a>
    <a href="dashboard.html" class="nav-item"><span>üè†</span>Home</a>
    <a href="daftar_antrian.html" class="nav-item"><span>üé´</span>Antrian</a>
</footer>

<div id="customModal" class="modal-overlay">
    <div class="modal-box">
        <span id="mIcon" class="modal-icon">üîî</span>
        <h3 id="mTitle" class="modal-title">Judul</h3>
        <p id="mDesc" class="modal-desc">Isi...</p>
        <button class="btn-modal" onclick="closeModal()">OK</button>
    </div>
</div>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('PWA OK'))
        .catch(err => console.log('PWA Fail', err));
    });
  }
</script>

<script>
// --- CONFIG FIREBASE (PASTE PUNYA ANDA) ---
const firebaseConfig = {
  apiKey: "AIzaSyAk3G5aQUBVe_g7_peVu1F6xllP_RejGq0",
  authDomain: "rtomaka-e67b5.firebaseapp.com",
  projectId: "rtomaka-e67b5",
  storageBucket: "rtomaka-e67b5.firebasestorage.app",
  messagingSenderId: "472036722228",
  appId: "1:472036722228:web:11d520f9204db317d02c61"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const currentUser = JSON.parse(localStorage.getItem('maka_user'));

document.addEventListener('DOMContentLoaded', () => {
    if(currentUser) {
        document.getElementById('uName').innerText = currentUser.nama;
        document.getElementById('uPlat').innerText = currentUser.plat;
        loadCurrentPhoto();
    } else {
        window.location.href='index.html';
    }
});

function loadCurrentPhoto() {
    db.collection('users').doc(currentUser.plat).get().then(doc => {
        if(doc.exists && doc.data().photoUrl) {
            document.getElementById('imgAvatar').src = doc.data().photoUrl;
            document.getElementById('imgAvatar').style.display = 'block';
            document.getElementById('txtAvatar').style.display = 'none';
            // Update local storage
            currentUser.photoUrl = doc.data().photoUrl;
            localStorage.setItem('maka_user', JSON.stringify(currentUser));
        } else {
            document.getElementById('txtAvatar').innerText = currentUser.nama.charAt(0).toUpperCase();
        }
    });
}

function uploadPhoto() {
    const file = document.getElementById('fileInp').files[0];
    if(!file) return;

    // Tampilkan Loading
    showModal("Mengupload...", "Mohon tunggu sebentar, sedang memproses gambar.", "‚è≥");

    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.src = e.target.result;
        img.onload = function() {
            // Resize Client Side (Agar ringan di database)
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const MAX_SIZE = 200; // Kompres ke 200px
            let w = img.width; let h = img.height;
            
            if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE / w; w = MAX_SIZE; } } 
            else { if (h > MAX_SIZE) { w *= MAX_SIZE / h; h = MAX_SIZE; } }
            
            canvas.width = w; canvas.height = h;
            ctx.drawImage(img, 0, 0, w, h);
            
            // Convert ke Base64 Low Quality
            const base64 = canvas.toDataURL('image/jpeg', 0.6);
            
            // Simpan ke Firebase
            db.collection('users').doc(currentUser.plat).update({ photoUrl: base64 })
            .then(() => {
                showModal("Berhasil", "Foto profil telah diperbarui!", "‚úÖ");
                loadCurrentPhoto();
            })
            .catch(err => {
                showModal("Gagal", "Error upload: " + err.message, "‚ùå");
            });
        }
    }
    reader.readAsDataURL(file);
}

function handleLogout() {
    if(confirm("Yakin ingin keluar akun?")) {
        localStorage.removeItem('maka_user');
        window.location.href='index.html';
    }
}

// MODAL HELPER
function showModal(title, msg, icon="üîî") {
    document.getElementById('mTitle').innerText = title;
    document.getElementById('mDesc').innerText = msg;
    document.getElementById('mIcon').innerText = icon;
    document.getElementById('customModal').classList.add('show');
}
function closeModal() { document.getElementById('customModal').classList.remove('show'); }
</script>
</body>
</html>
